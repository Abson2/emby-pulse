{% extends "layout.html" %}
{% block title %}å†…å®¹é£äº‘æ¦œ - EmbyPulse{% endblock %}
{% block head %}
<style>
    .hero-mask { background: linear-gradient(to bottom, transparent 0%, rgba(255,255,255,1) 90%); }
    @media (min-width: 768px) {
        .hero-mask { background: linear-gradient(to right, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.8) 40%, rgba(255,255,255,0) 100%); }
    }
</style>
{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto w-full px-4 md:px-8 py-6 md:py-8 relative pb-20">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-6 gap-4 relative z-30">
        <div>
            <h1 class="text-2xl font-black text-gray-900">å†…å®¹é£äº‘æ¦œ</h1>
            <p class="text-xs text-gray-500 mt-1">æœåŠ¡å™¨æœ€çƒ­æ’­</p>
        </div>
        <div class="flex items-center gap-3 w-full md:w-auto">
            <div class="relative z-40 flex-1 md:flex-none">
                <select id="user-select" onchange="changeUser()" class="w-full md:w-auto appearance-none bg-white border border-gray-300 text-gray-800 py-2 pl-4 pr-10 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 text-sm font-bold">
                    <option value="all">ğŸŒ å…¨æœæ•°æ®</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-600"><i class="fa-solid fa-chevron-down text-xs"></i></div>
            </div>
            <button onclick="refreshCurrent()" class="bg-white border border-gray-300 text-gray-600 w-10 h-10 rounded-lg shadow-sm flex items-center justify-center"><i class="fa-solid fa-rotate-right"></i></button>
        </div>
    </div>

    <div id="loading" class="text-center py-20 text-gray-400"><i class="fa-solid fa-circle-notch fa-spin text-3xl"></i><p class="mt-4 text-sm">åŠ è½½ä¸­...</p></div>

    <div id="content-area" class="hidden animate-fade-in">
        <div id="hero-section"></div>
        <h3 class="text-lg font-bold text-gray-900 mb-4 mt-8 flex items-center"><i class="fa-solid fa-fire text-red-500 mr-2"></i> çƒ­é—¨æ¦œå• Top 10</h3>
        <div id="list-section" class="grid grid-cols-1 gap-3"></div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    /* JS ä»£ç ä¿æŒä¸å˜ (å¤ç”¨ä¹‹å‰çš„é€»è¾‘) */
    let currentUser = 'all';
    async function init() { await loadUsers(); loadContent('all'); }
    async function loadUsers() {
        try {
            const res = await fetch('/api/users');
            const json = await res.json();
            const select = document.getElementById('user-select');
            select.innerHTML = '<option value="all">ğŸŒ å…¨æœæ•°æ®</option>';
            if(json.status === 'success') {
                json.data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.UserId;
                    option.innerText = `ğŸ‘¤ ${user.UserName}`;
                    select.appendChild(option);
                });
            }
        } catch (e) { console.error(e); }
    }
    function changeUser() { currentUser = document.getElementById('user-select').value; loadContent(currentUser); }
    function refreshCurrent() { loadContent(currentUser); }
    async function loadContent(userId) {
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('content-area').classList.add('hidden');
        try {
            const res = await fetch(`/api/stats/top_movies?user_id=${userId}`);
            const json = await res.json();
            if(json.status === 'success' && json.data.length > 0) {
                renderHero(json.data[0]);
                renderList(json.data.slice(1));
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content-area').classList.remove('hidden');
            } else {
                document.getElementById('loading').innerHTML = `<div class="py-10"><i class="fa-solid fa-ghost text-4xl text-gray-200 mb-4"></i><p>æ— è®°å½•</p></div>`;
            }
        } catch (e) { console.error(e); }
    }
    
    // æ¸²æŸ“ Hero: æ‰‹æœºç«¯æ ·å¼è°ƒæ•´
    function renderHero(item) {
        const imgUrl = `/api/proxy/image/${item.ItemId}/primary`;
        const bgUrl = `/api/proxy/image/${item.ItemId}/backdrop`;
        document.getElementById('hero-section').innerHTML = `
        <div class="relative w-full h-[28rem] md:h-80 rounded-2xl md:rounded-3xl overflow-hidden shadow-xl bg-gray-900 group">
            <div class="absolute inset-0 bg-cover bg-center opacity-60 transition duration-1000 group-hover:scale-105" style="background-image: url('${bgUrl}');"></div>
            <div class="absolute inset-0 hero-mask"></div>
            <div class="relative z-10 h-full flex flex-col md:flex-row items-center md:px-10 justify-end md:justify-start pb-8 md:pb-0">
                <div class="w-32 h-48 md:w-40 md:h-60 rounded-xl shadow-2xl overflow-hidden border-2 md:border-4 border-white transform rotate-3 transition group-hover:rotate-0 bg-gray-800 shrink-0 mb-4 md:mb-0">
                    <img src="${imgUrl}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/300x450?text=No+Img'">
                </div>
                <div class="px-6 md:ml-8 text-center md:text-left max-w-lg">
                    <div class="text-yellow-600 font-bold uppercase tracking-wider text-xs md:text-sm mb-1"><i class="fa-solid fa-crown"></i> æ’­æ”¾å† å†›</div>
                    <h2 class="text-2xl md:text-4xl font-black text-gray-900 leading-tight mb-3 line-clamp-2">${item.ItemName}</h2>
                    <div class="flex justify-center md:justify-start space-x-6 text-gray-700">
                        <div><span class="text-xl md:text-3xl font-bold block">${item.PlayCount}</span><span class="text-xs text-gray-500 uppercase">æ¬¡æ’­æ”¾</span></div>
                        <div><span class="text-xl md:text-3xl font-bold block">${Math.round(item.TotalTime/60)}</span><span class="text-xs text-gray-500 uppercase">åˆ†é’Ÿ</span></div>
                    </div>
                </div>
            </div>
        </div>`;
    }

    function renderList(items) {
        let html = '';
        items.forEach((item, index) => {
            const rank = index + 2;
            const imgUrl = `/api/proxy/image/${item.ItemId}/primary`;
            html += `
            <div class="bg-white rounded-xl p-3 shadow-sm border border-gray-100 flex items-center hover:shadow-md transition">
                <div class="w-8 text-center mr-3 text-xl font-black ${rank <= 3 ? 'text-amber-700' : 'text-gray-300'} italic">${rank}</div>
                <div class="w-10 h-14 rounded bg-gray-200 overflow-hidden shrink-0 mr-3 shadow-sm relative">
                     <img src="${imgUrl}" class="w-full h-full object-cover">
                </div>
                <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-bold text-gray-800 truncate">${item.ItemName}</h4>
                    <div class="text-xs text-gray-500 mt-0.5">æ’­æ”¾ ${item.PlayCount} æ¬¡</div>
                </div>
            </div>`;
        });
        document.getElementById('list-section').innerHTML = html;
    }
    init();
</script>
{% endblock %}
