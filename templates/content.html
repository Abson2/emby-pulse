{% extends "layout.html" %}
{% block title %}å†…å®¹é£äº‘æ¦œ - EmbyPulse{% endblock %}
{% block head %}
<style>
    .podium-card { transition: all 0.3s ease; }
    .podium-card:hover { transform: translateY(-5px); }
    
    /* é¢†å¥–å°è¾¹æ¡†å…‰æ•ˆ */
    .rank-1-border { border-color: #f59e0b; box-shadow: 0 10px 30px -10px rgba(245, 158, 11, 0.4); }
    .rank-2-border { border-color: #94a3b8; box-shadow: 0 10px 30px -10px rgba(148, 163, 184, 0.4); }
    .rank-3-border { border-color: #b45309; box-shadow: 0 10px 30px -10px rgba(180, 83, 9, 0.4); }
    
    .crown-icon { position: absolute; top: -24px; left: 50%; transform: translateX(-50%); font-size: 2.5rem; color: #f59e0b; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); z-index: 20; }
</style>
{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto w-full px-4 md:px-8 py-6 pb-24">
    
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <div class="text-center md:text-left">
            <h1 class="text-2xl font-black text-gray-900 dark:text-white">é£äº‘æ¦œ</h1>
            <p class="text-xs text-gray-500 mt-1">æœåŠ¡å™¨æœ€å—æ¬¢è¿çš„å†…å®¹</p>
        </div>
        
        <div class="flex flex-wrap justify-center items-center gap-2 bg-white dark:bg-gray-800 p-1.5 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
            <button onclick="setCategory('all')" class="cat-btn px-3 py-1.5 rounded-lg text-xs font-bold transition bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200" data-cat="all">å…¨éƒ¨</button>
            <button onclick="setCategory('Movie')" class="cat-btn px-3 py-1.5 rounded-lg text-xs font-bold transition text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-600" data-cat="Movie">ç”µå½±</button>
            <button onclick="setCategory('Episode')" class="cat-btn px-3 py-1.5 rounded-lg text-xs font-bold transition text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-600" data-cat="Episode">å‰§é›†</button>
            
            <div class="w-px h-5 bg-gray-200 dark:bg-gray-600 mx-1"></div>
            
            <select id="user-select" onchange="changeUser()" class="bg-transparent text-xs font-bold text-gray-600 dark:text-gray-300 focus:outline-none cursor-pointer max-w-[100px] truncate">
                <option value="all">ğŸŒ å…¨æœ</option>
            </select>
        </div>
    </div>

    <div id="loading" class="text-center py-20 text-gray-400">
        <i class="fa-solid fa-circle-notch fa-spin text-3xl"></i>
    </div>

    <div id="content-area" class="hidden animate-fade-in space-y-10">
        
        <div class="flex flex-col md:flex-row items-center md:items-end justify-center gap-6 md:gap-4 px-2" id="podium-section">
            </div>

        <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm overflow-hidden max-w-4xl mx-auto w-full">
            <div class="px-6 py-4 border-b border-gray-100 dark:border-gray-700 bg-gray-50/50 dark:bg-gray-700/50 flex justify-between items-center">
                <h3 class="font-bold text-gray-700 dark:text-gray-300 text-sm">å…¶ä½™ä¸Šæ¦œåå•</h3>
                <span class="text-xs text-gray-400">Top 4 - 20</span>
            </div>
            <div id="list-section" class="divide-y divide-gray-50 dark:divide-gray-700/50">
                </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    let state = { user: 'all', category: 'all', sortBy: 'count' };

    async function init() {
        await loadUsers();
        loadContent();
    }

    function setCategory(cat) {
        state.category = cat;
        document.querySelectorAll('.cat-btn').forEach(btn => {
            if(btn.dataset.cat === cat) {
                btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
                btn.classList.remove('text-gray-500', 'dark:text-gray-400');
            } else {
                btn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
                btn.classList.add('text-gray-500', 'dark:text-gray-400');
            }
        });
        loadContent();
    }

    async function loadUsers() {
        try {
            const res = await fetch('/api/users');
            const json = await res.json();
            const select = document.getElementById('user-select');
            if(json.status === 'success') {
                json.data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.UserId;
                    option.innerText = `ğŸ‘¤ ${user.UserName}`;
                    select.appendChild(option);
                });
            }
        } catch (e) { console.error(e); }
    }

    function changeUser() {
        state.user = document.getElementById('user-select').value;
        loadContent();
    }

    async function loadContent() {
        const loading = document.getElementById('loading');
        const content = document.getElementById('content-area');
        loading.classList.remove('hidden'); content.classList.add('hidden');

        try {
            const url = `/api/stats/top_movies?user_id=${state.user}&category=${state.category}&sort_by=${state.sortBy}`;
            const res = await fetch(url);
            const json = await res.json();
            
            if(json.status === 'success' && json.data.length > 0) {
                const list = json.data;
                const top3 = [];
                if(list[0]) top3.push({...list[0], rank: 1});
                if(list[1]) top3.push({...list[1], rank: 2});
                if(list[2]) top3.push({...list[2], rank: 3});
                const others = list.slice(3);

                renderPodium(top3);
                renderList(others);
                
                loading.classList.add('hidden'); content.classList.remove('hidden');
            } else {
                loading.innerHTML = `<div class="py-10"><i class="fa-solid fa-ghost text-4xl text-gray-200 dark:text-gray-700 mb-4"></i><p>æš‚æ— æ•°æ®</p></div>`;
            }
        } catch (e) { console.error(e); loading.innerText = "Error loading data"; }
    }

    function renderPodium(items) {
        const container = document.getElementById('podium-section');
        let html = '';
        
        items.forEach(item => {
            const imgUrl = `/api/proxy/image/${item.ItemId}/primary`;
            const isFirst = item.rank === 1;
            let heightClass = isFirst ? 'h-64 md:h-80 w-48 md:w-64' : 'h-48 md:h-60 w-36 md:w-48';
            let borderClass = `rank-${item.rank}-border`;
            let crownHtml = isFirst ? '<i class="fa-solid fa-crown crown-icon animate-bounce"></i>' : '';
            let rankBadgeColor = isFirst ? 'bg-yellow-500' : (item.rank === 2 ? 'bg-gray-400' : 'bg-amber-700');
            
            let orderClass = '';
            if (item.rank === 1) orderClass = 'order-1 md:order-2 z-10'; 
            if (item.rank === 2) orderClass = 'order-2 md:order-1';      
            if (item.rank === 3) orderClass = 'order-3 md:order-3';      

            html += `
            <div class="podium-card relative flex flex-col items-center group shrink-0 ${orderClass}">
                ${crownHtml}
                <div class="relative rounded-2xl overflow-hidden border-4 ${borderClass} ${heightClass} bg-gray-800 shadow-xl">
                    <img src="${imgUrl}" class="w-full h-full object-cover group-hover:scale-110 transition duration-700" onerror="this.src='https://via.placeholder.com/300x450/374151/9ca3af?text=No+Cover'">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent"></div>
                    <div class="absolute bottom-0 left-0 right-0 p-3 text-center">
                        <div class="inline-block ${rankBadgeColor} text-white text-[10px] font-bold px-2 py-0.5 rounded-full mb-1">#${item.rank}</div>
                        <h3 class="text-white font-bold text-sm md:text-lg line-clamp-1 leading-tight">${item.ItemName}</h3>
                        <p class="text-gray-300 text-xs mt-1 font-mono">${item.PlayCount} æ¬¡</p>
                    </div>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    }

    function renderList(items) {
        const container = document.getElementById('list-section');
        if(items.length === 0) { container.innerHTML = '<div class="p-8 text-center text-gray-400 text-sm">æš‚æ— æ›´å¤šæ’å</div>'; return; }

        let html = '';
        items.forEach((item, index) => {
            const rank = index + 4;
            const imgUrl = `/api/proxy/image/${item.ItemId}/primary`;
            
            html += `
            <div class="flex items-center p-3 md:p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition group">
                <div class="w-8 text-center font-bold text-gray-400 text-base md:text-lg mr-3 md:mr-4 italic">#${rank}</div>
                <div class="w-8 h-12 md:w-10 md:h-14 rounded bg-gray-200 dark:bg-gray-700 overflow-hidden shrink-0 mr-3 md:mr-4 shadow-sm relative">
                     <img src="${imgUrl}" class="w-full h-full object-cover group-hover:scale-105 transition" onerror="this.src='https://via.placeholder.com/100x150/e5e7eb/9ca3af?text=No'">
                </div>
                <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-bold text-gray-800 dark:text-gray-200 truncate group-hover:text-green-600 transition">${item.ItemName}</h4>
                    <div class="text-xs text-gray-500 mt-0.5 flex items-center gap-3">
                        <span><i class="fa-solid fa-play text-gray-300 dark:text-gray-600 mr-1"></i>${item.PlayCount}</span>
                        <span><i class="fa-regular fa-clock text-gray-300 dark:text-gray-600 mr-1"></i>${Math.round(item.TotalTime/60)}m</span>
                    </div>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    }

    init();
</script>
{% endblock %}