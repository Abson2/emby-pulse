{% extends "layout.html" %}

{% block title %}ä»ªè¡¨ç›˜ - EmbyPulse{% endblock %}

{% block content %}
<header class="h-16 bg-white/80 backdrop-blur-md border-b border-gray-200 flex items-center justify-between px-8 sticky top-0 z-10">
    <h2 class="text-lg font-bold text-gray-800">æœåŠ¡å™¨æ¦‚è§ˆ</h2>
    
    <div class="flex items-center gap-4">
        <div class="relative">
             <select id="dash-user-select" onchange="changeUser()" class="appearance-none bg-white border border-gray-300 text-gray-700 py-1.5 pl-3 pr-8 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 text-sm font-medium">
                <option value="all">ğŸŒ å…¨æœæ•°æ®</option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                <i class="fa-solid fa-chevron-down text-xs"></i>
            </div>
        </div>
        
        <div class="text-sm text-gray-500 font-mono" id="current-date">Loading...</div>
    </div>
</header>

<div class="p-8 space-y-8">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-gray-500 text-sm font-medium mb-1">æ€»æ’­æ”¾æ¬¡æ•°</p>
                    <h3 class="text-3xl font-bold text-gray-900" id="stat-plays">-</h3>
                </div>
                <div class="p-2 bg-green-50 rounded-lg text-green-600"><i class="fa-solid fa-play"></i></div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-gray-500 text-sm font-medium mb-1">æ´»è·ƒç”¨æˆ· (30å¤©)</p>
                    <h3 class="text-3xl font-bold text-gray-900" id="stat-users">-</h3>
                </div>
                <div class="p-2 bg-blue-50 rounded-lg text-blue-600"><i class="fa-solid fa-users"></i></div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-gray-500 text-sm font-medium mb-1">æ€»æ’­æ”¾æ—¶é•¿ (å°æ—¶)</p>
                    <h3 class="text-3xl font-bold text-gray-900" id="stat-duration">-</h3>
                </div>
                <div class="p-2 bg-purple-50 rounded-lg text-purple-600"><i class="fa-solid fa-clock"></i></div>
            </div>
        </div>
    </div>

    <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm">
        <h3 class="text-lg font-bold text-gray-800 mb-4">è¿‘7å¤©æµé‡è¶‹åŠ¿</h3>
        <div class="relative h-72 w-full">
            <canvas id="trendChart"></canvas>
        </div>
        <p class="text-xs text-gray-400 mt-2 text-center">* å›¾è¡¨æ•°æ®æš‚æœªå¯¹æ¥ç­›é€‰ï¼Œæ˜¾ç¤ºå…¨å±€è¶‹åŠ¿</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('current-date').innerText = new Date().toLocaleDateString();

    // åˆå§‹åŒ–
    async function init() {
        await loadUsers(); // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        fetchDashboardData('all'); // åŠ è½½åˆå§‹æ•°æ®
        initChart(); // åŠ è½½å›¾è¡¨
    }

    // 1. åŠ è½½ç”¨æˆ·åˆ—è¡¨ (å¤ç”¨é€»è¾‘)
    async function loadUsers() {
        try {
            const res = await fetch('/api/users');
            const json = await res.json();
            const select = document.getElementById('dash-user-select');
            if(json.status === 'success') {
                json.data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.UserId;
                    option.innerText = `ğŸ‘¤ ${user.UserName}`;
                    select.appendChild(option);
                });
            }
        } catch (e) { console.error(e); }
    }

    // 2. åˆ‡æ¢ç”¨æˆ·è§¦å‘
    function changeUser() {
        const userId = document.getElementById('dash-user-select').value;
        fetchDashboardData(userId);
    }

    // 3. è·å–å¹¶æ›´æ–°æ•°æ®
    async function fetchDashboardData(userId) {
        // ç»™å¡ç‰‡åŠ ä¸ªç®€å•çš„ loading æ€
        document.getElementById('stat-plays').innerText = '...';
        document.getElementById('stat-duration').innerText = '...';
        
        try {
            const response = await fetch(`/api/stats/dashboard?user_id=${userId}`);
            const res = await response.json();
            
            if(res.status === 'success') {
                const data = res.data;
                // æ›´æ–°æ•°å­—
                animateValue('stat-plays', data.total_plays || 0);
                document.getElementById('stat-users').innerText = data.active_users || 0;
                
                const hours = Math.round((data.total_duration || 0) / 3600);
                animateValue('stat-duration', hours);
            }
        } catch (error) {
            console.error("Network Error:", error);
        }
    }

    // æ•°å­—æ»šåŠ¨åŠ¨ç”»æ•ˆæœ
    function animateValue(id, end) {
        const obj = document.getElementById(id);
        obj.innerText = end; 
    }

    // 4. åˆå§‹åŒ–å›¾è¡¨ (æš‚æ—¶ä¿æŒå…¨æœæ•°æ®ï¼Œå› åç«¯æœªæä¾›æŒ‰æ—¥è¿‡æ»¤æ¥å£)
    function initChart() {
        const ctx = document.getElementById('trendChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'],
                datasets: [{
                    label: 'å…¨æœçƒ­åº¦',
                    data: [12, 19, 3, 5, 2, 30, 45], // æ¨¡æ‹Ÿæ•°æ®
                    borderColor: '#52b54b',
                    backgroundColor: 'rgba(82, 181, 75, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    init();
</script>
{% endblock %}
