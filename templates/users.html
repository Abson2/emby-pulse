{% extends "layout.html" %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
        <h1 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center gap-3">
            <i class="fa-solid fa-users text-indigo-500"></i>
            用户管理
        </h1>
        <div class="flex gap-2">
            <button onclick="openInviteModal()" class="flex items-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg transition shadow-sm font-medium">
                <i class="fa-solid fa-link"></i> 邀请链接
            </button>
            <button onclick="openNewUserModal()" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition shadow-sm font-medium">
                <i class="fa-solid fa-user-plus"></i> 新建用户
            </button>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-gray-600 dark:text-gray-300">
                <thead class="bg-gray-50 dark:bg-gray-700/50 text-gray-900 dark:text-gray-100 font-medium border-b border-gray-100 dark:border-gray-700">
                    <tr>
                        <th class="px-6 py-4">用户</th>
                        <th class="px-6 py-4">状态</th>
                        <th class="px-6 py-4">有效期至</th>
                        <th class="px-6 py-4">最后登录</th>
                        <th class="px-6 py-4 text-right">操作</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700" id="user-list-body">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div id="new-user-modal" class="fixed inset-0 z-50 hidden items-center justify-center h-screen w-screen bg-black/50 backdrop-blur-sm px-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">新建用户</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">用户名</label>
                <input type="text" id="new-username" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">有效期 (留空为永久)</label>
                <input type="date" id="new-expire" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
            <div class="bg-yellow-50 dark:bg-yellow-900/20 p-3 rounded-lg text-xs text-yellow-700 dark:text-yellow-400">
                ⚠️ 注意：Emby 接口限制，新建用户密码默认为空。请创建后通知用户登录并修改密码。
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeNewUserModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">取消</button>
                <button onclick="submitNewUser()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg">创建</button>
            </div>
        </div>
    </div>
</div>

<div id="invite-modal" class="fixed inset-0 z-50 hidden items-center justify-center h-screen w-screen bg-black/50 backdrop-blur-sm px-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">生成邀请链接</h3>
        
        <div class="space-y-4" id="invite-form-step">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">账号有效期 (到期自动禁用)</label>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="selectDuration(1)" class="dur-btn px-3 py-2 border rounded-lg text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/30 border-gray-200 dark:border-gray-600">1 天</button>
                    <button onclick="selectDuration(7)" class="dur-btn px-3 py-2 border rounded-lg text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/30 border-gray-200 dark:border-gray-600">7 天</button>
                    <button onclick="selectDuration(30)" class="dur-btn px-3 py-2 border rounded-lg text-sm bg-indigo-50 border-indigo-500 text-indigo-600 dark:bg-indigo-900/50 dark:text-indigo-300">30 天</button>
                    <button onclick="selectDuration(90)" class="dur-btn px-3 py-2 border rounded-lg text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/30 border-gray-200 dark:border-gray-600">3 个月</button>
                    <button onclick="selectDuration(180)" class="dur-btn px-3 py-2 border rounded-lg text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/30 border-gray-200 dark:border-gray-600">6 个月</button>
                    <button onclick="selectDuration(365)" class="dur-btn px-3 py-2 border rounded-lg text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/30 border-gray-200 dark:border-gray-600">12 个月</button>
                    <button onclick="selectDuration(-1)" class="dur-btn px-3 py-2 border rounded-lg text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/30 border-gray-200 dark:border-gray-600 col-span-3">永久有效</button>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeInviteModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">取消</button>
                <button onclick="generateInvite()" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg">生成链接</button>
            </div>
        </div>

        <div id="invite-result-step" class="hidden text-center space-y-4">
            <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-full inline-flex items-center justify-center mb-2">
                <i class="fa-solid fa-check text-3xl text-green-500"></i>
            </div>
            <h4 class="text-lg font-bold text-gray-900 dark:text-white">链接已生成</h4>
            <p class="text-sm text-gray-500 dark:text-gray-400">将下方链接发送给好友，即可邀请注册。</p>
            
            <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg break-all font-mono text-sm text-gray-600 dark:text-gray-300 select-all border border-gray-100 dark:border-gray-700" id="invite-link-box">
                ...
            </div>
            <div class="flex justify-center gap-3 mt-6">
                <button onclick="closeInviteModal()" class="px-6 py-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">完成</button>
                <button onclick="copyInvite()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg flex items-center gap-2">
                    <i class="fa-regular fa-copy"></i> 复制链接
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let users = [];
let selectedDuration = 30; // 默认选中30天

document.addEventListener('DOMContentLoaded', loadUsers);

async function loadUsers() {
    const res = await fetch('/api/manage/users');
    const json = await res.json();
    if (json.status === 'success') {
        users = json.data;
        renderUsers();
    }
}

function renderUsers() {
    const tbody = document.getElementById('user-list-body');
    tbody.innerHTML = users.map(u => `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/30 transition-colors">
            <td class="px-6 py-4">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center text-indigo-600 dark:text-indigo-300 font-bold">
                        ${u.Name[0].toUpperCase()}
                    </div>
                    <div>
                        <div class="font-medium text-gray-900 dark:text-white">${u.Name}</div>
                        ${u.IsAdmin ? '<span class="text-[10px] bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded">管理员</span>' : ''}
                    </div>
                </div>
            </td>
            <td class="px-6 py-4">
                ${u.IsDisabled 
                    ? '<span class="px-2 py-1 rounded-full text-xs bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400">已禁用</span>' 
                    : '<span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">正常</span>'}
            </td>
            <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
                ${u.ExpireDate || '永久'}
            </td>
            <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
                ${u.LastLoginDate ? new Date(u.LastLoginDate).toLocaleDateString() : '从未'}
            </td>
            <td class="px-6 py-4 text-right">
                <button onclick="deleteUser('${u.Id}')" class="text-red-500 hover:text-red-700 text-sm">删除</button>
            </td>
        </tr>
    `).join('');
}

// --- 邀请相关逻辑 ---
function openInviteModal() {
    const modal = document.getElementById('invite-modal');
    modal.classList.remove('hidden');
    // 确保显示表单页，隐藏结果页
    document.getElementById('invite-form-step').classList.remove('hidden');
    document.getElementById('invite-result-step').classList.add('hidden');
    // 重置选中状态
    selectDuration(30);
    // 动画 hack: 先 remove hidden，再加 flex，确保居中生效
    setTimeout(() => { modal.classList.add('flex'); }, 10);
}

function closeInviteModal() {
    const modal = document.getElementById('invite-modal');
    modal.classList.remove('flex');
    modal.classList.add('hidden');
}

function selectDuration(days) {
    selectedDuration = days;
    document.querySelectorAll('.dur-btn').forEach(btn => {
        btn.classList.remove('bg-indigo-50', 'border-indigo-500', 'text-indigo-600', 'dark:bg-indigo-900/50', 'dark:text-indigo-300');
        btn.classList.add('border-gray-200', 'dark:border-gray-600');
    });
    // 找到对应按钮高亮
    const btns = document.querySelectorAll('.dur-btn');
    for (let btn of btns) {
        if (btn.getAttribute('onclick').includes(`selectDuration(${days})`)) {
            btn.classList.remove('border-gray-200', 'dark:border-gray-600');
            btn.classList.add('bg-indigo-50', 'border-indigo-500', 'text-indigo-600', 'dark:bg-indigo-900/50', 'dark:text-indigo-300');
            break;
        }
    }
}

async function generateInvite() {
    const res = await fetch('/api/manage/invite/gen', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ days: selectedDuration })
    });
    const json = await res.json();
    if (json.status === 'success') {
        const link = window.location.origin + '/invite/' + json.code;
        document.getElementById('invite-link-box').textContent = link;
        document.getElementById('invite-form-step').classList.add('hidden');
        document.getElementById('invite-result-step').classList.remove('hidden');
    } else {
        alert('生成失败: ' + json.message);
    }
}

function copyInvite() {
    const text = document.getElementById('invite-link-box').textContent;
    navigator.clipboard.writeText(text).then(() => alert('✅ 已复制到剪贴板'));
}

// --- 原有：新建用户逻辑 ---
function openNewUserModal() { 
    const modal = document.getElementById('new-user-modal');
    modal.classList.remove('hidden');
    setTimeout(() => { modal.classList.add('flex'); }, 10);
}
function closeNewUserModal() { 
    const modal = document.getElementById('new-user-modal');
    modal.classList.remove('flex');
    modal.classList.add('hidden');
}

async function submitNewUser() {
    const name = document.getElementById('new-username').value;
    const expire = document.getElementById('new-expire').value;
    if (!name) return alert("请输入用户名");
    
    const res = await fetch('/api/manage/user/new', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ name, expire_date: expire || null })
    });
    const json = await res.json();
    if (json.status === 'success') {
        alert(json.message);
        closeNewUserModal();
        loadUsers();
    } else {
        alert(json.message);
    }
}

async function deleteUser(uid) {
    if (!confirm('确定要删除此用户吗？操作不可恢复！')) return;
    const res = await fetch(`/api/manage/user/${uid}`, { method: 'DELETE' });
    const json = await res.json();
    if (json.status === 'success') loadUsers();
    else alert(json.message);
}
</script>
{% endblock %}