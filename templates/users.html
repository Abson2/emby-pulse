{% extends "layout.html" %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
        <h1 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center gap-3">
            <i class="fa-solid fa-users text-indigo-500"></i>
            ç”¨æˆ·ç®¡ç†
        </h1>
        <div class="flex gap-2">
            <button onclick="openInviteModal()" class="flex items-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg transition shadow-sm font-medium">
                <i class="fa-solid fa-link"></i> <span class="hidden md:inline">é‚€è¯·é“¾æ¥</span><span class="md:hidden">é‚€è¯·</span>
            </button>
            <button onclick="openNewUserModal()" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition shadow-sm font-medium">
                <i class="fa-solid fa-user-plus"></i> <span class="hidden md:inline">æ–°å»ºç”¨æˆ·</span><span class="md:hidden">æ–°å»º</span>
            </button>
        </div>
    </div>

    <div class="hidden md:block bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-gray-600 dark:text-gray-300">
                <thead class="bg-gray-50 dark:bg-gray-700/50 text-gray-900 dark:text-gray-100 font-medium border-b border-gray-100 dark:border-gray-700">
                    <tr>
                        <th class="px-6 py-4">ç”¨æˆ·</th>
                        <th class="px-6 py-4">çŠ¶æ€</th>
                        <th class="px-6 py-4">æœ‰æ•ˆæœŸè‡³</th>
                        <th class="px-6 py-4">æœ€åç™»å½•</th>
                        <th class="px-6 py-4 text-right">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700" id="user-list-body-desktop">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="grid grid-cols-1 gap-4 md:hidden" id="user-list-body-mobile">
        </div>
</div>

<div id="invite-modal" class="fixed inset-0 z-50 hidden items-center justify-center h-screen w-screen bg-black/50 backdrop-blur-sm px-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">æ‰¹é‡ç”Ÿæˆé‚€è¯·ç </h3>
        
        <div id="invite-form-step" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">æœ‰æ•ˆæœŸé€‰é¡¹</label>
                <div class="grid grid-cols-4 gap-2 mb-3">
                    <button onclick="selectDuration(1)" class="dur-btn px-2 py-2 border rounded-lg text-xs hover:bg-indigo-50">1 å¤©</button>
                    <button onclick="selectDuration(7)" class="dur-btn px-2 py-2 border rounded-lg text-xs hover:bg-indigo-50">7 å¤©</button>
                    <button onclick="selectDuration(30)" class="dur-btn px-2 py-2 border border-indigo-500 bg-indigo-50 text-indigo-600 font-bold rounded-lg text-xs">30 å¤©</button>
                    <button onclick="selectDuration(90)" class="dur-btn px-2 py-2 border rounded-lg text-xs hover:bg-indigo-50">90 å¤©</button>
                    <button onclick="selectDuration(180)" class="dur-btn px-2 py-2 border rounded-lg text-xs hover:bg-indigo-50">180 å¤©</button>
                    <button onclick="selectDuration(365)" class="dur-btn px-2 py-2 border rounded-lg text-xs hover:bg-indigo-50">365 å¤©</button>
                    <button onclick="selectDuration(-1)" class="dur-btn px-2 py-2 border rounded-lg text-xs hover:bg-indigo-50 col-span-2">æ°¸ä¹…æœ‰æ•ˆ</button>
                </div>
                <div class="flex items-center gap-2 mt-2">
                    <span class="text-xs text-gray-500">è‡ªå®šä¹‰å¤©æ•°:</span>
                    <input type="number" id="custom-days" placeholder="è¾“å…¥å¤©æ•°" class="flex-1 px-3 py-1.5 border rounded-lg text-sm bg-gray-50 dark:bg-gray-700 outline-none" oninput="selectDuration(this.value)">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 caps">ä¸€æ¬¡ç”Ÿæˆå‡ æ¡é“¾æ¥ï¼Ÿ</label>
                <input type="number" id="invite-count" value="1" min="1" max="50" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 outline-none">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 caps">æƒé™æ¨¡æ¿ (ç»§æ‰¿è°çš„æƒé™)</label>
                <select id="invite-template" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 outline-none"></select>
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeInviteModal()" class="px-4 py-2 text-gray-500 font-medium">å–æ¶ˆ</button>
                <button onclick="generateInvite()" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-bold shadow-sm">ç«‹å³ç”Ÿæˆ</button>
            </div>
        </div>

        <div id="invite-result-step" class="hidden space-y-4">
            <div class="text-center">
                <div class="bg-green-50 p-3 rounded-full inline-flex items-center justify-center mb-2"><i class="fa-solid fa-check text-2xl text-green-500"></i></div>
                <h4 class="text-lg font-bold text-gray-900 dark:text-white">é‚€è¯·é“¾æ¥å·²ç”Ÿæˆ</h4>
            </div>
            <div id="invite-links-container" class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar p-1">
                </div>
            <div class="flex justify-center mt-6">
                <button onclick="closeInviteModal()" class="px-8 py-2 bg-indigo-600 text-white rounded-lg font-bold">å®Œæˆå¹¶å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<div id="edit-user-modal" class="fixed inset-0 z-50 hidden items-center justify-center h-screen w-screen bg-black/50 backdrop-blur-sm px-4 py-6">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md flex flex-col max-h-[95vh]">
        <div class="p-6 pb-4 shrink-0 border-b border-gray-100 dark:border-gray-700">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">ç”¨æˆ·æƒé™é…ç½®</h3>
            <div class="flex gap-6">
                <button onclick="switchEditTab('basic')" id="tab-btn-basic" class="pb-2 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 transition-colors">åŸºç¡€èµ„æ–™</button>
                <button onclick="switchEditTab('library')" id="tab-btn-library" class="pb-2 text-sm font-medium text-gray-500 border-b-2 border-transparent transition-colors">åª’ä½“åº“ç®¡ç†</button>
            </div>
        </div>
        <input type="hidden" id="edit-userid">
        <div class="p-6 pt-5 overflow-y-auto custom-scrollbar flex-1">
            <div id="edit-tab-basic" class="block space-y-5">
                <div class="flex flex-col items-center pb-5 border-b border-gray-50 dark:border-gray-700">
                    <img id="edit-avatar-preview" src="" class="w-24 h-24 rounded-full border-4 border-white shadow-lg bg-indigo-50 mb-3">
                    <input type="file" id="edit-avatar-file" class="hidden" onchange="previewFileAvatar()">
                    <div class="flex gap-2">
                        <button onclick="generateRandomAvatar()" class="text-xs bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded hover:bg-indigo-100 transition"><i class="fa-solid fa-dice"></i> éšæœºå¤´åƒ</button>
                        <button onclick="document.getElementById('edit-avatar-file').click()" class="text-xs bg-gray-50 text-gray-600 px-3 py-1.5 rounded hover:bg-gray-100 transition"><i class="fa-solid fa-upload"></i> ä¸Šä¼ å›¾ç‰‡</button>
                    </div>
                </div>
                <div class="space-y-4">
                    <div><label class="block text-xs font-bold text-gray-400 mb-1 caps">å½“å‰è´¦å·</label><input type="text" id="edit-username" class="w-full px-4 py-2 border rounded-lg bg-gray-100 cursor-not-allowed" disabled></div>
                    <div><label class="block text-xs font-bold text-gray-400 mb-1 caps">é‡ç½®å¯†ç </label><input type="password" id="edit-password" class="w-full px-4 py-2 border rounded-lg bg-gray-50 dark:bg-gray-700 outline-none" placeholder="ä¿®æ”¹è¯·åœ¨æ­¤è¾“å…¥æ–°å¯†ç "></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-gray-400 mb-1">æ´»è·ƒçŠ¶æ€</label><select id="edit-disabled" class="w-full px-4 py-2 border rounded-lg bg-gray-50 outline-none"><option value="false">âœ… æ­£å¸¸æ´»è·ƒ</option><option value="true">ğŸš« å·²è¢«ç¦ç”¨</option></select></div>
                        <div><label class="block text-xs font-bold text-gray-400 mb-1">æœ‰æ•ˆæ—¥æœŸ</label><input type="date" id="edit-expire" class="w-full px-4 py-2 border rounded-lg bg-gray-50 outline-none"></div>
                    </div>
                </div>
            </div>
            <div id="edit-tab-library" class="hidden space-y-5">
                <div class="bg-indigo-50/50 p-4 rounded-xl border border-indigo-100">
                    <label class="block text-sm font-bold text-indigo-800 mb-2">ä¸€é”®é•œåƒåŒæ­¥å…¶ä»–è´¦å·æƒé™</label>
                    <div class="flex gap-2">
                        <select id="edit-template-select" class="flex-1 px-3 py-2 border border-gray-200 bg-white rounded-lg text-sm outline-none"></select>
                        <button onclick="applyEditTemplate()" id="apply-template-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold transition whitespace-nowrap">åŒæ­¥å¥—ç”¨</button>
                    </div>
                </div>
                <label class="flex items-center justify-between p-4 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 transition shadow-sm">
                    <div><div class="text-sm font-bold">å¼€é€šæ‰€æœ‰åª’ä½“åº“</div><div class="text-[10px] text-gray-400">å¼€å¯åå°†è·å¾—æœåŠ¡å™¨ 100% è®¿é—®æƒé™</div></div>
                    <div class="relative"><input type="checkbox" id="edit-enable-all" class="sr-only peer" onchange="toggleLibraryCheckboxes()"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div></div>
                </label>
                <div>
                    <div class="flex items-center justify-between mb-3"><label class="text-xs font-bold text-gray-400Caps">æŒ‡å®šæƒé™ç™½åå•</label><button onclick="clearSubFolders()" id="clear-sub-btn" class="text-[10px] text-indigo-500 border border-indigo-100 px-2 py-1 rounded bg-indigo-50 transition-all font-bold"><i class="fa-solid fa-broom mr-1"></i>ä¸€é”®é‡ç½®å­é»‘åå•</button></div>
                    <div id="edit-library-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2 bg-gray-50 p-3 rounded-xl border border-gray-100 max-h-52 overflow-y-auto custom-scrollbar"></div>
                    <p class="text-[10px] text-gray-400 mt-2 italic leading-relaxed">æç¤ºï¼šå¦‚æœå‹¾é€‰åª’ä½“åº“åå‘ç°éƒ¨åˆ†å†…å®¹ä¸å¯è§ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹â€œé‡ç½®å­é»‘åå•â€å¹¶ä¿å­˜ã€‚</p>
                </div>
            </div>
        </div>
        <div class="p-6 pt-4 border-t border-gray-100 flex justify-end gap-3 shrink-0">
            <button onclick="closeEditUserModal()" class="px-5 py-2 text-gray-500 font-medium">å–æ¶ˆæ“ä½œ</button>
            <button onclick="submitEditUser()" id="save-user-btn" class="px-7 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-md"><span id="save-user-text">ä¿å­˜é…ç½®å˜æ›´</span></button>
        </div>
    </div>
</div>

<script>
/** æ ¸å¿ƒå˜é‡å®šä¹‰ **/
let users = [], allLibraries = [], selectedDuration = 30, currentAvatarUrl = "", currentAvatarFile = null, currentExcludedSubFolders = []; 

/** é¡µé¢åŠ è½½åˆå§‹åŒ– **/
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    loadLibraries();
});

async function loadLibraries() {
    try {
        const res = await fetch('/api/manage/libraries');
        const json = await res.json();
        if (json.status === 'success') allLibraries = json.data;
    } catch (e) { console.error("åº“æ‹‰å–å¤±è´¥", e); }
}

async function loadUsers() {
    try {
        const res = await fetch('/api/manage/users');
        const json = await res.json();
        if (json.status === 'success') { users = json.data; renderUsers(); }
    } catch (e) { console.error("ç”¨æˆ·æ‹‰å–å¤±è´¥", e); }
}

/** æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨ (æ¡Œé¢ç«¯ä¸ç§»åŠ¨ç«¯å¡ç‰‡) **/
function renderUsers() {
    const desktop = document.getElementById('user-list-body-desktop');
    const mobile = document.getElementById('user-list-body-mobile');
    let dHtml = "", mHtml = "";
    
    for (let u of users) {
        const avatar = `
            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold overflow-hidden shadow-sm">
                ${u.PrimaryImageTag ? `<img src="/api/user/image/${u.Id}?v=${u.PrimaryImageTag}" class="w-full h-full object-cover">` : u.Name[0].toUpperCase()}
            </div>
        `;
        const statusBadge = u.IsDisabled 
            ? '<span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full">å·²ç¦ç”¨</span>' 
            : '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">æ­£å¸¸</span>';
        
        // æ¸²æŸ“æ¡Œé¢è¡¨æ ¼è¡Œ
        dHtml += `
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/40 transition-all border-b border-gray-50 dark:border-gray-700">
                <td class="px-6 py-4 flex items-center gap-3">
                    ${avatar}
                    <div>
                        <div class="font-bold text-gray-900 dark:text-white">${u.Name}</div>
                        ${u.IsAdmin?'<span class="text-[9px] bg-yellow-100 text-yellow-800 px-1 rounded border border-yellow-200">ç®¡ç†</span>':''}
                    </div>
                </td>
                <td class="px-6 py-4">${statusBadge}</td>
                <td class="px-6 py-4 text-sm font-mono">${u.ExpireDate||'æ°¸ä¹…'}</td>
                <td class="px-6 py-4 text-sm text-gray-500">${u.LastLoginDate?new Date(u.LastLoginDate).toLocaleDateString():'å°šæœªç™»å½•'}</td>
                <td class="px-6 py-4 text-right">
                    <button onclick="openEditUserModal('${u.Id}')" class="text-indigo-600 hover:text-indigo-800 font-bold">ç¼–è¾‘</button>
                    <button onclick="deleteUser('${u.Id}')" class="text-red-500 ml-4 hover:underline">åˆ é™¤</button>
                </td>
            </tr>
        `;
        
        // æ¸²æŸ“ç§»åŠ¨ç«¯å¡ç‰‡
        mHtml += `
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm mb-3">
                <div class="flex items-center gap-3 mb-3">
                    ${avatar}
                    <div>
                        <div class="font-bold text-gray-900 dark:text-white text-lg">${u.Name}</div>
                        <div class="text-[10px] text-gray-400">åˆ°æœŸ: ${u.ExpireDate||'æ°¸ä¹…'}</div>
                    </div>
                    <div class="ml-auto">${statusBadge}</div>
                </div>
                <div class="grid grid-cols-2 gap-2 pt-2 border-t border-gray-50 dark:border-gray-700">
                    <button onclick="openEditUserModal('${u.Id}')" class="py-2 text-sm font-bold bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 rounded-lg">ä¿®æ”¹èµ„æ–™</button>
                    <button onclick="deleteUser('${u.Id}')" class="py-2 text-sm font-bold bg-red-50 dark:bg-red-900/30 text-red-600 rounded-lg">åˆ é™¤ç”¨æˆ·</button>
                </div>
            </div>
        `;
    }
    desktop.innerHTML = dHtml; mobile.innerHTML = mHtml;
}

/** é‚€è¯·ç”Ÿæˆé€»è¾‘ (æ¢å¤å…¨éƒ¨å¤©æ•°æŒ‰é’® + è‡ªå®šä¹‰å¤©æ•° + æ‰¹é‡å¤„ç†) **/
function selectDuration(d) {
    selectedDuration = parseInt(d);
    document.querySelectorAll('.dur-btn').forEach(b => {
        b.className = "dur-btn px-2 py-2 border border-gray-100 dark:border-gray-700 rounded-lg text-xs hover:bg-indigo-50";
    });
    const target = Array.from(document.querySelectorAll('.dur-btn')).find(b => b.getAttribute('onclick').includes(`(${d})`));
    if (target) {
        target.className = "dur-btn px-2 py-2 border border-indigo-500 bg-indigo-50 text-indigo-600 font-bold rounded-lg text-xs shadow-sm";
    }
}

async function generateInvite() {
    const count = parseInt(document.getElementById('invite-count').value) || 1;
    const tid = document.getElementById('invite-template').value;
    const btn = event.target;
    btn.disabled = true; btn.textContent = "æ­£åœ¨ç”Ÿæˆ...";
    
    try {
        const res = await fetch('/api/manage/invite/gen', {
            method: 'POST', 
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ days: selectedDuration, count: count, template_user_id: tid || null }) 
        });
        const json = await res.json();
        if (json.status === 'success') {
            const container = document.getElementById('invite-links-container');
            container.innerHTML = json.codes.map(c => {
                const link = window.location.origin + '/invite/' + c;
                return `
                    <div class="flex items-center gap-2 bg-gray-50 dark:bg-gray-700/50 p-2 rounded border border-gray-100 dark:border-gray-600 mb-1">
                        <span class="flex-1 truncate font-mono text-[10px] select-all">${link}</span>
                        <button onclick="copyToClipboard('${link}')" class="text-indigo-500 font-bold px-2 text-xs border-l border-gray-200">å¤åˆ¶</button>
                    </div>
                `;
            }).join('');
            document.getElementById('invite-form-step').classList.add('hidden');
            document.getElementById('invite-result-step').classList.remove('hidden');
        }
    } catch(e) { alert("ç”Ÿæˆå¤±è´¥"); }
    btn.disabled = false; btn.textContent = "ç«‹å³ç”Ÿæˆ";
}

function copyToClipboard(t) { navigator.clipboard.writeText(t).then(() => alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')); }

/** ç¼–è¾‘é€»è¾‘ï¼šé•œåƒåŒæ­¥ä¸å­é»‘åå•ä¸€é”®é‡ç½® **/
async function openEditUserModal(uid) {
    const user = users.find(u => u.Id === uid); if(!user) return;
    switchEditTab('basic');
    document.getElementById('edit-userid').value = uid;
    document.getElementById('edit-username').value = user.Name;
    document.getElementById('edit-disabled').value = String(user.IsDisabled);
    document.getElementById('edit-expire').value = user.ExpireDate || '';
    document.getElementById('edit-password').value = '';
    
    document.getElementById('edit-avatar-preview').src = user.PrimaryImageTag ? `/api/user/image/${uid}?t=${Date.now()}` : `https://api.dicebear.com/9.x/notionists/png?seed=${user.Name}`;
    document.getElementById('edit-user-modal').classList.remove('hidden');
    setTimeout(() => { document.getElementById('edit-user-modal').classList.add('flex'); }, 10);

    // å…³é”®ï¼šå®æ—¶ä»åç«¯è¯·æ±‚æœ€æ–°çš„æƒé™å’Œé»‘åå•æ•°æ®
    try {
        const res = await fetch(`/api/manage/user/${uid}`);
        const json = await res.json();
        if (json.status === 'success') {
            user.EnableAllFolders = json.data.EnableAllFolders;
            user.EnabledFolders = json.data.EnabledFolders;
            currentExcludedSubFolders = json.data.ExcludedSubFolders || [];
        }
    } catch(e) {}
    
    renderLibraryCheckboxes(user);
    populateTemplates('edit-template-select', uid);
}

function renderLibraryCheckboxes(user) {
    const list = document.getElementById('edit-library-list');
    list.innerHTML = allLibraries.map(lib => {
        const checked = user.EnabledFolders.includes(lib.Id) ? 'checked' : '';
        return `
            <label class="flex items-center gap-2 p-2 bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-lg cursor-pointer hover:shadow-sm transition">
                <input type="checkbox" value="${lib.Id}" class="lib-checkbox w-4 h-4 text-indigo-600 rounded" ${checked}>
                <span class="text-xs truncate text-gray-700 dark:text-gray-300 font-medium">${lib.Name}</span>
            </label>
        `;
    }).join('');
    document.getElementById('edit-enable-all').checked = user.EnableAllFolders;
    toggleLibraryCheckboxes();
}

function toggleLibraryCheckboxes() {
    const isAll = document.getElementById('edit-enable-all').checked;
    document.querySelectorAll('.lib-checkbox').forEach(cb => { cb.disabled = isAll; });
    document.getElementById('edit-library-list').style.opacity = isAll ? '0.3' : '1';
    document.getElementById('edit-library-list').style.pointerEvents = isAll ? 'none' : 'auto';
}

function clearSubFolders() {
    if (confirm('è¯¥æ“ä½œå°†æ¸…ç©ºè¯¥ç”¨æˆ·å·²å‹¾é€‰åº“ä¸­çš„æ‰€æœ‰å­ç›®å½•éšè—è®°å½•ï¼Œä½¿å…¶æ¢å¤ 100% æ‰“å‹¾å¯è§ã€‚ç»§ç»­ï¼Ÿ')) {
        currentExcludedSubFolders = [];
        const btn = document.getElementById('clear-sub-btn');
        btn.innerHTML = 'âœ¨ é»‘åå•å·²æ¸…ç©º (ä¿å­˜ç”Ÿæ•ˆ)'; 
        btn.classList.replace('text-indigo-500', 'text-green-600');
    }
}

async function applyEditTemplate() {
    const tid = document.getElementById('edit-template-select').value; if(!tid) return;
    const btn = document.getElementById('apply-template-btn'), old = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; btn.disabled = true;
    try {
        const res = await fetch(`/api/manage/user/${tid}`);
        const json = await res.json();
        if (json.status === 'success') {
            document.getElementById('edit-enable-all').checked = json.data.EnableAllFolders;
            const boxes = document.querySelectorAll('.lib-checkbox');
            boxes.forEach(cb => cb.checked = json.data.EnabledFolders.includes(cb.value));
            // ğŸ”¥ å®Œå…¨é•œåƒï¼šæŠ„è¢­å­æ–‡ä»¶å¤¹æ’é™¤åˆ—è¡¨
            currentExcludedSubFolders = json.data.ExcludedSubFolders || [];
            toggleLibraryCheckboxes();
            btn.innerHTML = 'âœ… å·²é•œåƒé•œåƒ'; btn.classList.add('bg-green-600');
        }
    } catch(e) {}
    setTimeout(() => { btn.innerHTML = old; btn.classList.remove('bg-green-600'); btn.disabled = false; }, 1500);
}

async function submitEditUser() {
    const btn = document.getElementById('save-user-btn'), uid = document.getElementById('edit-userid').value;
    const enableAll = document.getElementById('edit-enable-all').checked;
    const checked = Array.from(document.querySelectorAll('.lib-checkbox:checked')).map(cb => cb.value);
    
    btn.disabled = true; document.getElementById('save-user-text').textContent = "æ­£åœ¨æäº¤é…ç½®...";

    // å¹¶å‘å¤„ç†å¤´åƒ
    if (currentAvatarUrl || currentAvatarFile) {
        const fd = new FormData(); fd.append('user_id', uid);
        if (currentAvatarFile) fd.append('file', currentAvatarFile); else fd.append('url', currentAvatarUrl);
        await fetch('/api/manage/user/image', { method: 'POST', body: fd });
    }

    const res = await fetch('/api/manage/user/update', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
            user_id: uid, is_disabled: document.getElementById('edit-disabled').value==="true", 
            expire_date: document.getElementById('edit-expire').value||"", password: document.getElementById('edit-password').value||null,
            enable_all_folders: enableAll, enabled_folders: enableAll ? [] : checked, 
            excluded_sub_folders: currentExcludedSubFolders // ğŸ”¥ åŒæ­¥å­æ–‡ä»¶å¤¹
        })
    });
    
    if ((await res.json()).status === 'success') { closeEditUserModal(); loadUsers(); } 
    else { alert('æ›´æ–°é…ç½®å¤±è´¥'); }
    btn.disabled = false; document.getElementById('save-user-text').textContent = "ä¿å­˜é…ç½®å˜æ›´";
}

/** é€šç”¨ UI è¾…åŠ©é€»è¾‘ **/
function switchEditTab(tabName) {
    const isB = (tabName === 'basic');
    document.getElementById('edit-tab-basic').style.display = isB ? 'block' : 'none';
    document.getElementById('edit-tab-library').style.display = isB ? 'none' : 'block';
    const bB = document.getElementById('tab-btn-basic'), bL = document.getElementById('tab-btn-library');
    if (isB) { bB.className = "pb-2 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600"; bL.className = "pb-2 text-sm font-medium text-gray-500 border-b-2 border-transparent"; }
    else { bL.className = "pb-2 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600"; bB.className = "pb-2 text-sm font-medium text-gray-500 border-b-2 border-transparent"; }
}

function openInviteModal() { 
    document.getElementById('invite-modal').classList.remove('hidden'); 
    setTimeout(()=>document.getElementById('invite-modal').classList.add('flex'),10);
    selectDuration(30); 
    populateTemplates('invite-template'); 
}
function closeInviteModal() { 
    document.getElementById('invite-modal').classList.remove('flex'); 
    document.getElementById('invite-modal').classList.add('hidden'); 
    document.getElementById('invite-form-step').classList.remove('hidden');
    document.getElementById('invite-result-step').classList.add('hidden');
}

function populateTemplates(id, exUid = null) {
    const sel = document.getElementById(id); sel.innerHTML = '<option value="">é»˜è®¤å…¨åº“æƒé™</option>';
    for (let u of users) { if(exUid && u.Id === exUid) continue; let o = document.createElement('option'); o.value = u.Id; o.textContent = "ğŸ‘¤ " + u.Name; sel.appendChild(o); }
}

function openNewUserModal() { 
    document.getElementById('new-user-modal').classList.remove('hidden'); 
    setTimeout(()=>document.getElementById('new-user-modal').classList.add('flex'),10); 
    populateTemplates('new-template'); 
}
function closeNewUserModal() { document.getElementById('new-user-modal').classList.remove('flex'); document.getElementById('new-user-modal').classList.add('hidden'); }

async function submitNewUser() {
    const res = await fetch('/api/manage/user/new', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
            name: document.getElementById('new-username').value, 
            password: document.getElementById('new-password').value, 
            expire_date: document.getElementById('new-expire').value || null, 
            template_user_id: document.getElementById('new-template').value || null 
        })
    });
    if ((await res.json()).status === 'success') { closeNewUserModal(); loadUsers(); }
}

function generateRandomAvatar() {
    currentAvatarUrl = `https://api.dicebear.com/9.x/notionists/png?seed=${Math.random().toString(36)}`;
    currentAvatarFile = null; document.getElementById('edit-avatar-preview').src = currentAvatarUrl;
}
function setAvatarPreset(s) {
    currentAvatarUrl = `https://api.dicebear.com/9.x/${s}/png?seed=${Math.random()}`;
    currentAvatarFile = null; document.getElementById('edit-avatar-preview').src = currentAvatarUrl;
}
function previewFileAvatar() {
    const f = document.getElementById('edit-avatar-file').files[0];
    if(f) {
        currentAvatarFile = f; currentAvatarUrl = "";
        const r = new FileReader(); r.onload = e => document.getElementById('edit-avatar-preview').src = e.target.result;
        r.readAsDataURL(f);
    }
}
async function deleteUser(uid) { 
    if(confirm('å±é™©æ“ä½œï¼šè´¦å·å°†è¢«ç‰©ç†åˆ é™¤ä¸”æ— æ³•æ¢å¤ï¼Œç¡®è®¤ï¼Ÿ')) { 
        await fetch(`/api/manage/user/${uid}`, {method:'DELETE'}); 
        loadUsers(); 
    } 
}
function closeEditUserModal() { document.getElementById('edit-user-modal').classList.remove('flex'); document.getElementById('edit-user-modal').classList.add('hidden'); }
</script>

<style>
.custom-scrollbar::-webkit-scrollbar { width: 4px; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
.caps { font-variant: small-caps; text-transform: lowercase; font-weight: 800; }
</style>
{% endblock %}