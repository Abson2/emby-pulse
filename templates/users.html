{% extends "layout.html" %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
        <h1 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center gap-3">
            <i class="fa-solid fa-users text-indigo-500"></i>
            ç”¨æˆ·ç®¡ç†
        </h1>
        <div class="flex gap-2">
            <button onclick="openInviteModal()" class="flex items-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-2 text-sm md:px-4 md:py-2 rounded-lg transition shadow-sm font-medium">
                <i class="fa-solid fa-link"></i> <span class="hidden md:inline">é‚€è¯·é“¾æ¥</span><span class="md:hidden">é‚€è¯·</span>
            </button>
            <button onclick="openNewUserModal()" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 text-sm md:px-4 md:py-2 rounded-lg transition shadow-sm font-medium">
                <i class="fa-solid fa-user-plus"></i> <span class="hidden md:inline">æ–°å»ºç”¨æˆ·</span><span class="md:hidden">æ–°å»º</span>
            </button>
        </div>
    </div>

    <div class="hidden md:block bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-gray-600 dark:text-gray-300">
                <thead class="bg-gray-50 dark:bg-gray-700/50 text-gray-900 dark:text-gray-100 font-medium border-b border-gray-100 dark:border-gray-700">
                    <tr>
                        <th class="px-6 py-4">ç”¨æˆ·</th>
                        <th class="px-6 py-4">çŠ¶æ€</th>
                        <th class="px-6 py-4">æœ‰æ•ˆæœŸè‡³</th>
                        <th class="px-6 py-4">æœ€åç™»å½•</th>
                        <th class="px-6 py-4 text-right">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700" id="user-list-body-desktop">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="grid grid-cols-1 gap-4 md:hidden" id="user-list-body-mobile">
        </div>
</div>

<div id="new-user-modal" class="fixed inset-0 z-50 hidden items-center justify-center h-screen w-screen bg-black/50 backdrop-blur-sm px-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">æ–°å»ºç”¨æˆ·</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ç”¨æˆ·å</label>
                <input type="text" id="new-username" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">å¯†ç  (å¯é€‰)</label>
                <input type="password" id="new-password" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ç•™ç©ºåˆ™æ— å¯†ç ">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æœ‰æ•ˆæœŸ (ç•™ç©ºä¸ºæ°¸ä¹…)</label>
                <input type="date" id="new-expire" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeNewUserModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">å–æ¶ˆ</button>
                <button onclick="submitNewUser()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg">åˆ›å»º</button>
            </div>
        </div>
    </div>
</div>

<div id="edit-user-modal" class="fixed inset-0 z-50 hidden items-center justify-center h-screen w-screen bg-black/50 backdrop-blur-sm px-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100 flex flex-col max-h-[90vh] overflow-y-auto hide-scrollbar">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">ç¼–è¾‘ç”¨æˆ·</h3>
        <input type="hidden" id="edit-userid">
        
        <div class="flex flex-col items-center mb-6 border-b border-gray-100 dark:border-gray-700 pb-6">
            <div class="relative group">
                <img id="edit-avatar-preview" src="" class="w-20 h-20 rounded-full object-cover border-4 border-white dark:border-gray-700 shadow-md mb-3 bg-indigo-100">
                <input type="file" id="edit-avatar-file" accept="image/*" class="hidden" onchange="previewFileAvatar()">
            </div>
            
            <div class="flex gap-2 mb-4">
                <button onclick="generateRandomAvatar()" class="px-3 py-1.5 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 text-xs rounded-lg hover:bg-indigo-100 dark:hover:bg-indigo-900/50 transition">
                    <i class="fa-solid fa-dice mr-1"></i> éšæœºç”Ÿæˆ
                </button>
                <button onclick="document.getElementById('edit-avatar-file').click()" class="px-3 py-1.5 bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                    <i class="fa-solid fa-upload mr-1"></i> ä¸Šä¼ å›¾ç‰‡
                </button>
            </div>

            <div class="grid grid-cols-4 gap-3">
                <img onclick="setAvatarPreset('micah')" src="https://api.dicebear.com/9.x/micah/png?seed=Felix" title="Micah" class="w-10 h-10 rounded-full cursor-pointer hover:scale-110 transition border border-gray-200 dark:border-gray-600 bg-gray-50">
                <img onclick="setAvatarPreset('bottts')" src="https://api.dicebear.com/9.x/bottts/png?seed=Zoe" title="Robots" class="w-10 h-10 rounded-full cursor-pointer hover:scale-110 transition border border-gray-200 dark:border-gray-600 bg-gray-50">
                <img onclick="setAvatarPreset('avataaars')" src="https://api.dicebear.com/9.x/avataaars/png?seed=Jack" title="Avatars" class="w-10 h-10 rounded-full cursor-pointer hover:scale-110 transition border border-gray-200 dark:border-gray-600 bg-gray-50">
                <img onclick="setAvatarPreset('notionists')" src="https://api.dicebear.com/9.x/notionists/png?seed=Abby" title="Notion" class="w-10 h-10 rounded-full cursor-pointer hover:scale-110 transition border border-gray-200 dark:border-gray-600 bg-gray-50">
                
                <img onclick="setAvatarPreset('fun-emoji')" src="https://api.dicebear.com/9.x/fun-emoji/png?seed=Leo" title="Emoji" class="w-10 h-10 rounded-full cursor-pointer hover:scale-110 transition border border-gray-200 dark:border-gray-600 bg-gray-50">
                <img onclick="setAvatarPreset('lorelei')" src="https://api.dicebear.com/9.x/lorelei/png?seed=Sasha" title="Lorelei" class="w-10 h-10 rounded-full cursor-pointer hover:scale-110 transition border border-gray-200 dark:border-gray-600 bg-gray-50">
                <img onclick="setAvatarPreset('open-peeps')" src="https://api.dicebear.com/9.x/open-peeps/png?seed=Sam" title="Peeps" class="w-10 h-10 rounded-full cursor-pointer hover:scale-110 transition border border-gray-200 dark:border-gray-600 bg-gray-50">
                <img onclick="setAvatarPreset('adventurer')" src="https://api.dicebear.com/9.x/adventurer/png?seed=Max" title="Adventurer" class="w-10 h-10 rounded-full cursor-pointer hover:scale-110 transition border border-gray-200 dark:border-gray-600 bg-gray-50">
            </div>
        </div>

        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">å½“å‰ç”¨æˆ·</label>
                <input type="text" id="edit-username" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-100 dark:bg-gray-900/50 text-gray-500 cursor-not-allowed" disabled>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">é‡ç½®å¯†ç  (å¯é€‰)</label>
                <input type="password" id="edit-password" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹å¯†ç ">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">è´¦å·çŠ¶æ€</label>
                    <select id="edit-disabled" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="false">âœ… æ­£å¸¸</option>
                        <option value="true">ğŸš« ç¦ç”¨</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æœ‰æ•ˆæœŸ</label>
                    <input type="date" id="edit-expire" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-4">
                <button onclick="closeEditUserModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">å–æ¶ˆ</button>
                <button onclick="submitEditUser()" id="save-user-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition flex items-center">
                    <span id="save-user-text">ä¿å­˜ä¿®æ”¹</span>
                </button>
            </div>
        </div>
    </div>
</div>

<div id="invite-modal" class="fixed inset-0 z-50 hidden items-center justify-center h-screen w-screen bg-black/50 backdrop-blur-sm px-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">ç”Ÿæˆé‚€è¯·é“¾æ¥</h3>
        <div class="space-y-4" id="invite-form-step">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">è´¦å·æœ‰æ•ˆæœŸ (åˆ°æœŸè‡ªåŠ¨ç¦ç”¨)</label>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="selectDuration(1)" class="dur-btn px-3 py-2 border rounded-lg text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/30 border-gray-200 dark:border-gray-600">1 å¤©</button>
                    <button onclick="selectDuration(7)" class="dur-btn px-3 py-2 border rounded-lg text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/30 border-gray-200 dark:border-gray-600">7 å¤©</button>
                    <button onclick="selectDuration(30)" class="dur-btn px-3 py-2 border rounded-lg text-sm bg-indigo-50 border-indigo-500 text-indigo-600 dark:bg-indigo-900/50 dark:text-indigo-300">30 å¤©</button>
                    <button onclick="selectDuration(90)" class="dur-btn px-3 py-2 border rounded-lg text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/30 border-gray-200 dark:border-gray-600">3 ä¸ªæœˆ</button>
                    <button onclick="selectDuration(180)" class="dur-btn px-3 py-2 border rounded-lg text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/30 border-gray-200 dark:border-gray-600">6 ä¸ªæœˆ</button>
                    <button onclick="selectDuration(365)" class="dur-btn px-3 py-2 border rounded-lg text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/30 border-gray-200 dark:border-gray-600">12 ä¸ªæœˆ</button>
                    <button onclick="selectDuration(-1)" class="dur-btn px-3 py-2 border rounded-lg text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/30 border-gray-200 dark:border-gray-600 col-span-3">æ°¸ä¹…æœ‰æ•ˆ</button>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeInviteModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">å–æ¶ˆ</button>
                <button onclick="generateInvite()" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg">ç”Ÿæˆé“¾æ¥</button>
            </div>
        </div>

        <div id="invite-result-step" class="hidden text-center space-y-4">
            <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-full inline-flex items-center justify-center mb-2">
                <i class="fa-solid fa-check text-3xl text-green-500"></i>
            </div>
            <h4 class="text-lg font-bold text-gray-900 dark:text-white">é“¾æ¥å·²ç”Ÿæˆ</h4>
            <p class="text-sm text-gray-500 dark:text-gray-400">å°†ä¸‹æ–¹é“¾æ¥å‘é€ç»™å¥½å‹ï¼Œå³å¯é‚€è¯·æ³¨å†Œã€‚</p>
            
            <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg break-all font-mono text-sm text-gray-600 dark:text-gray-300 select-all border border-gray-100 dark:border-gray-700" id="invite-link-box">...</div>
            <div class="flex justify-center gap-3 mt-6">
                <button onclick="closeInviteModal()" class="px-6 py-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">å®Œæˆ</button>
                <button onclick="copyInvite()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg flex items-center gap-2">
                    <i class="fa-regular fa-copy"></i> å¤åˆ¶é“¾æ¥
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let users = [];
let embyUrl = ""; 
let selectedDuration = 30; 

// å¤´åƒç®¡ç†çŠ¶æ€
let currentAvatarUrl = "";
let currentAvatarFile = null;

document.addEventListener('DOMContentLoaded', loadUsers);

async function loadUsers() {
    const res = await fetch('/api/manage/users');
    const json = await res.json();
    if (json.status === 'success') {
        users = json.data;
        embyUrl = json.emby_url || "";
        renderUsers();
    }
}

function renderUsers() {
    const desktopBody = document.getElementById('user-list-body-desktop');
    const mobileBody = document.getElementById('user-list-body-mobile');
    
    const getAvatar = (u) => {
        // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šå¢åŠ  ?v=Tag æ¥å¼ºåˆ¶åˆ·æ–°ç¼“å­˜
        const proxyUrl = `/api/user/image/${u.Id}?v=${u.PrimaryImageTag || new Date().getTime()}`;
        
        const fallbackHtml = `
            <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center text-indigo-600 dark:text-indigo-300 font-bold text-xs md:text-sm">
                ${u.Name[0].toUpperCase()}
            </div>`;
            
        if (u.PrimaryImageTag) {
            return `
            <div class="relative w-8 h-8 md:w-10 md:h-10">
                <img src="${proxyUrl}" class="w-full h-full rounded-full object-cover absolute inset-0" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                <div class="w-full h-full rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center text-indigo-600 dark:text-indigo-300 font-bold text-xs md:text-sm hidden">
                    ${u.Name[0].toUpperCase()}
                </div>
            </div>`;
        }
        return fallbackHtml;
    };

    // æ¸²æŸ“æ¡Œé¢è¡¨æ ¼
    desktopBody.innerHTML = users.map(u => `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/30 transition-colors">
            <td class="px-6 py-4">
                <div class="flex items-center gap-3">
                    ${getAvatar(u)}
                    <div>
                        <div class="font-medium text-gray-900 dark:text-white">${u.Name}</div>
                        ${u.IsAdmin ? '<span class="text-[10px] bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded">ç®¡ç†å‘˜</span>' : ''}
                    </div>
                </div>
            </td>
            <td class="px-6 py-4">
                ${u.IsDisabled 
                    ? '<span class="px-2 py-1 rounded-full text-xs bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400">å·²ç¦ç”¨</span>' 
                    : '<span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">æ­£å¸¸</span>'}
            </td>
            <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
                ${u.ExpireDate || 'æ°¸ä¹…'}
            </td>
            <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
                ${u.LastLoginDate ? new Date(u.LastLoginDate).toLocaleDateString() : 'ä»æœª'}
            </td>
            <td class="px-6 py-4 text-right space-x-2">
                <button onclick="openEditUserModal('${u.Id}')" class="text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300 text-sm">ç¼–è¾‘</button>
                <button onclick="deleteUser('${u.Id}')" class="text-red-500 hover:text-red-700 text-sm">åˆ é™¤</button>
            </td>
        </tr>
    `).join('');

    // æ¸²æŸ“ç§»åŠ¨ç«¯å¡ç‰‡
    mobileBody.innerHTML = users.map(u => `
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-100 dark:border-gray-700 shadow-sm flex flex-col gap-3">
            <div class="flex justify-between items-start">
                <div class="flex items-center gap-3">
                    ${getAvatar(u)}
                    <div>
                        <div class="font-bold text-gray-900 dark:text-white flex items-center gap-2">
                            ${u.Name}
                            ${u.IsAdmin ? '<span class="text-[10px] bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded">Admin</span>' : ''}
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                            ${u.LastLoginDate ? 'ä¸Šæ¬¡ç™»å½•: ' + new Date(u.LastLoginDate).toLocaleDateString() : 'ä»æœªç™»å½•'}
                        </div>
                    </div>
                </div>
                ${u.IsDisabled 
                    ? '<span class="px-2 py-1 rounded text-xs bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400">å·²ç¦ç”¨</span>' 
                    : '<span class="px-2 py-1 rounded text-xs bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">æ­£å¸¸</span>'}
            </div>
            
            <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-700/30 p-2 rounded-lg">
                <span class="text-xs text-gray-500 dark:text-gray-400">æœ‰æ•ˆæœŸè‡³</span>
                <span class="text-xs font-mono font-medium text-gray-700 dark:text-gray-300">${u.ExpireDate || 'æ°¸ä¹…æœ‰æ•ˆ'}</span>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-1">
                <button onclick="openEditUserModal('${u.Id}')" class="flex items-center justify-center gap-1 py-2 text-sm font-medium text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg">
                    ç¼–è¾‘
                </button>
                <button onclick="deleteUser('${u.Id}')" class="flex items-center justify-center gap-1 py-2 text-sm font-medium text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 rounded-lg">
                    åˆ é™¤
                </button>
            </div>
        </div>
    `).join('');
}

// --- é‚€è¯·ç›¸å…³ ---
function openInviteModal() {
    const modal = document.getElementById('invite-modal');
    modal.classList.remove('hidden');
    document.getElementById('invite-form-step').classList.remove('hidden');
    document.getElementById('invite-result-step').classList.add('hidden');
    selectDuration(30);
    setTimeout(() => { modal.classList.add('flex'); }, 10);
}

function closeInviteModal() {
    const modal = document.getElementById('invite-modal');
    modal.classList.remove('flex');
    modal.classList.add('hidden');
}

function selectDuration(days) {
    selectedDuration = days;
    document.querySelectorAll('.dur-btn').forEach(btn => {
        btn.classList.remove('bg-indigo-50', 'border-indigo-500', 'text-indigo-600', 'dark:bg-indigo-900/50', 'dark:text-indigo-300');
        btn.classList.add('border-gray-200', 'dark:border-gray-600');
    });
    const btns = document.querySelectorAll('.dur-btn');
    for (let btn of btns) {
        if (btn.getAttribute('onclick').includes(`selectDuration(${days})`)) {
            btn.classList.remove('border-gray-200', 'dark:border-gray-600');
            btn.classList.add('bg-indigo-50', 'border-indigo-500', 'text-indigo-600', 'dark:bg-indigo-900/50', 'dark:text-indigo-300');
            break;
        }
    }
}

async function generateInvite() {
    const res = await fetch('/api/manage/invite/gen', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ days: selectedDuration })
    });
    const json = await res.json();
    if (json.status === 'success') {
        const link = window.location.origin + '/invite/' + json.code;
        document.getElementById('invite-link-box').textContent = link;
        document.getElementById('invite-form-step').classList.add('hidden');
        document.getElementById('invite-result-step').classList.remove('hidden');
    } else {
        alert('ç”Ÿæˆå¤±è´¥: ' + json.message);
    }
}

function copyInvite() {
    const text = document.getElementById('invite-link-box').textContent;
    navigator.clipboard.writeText(text).then(() => alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'));
}

// --- æ–°å»ºç”¨æˆ·ç›¸å…³ ---
function openNewUserModal() { 
    const modal = document.getElementById('new-user-modal');
    modal.classList.remove('hidden');
    document.getElementById('new-username').value = '';
    document.getElementById('new-password').value = '';
    document.getElementById('new-expire').value = '';
    setTimeout(() => { modal.classList.add('flex'); }, 10);
}
function closeNewUserModal() { 
    const modal = document.getElementById('new-user-modal');
    modal.classList.remove('flex');
    modal.classList.add('hidden');
}

async function submitNewUser() {
    const name = document.getElementById('new-username').value;
    const pass = document.getElementById('new-password').value; 
    const expire = document.getElementById('new-expire').value;
    if (!name) return alert("è¯·è¾“å…¥ç”¨æˆ·å");
    
    const res = await fetch('/api/manage/user/new', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ name, password: pass, expire_date: expire || null })
    });
    const json = await res.json();
    if (json.status === 'success') {
        alert(json.message);
        closeNewUserModal();
        loadUsers();
    } else {
        alert(json.message);
    }
}

// --- ç¼–è¾‘ç”¨æˆ·ç›¸å…³ ---
function openEditUserModal(uid) {
    const user = users.find(u => u.Id === uid);
    if(!user) return;
    
    document.getElementById('edit-userid').value = uid;
    document.getElementById('edit-username').value = user.Name;
    document.getElementById('edit-disabled').value = user.IsDisabled ? "true" : "false";
    document.getElementById('edit-expire').value = user.ExpireDate || '';
    document.getElementById('edit-password').value = ''; 
    
    currentAvatarUrl = "";
    currentAvatarFile = null;
    
    const preview = document.getElementById('edit-avatar-preview');
    // è¿™é‡Œä½¿ç”¨å¸¦æ—¶é—´æˆ³çš„é¢„è§ˆå›¾ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°çš„
    if (user.PrimaryImageTag) {
        preview.src = `/api/user/image/${uid}?t=${new Date().getTime()}`;
    } else {
        preview.src = `https://api.dicebear.com/9.x/notionists/png?seed=${user.Name}`;
    }
    
    const modal = document.getElementById('edit-user-modal');
    modal.classList.remove('hidden');
    setTimeout(() => { modal.classList.add('flex'); }, 10);
}

function closeEditUserModal() {
    const modal = document.getElementById('edit-user-modal');
    modal.classList.remove('flex');
    modal.classList.add('hidden');
}

function generateRandomAvatar() {
    const styles = ['notionists', 'bottts', 'adventurer', 'avataaars', 'big-smile', 'fun-emoji', 'lorelei', 'open-peeps'];
    const style = styles[Math.floor(Math.random() * styles.length)];
    const seed = Math.random().toString(36).substring(7);
    const url = `https://api.dicebear.com/9.x/${style}/png?seed=${seed}`;
    
    currentAvatarUrl = url;
    currentAvatarFile = null; 
    document.getElementById('edit-avatar-preview').src = url;
}

function setAvatarPreset(style) {
    const seed = Math.random().toString(36).substring(7);
    const url = `https://api.dicebear.com/9.x/${style}/png?seed=${seed}`;
    currentAvatarUrl = url;
    currentAvatarFile = null;
    document.getElementById('edit-avatar-preview').src = url;
}

function previewFileAvatar() {
    const fileInput = document.getElementById('edit-avatar-file');
    if (fileInput.files && fileInput.files[0]) {
        currentAvatarFile = fileInput.files[0];
        currentAvatarUrl = ""; 
        
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('edit-avatar-preview').src = e.target.result;
        }
        reader.readAsDataURL(fileInput.files[0]);
    }
}

async function submitEditUser() {
    const btn = document.getElementById('save-user-btn');
    const btnText = document.getElementById('save-user-text');
    const uid = document.getElementById('edit-userid').value;
    const isDisabled = document.getElementById('edit-disabled').value === "true";
    const expire = document.getElementById('edit-expire').value;
    const pass = document.getElementById('edit-password').value; 
    
    btn.disabled = true;
    btnText.textContent = "ä¿å­˜ä¸­...";

    // 1. å¦‚æœæœ‰æ–°å¤´åƒï¼Œå…ˆä¸Šä¼ 
    if (currentAvatarUrl || currentAvatarFile) {
        const formData = new FormData();
        formData.append('user_id', uid);
        
        if (currentAvatarFile) {
            formData.append('file', currentAvatarFile);
        } else {
            formData.append('url', currentAvatarUrl);
        }
        
        try {
            await fetch('/api/manage/user/image', {
                method: 'POST',
                body: formData
            });
        } catch (e) {
            console.error("å¤´åƒä¸Šä¼ å¤±è´¥", e);
        }
    }
    
    // 2. æ›´æ–°ä¿¡æ¯
    const res = await fetch('/api/manage/user/update', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
            user_id: uid, 
            is_disabled: isDisabled,
            expire_date: expire || "",
            password: pass || null 
        })
    });
    
    const json = await res.json();
    if (json.status === 'success') {
        closeEditUserModal();
        loadUsers();
    } else {
        alert(json.message);
    }
    
    btn.disabled = false;
    btnText.textContent = "ä¿å­˜ä¿®æ”¹";
}

async function deleteUser(uid) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç”¨æˆ·å—ï¼Ÿæ“ä½œä¸å¯æ¢å¤ï¼')) return;
    const res = await fetch(`/api/manage/user/${uid}`, { method: 'DELETE' });
    const json = await res.json();
    if (json.status === 'success') loadUsers();
    else alert(json.message);
}
</script>
{% endblock %}