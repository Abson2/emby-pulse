{% extends "layout.html" %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
        <h1 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center gap-3">
            <i class="fa-solid fa-users text-indigo-500"></i>
            ç”¨æˆ·ç®¡ç†
        </h1>
        <div class="flex gap-2">
            <button onclick="openInviteModal()" class="flex items-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-2 text-sm md:px-4 md:py-2 rounded-lg transition shadow-sm font-medium">
                <i class="fa-solid fa-link"></i>
                <span class="hidden md:inline">é‚€è¯·é“¾æ¥</span>
                <span class="md:hidden">é‚€è¯·</span>
            </button>
            <button onclick="openNewUserModal()" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 text-sm md:px-4 md:py-2 rounded-lg transition shadow-sm font-medium">
                <i class="fa-solid fa-user-plus"></i>
                <span class="hidden md:inline">æ–°å»ºç”¨æˆ·</span>
                <span class="md:hidden">æ–°å»º</span>
            </button>
        </div>
    </div>

    <div class="hidden md:block bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-gray-600 dark:text-gray-300">
                <thead class="bg-gray-50 dark:bg-gray-700/50 text-gray-900 dark:text-gray-100 font-medium border-b border-gray-100 dark:border-gray-700">
                    <tr>
                        <th class="px-6 py-4">ç”¨æˆ·è¯¦æƒ…</th>
                        <th class="px-6 py-4">è´¦å·çŠ¶æ€</th>
                        <th class="px-6 py-4">æœ‰æ•ˆæœŸè‡³</th>
                        <th class="px-6 py-4">æœ€åç™»å½•</th>
                        <th class="px-6 py-4 text-right">ç®¡ç†æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700" id="user-list-body-desktop">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="grid grid-cols-1 gap-4 md:hidden" id="user-list-body-mobile">
        </div>
</div>

<div id="new-user-modal" class="fixed inset-0 z-50 hidden items-center justify-center h-screen w-screen bg-black/50 backdrop-blur-sm px-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">åˆ›å»º Emby è´¦å·</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ç”¨æˆ·å</label>
                <input type="text" id="new-username" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">åˆå§‹å¯†ç  (å¯é€‰)</label>
                <input type="password" id="new-password" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ä¸å¡«åˆ™æ— å¯†ç ">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">åˆ°æœŸæ—¶é—´ (ç•™ç©ºä¸ºæ°¸ä¹…)</label>
                <input type="date" id="new-expire" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æƒé™æ¨¡æ¿ <span class="text-xs text-gray-400 font-normal">(é•œåƒå¤åˆ¶åª’ä½“åº“é»‘ç™½åå•)</span></label>
                <select id="new-template" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none"></select>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeNewUserModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 font-medium">å–æ¶ˆ</button>
                <button onclick="submitNewUser()" id="new-user-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-sm">ç«‹å³åˆ›å»º</button>
            </div>
        </div>
    </div>
</div>

<div id="edit-user-modal" class="fixed inset-0 z-50 hidden items-center justify-center h-screen w-screen bg-black/50 backdrop-blur-sm px-4 py-6">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md flex flex-col max-h-[95vh]">
        <div class="p-6 pb-4 shrink-0">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">é…ç½®ç”¨æˆ·ä¿¡æ¯</h3>
                <button onclick="closeEditUserModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="flex border-b border-gray-200 dark:border-gray-700 gap-6">
                <button onclick="switchEditTab('basic')" id="tab-btn-basic" class="pb-2 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 dark:text-indigo-400 dark:border-indigo-400 transition-colors">åŸºç¡€è®¾ç½®</button>
                <button onclick="switchEditTab('library')" id="tab-btn-library" class="pb-2 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 dark:text-gray-400 transition-colors">åº“æƒé™ç®¡ç†</button>
            </div>
        </div>
        
        <input type="hidden" id="edit-userid">

        <div class="p-6 pt-0 overflow-y-auto custom-scrollbar flex-1">
            <div id="edit-tab-basic" class="block">
                <div class="flex flex-col items-center mb-6 border-b border-gray-100 dark:border-gray-700 pb-6">
                    <div class="relative mb-3">
                        <img id="edit-avatar-preview" src="" class="w-20 h-20 rounded-full object-cover border-4 border-white dark:border-gray-700 shadow-md bg-indigo-50">
                        <input type="file" id="edit-avatar-file" accept="image/*" class="hidden" onchange="previewFileAvatar()">
                    </div>
                    
                    <div class="flex gap-2 mb-4">
                        <button onclick="generateRandomAvatar()" class="px-3 py-1.5 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 text-xs rounded-lg hover:bg-indigo-100 transition"><i class="fa-solid fa-dice mr-1"></i> éšæœºç”Ÿæˆ</button>
                        <button onclick="document.getElementById('edit-avatar-file').click()" class="px-3 py-1.5 bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs rounded-lg hover:bg-gray-100 transition"><i class="fa-solid fa-upload mr-1"></i> æœ¬åœ°ä¸Šä¼ </button>
                    </div>

                    <div class="grid grid-cols-4 gap-3">
                        <img onclick="setAvatarPreset('micah')" src="https://api.dicebear.com/9.x/micah/png?seed=Felix" class="w-10 h-10 rounded-full cursor-pointer hover:scale-110 transition border border-gray-200">
                        <img onclick="setAvatarPreset('bottts')" src="https://api.dicebear.com/9.x/bottts/png?seed=Zoe" class="w-10 h-10 rounded-full cursor-pointer hover:scale-110 transition border border-gray-200">
                        <img onclick="setAvatarPreset('avataaars')" src="https://api.dicebear.com/9.x/avataaars/png?seed=Jack" class="w-10 h-10 rounded-full cursor-pointer hover:scale-110 transition border border-gray-200">
                        <img onclick="setAvatarPreset('open-peeps')" src="https://api.dicebear.com/9.x/open-peeps/png?seed=Sam" class="w-10 h-10 rounded-full cursor-pointer hover:scale-110 transition border border-gray-200">
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ç”¨æˆ·æ ‡è¯†</label>
                        <input type="text" id="edit-username" class="w-full px-4 py-2 rounded-lg border border-gray-200 bg-gray-50 text-gray-500 cursor-not-allowed" disabled>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ä¿®æ”¹å¯†ç  (ä¸æ”¹è¯·ç•™ç©º)</label>
                        <input type="password" id="edit-password" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">è´¦å·çŠ¶æ€</label>
                            <select id="edit-disabled" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="false">âœ… æ´»è·ƒä¸­</option>
                                <option value="true">ğŸš« å·²é”å®š</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æœ‰æ•ˆæ—¥æœŸ</label>
                            <input type="date" id="edit-expire" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                    </div>
                </div>
            </div>

            <div id="edit-tab-library" class="hidden space-y-5">
                <div class="bg-indigo-50/50 dark:bg-indigo-900/10 p-4 rounded-xl border border-indigo-100 dark:border-indigo-800/30">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-bold text-indigo-800 dark:text-indigo-300">ä¸€é”®é•œåƒåŒæ­¥æ¨¡æ¿</label>
                        <i class="fa-solid fa-wand-magic-sparkles text-indigo-400 text-xs"></i>
                    </div>
                    <div class="flex gap-2">
                        <select id="edit-template-select" class="flex-1 px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800 focus:ring-2 focus:ring-indigo-500 outline-none text-sm"></select>
                        <button onclick="applyEditTemplate()" id="apply-template-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition shadow-sm whitespace-nowrap">å¥—ç”¨</button>
                    </div>
                </div>

                <label class="flex items-center justify-between p-4 border border-gray-200 dark:border-gray-700 rounded-xl cursor-pointer hover:bg-gray-50 transition-all">
                    <div>
                        <div class="text-sm font-bold text-gray-800 dark:text-gray-200">å…è®¸è®¿é—®æ‰€æœ‰åª’ä½“åº“</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">å¼€å¯åï¼Œç”¨æˆ·å°†æ— è§†ä¸‹æ–¹åˆ—è¡¨è·å¾—å…¨åº“æƒé™</div>
                    </div>
                    <div class="relative">
                        <input type="checkbox" id="edit-enable-all" class="sr-only peer" onchange="toggleLibraryCheckboxes()">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                    </div>
                </label>

                <div>
                    <div class="flex items-center justify-between mb-3">
                        <label class="text-sm font-bold text-gray-700 dark:text-gray-300">é…ç½®å¯è®¿é—®çš„åª’ä½“åº“ (ç™½åå•)</label>
                        <button onclick="clearSubFolders()" id="clear-sub-btn" class="text-[10px] text-indigo-500 hover:text-indigo-700 border border-indigo-100 dark:border-indigo-800 px-2 py-1 rounded bg-indigo-50/50 dark:bg-indigo-900/20 transition-all">
                            <i class="fa-solid fa-broom mr-1"></i>é‡ç½®å­æ–‡ä»¶å¤¹é»‘åå•
                        </button>
                    </div>
                    <div id="edit-library-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2 bg-gray-50 dark:bg-gray-900/50 p-3 rounded-xl border border-gray-100 dark:border-gray-700 max-h-48 overflow-y-auto custom-scrollbar">
                        </div>
                    <p class="text-[10px] text-gray-400 mt-2 leading-relaxed">
                        <i class="fa-solid fa-circle-info mr-1"></i> æç¤ºï¼šè‹¥éƒ¨åˆ†æ–‡ä»¶å¤¹æœªå‹¾é€‰ï¼Œè¯·ç‚¹å‡»â€œé‡ç½®å­æ–‡ä»¶å¤¹é»‘åå•â€å¹¶ä¿å­˜ï¼Œå³å¯è®©æ‰€é€‰åº“æ¢å¤ 100% æ‰“å‹¾å¯è§ã€‚
                    </p>
                </div>
            </div>
        </div>

        <div class="p-6 pt-4 border-t border-gray-100 dark:border-gray-700 flex justify-end gap-3 shrink-0">
            <button onclick="closeEditUserModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 font-medium">å–æ¶ˆ</button>
            <button onclick="submitEditUser()" id="save-user-btn" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition font-bold shadow-sm flex items-center">
                <span id="save-user-text">ç¡®è®¤ä¿å­˜ä¿®æ”¹</span>
            </button>
        </div>
    </div>
</div>

<div id="invite-modal" class="fixed inset-0 z-50 hidden items-center justify-center h-screen w-screen bg-black/50 backdrop-blur-sm px-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">ç”Ÿæˆé‚€è¯·æ³¨å†Œé“¾æ¥</h3>
        
        <div id="invite-form-step" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">æ³¨å†Œåçš„æœ‰æ•ˆå¤©æ•°</label>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="selectDuration(30)" class="dur-btn px-3 py-2 border rounded-lg text-sm bg-indigo-50 border-indigo-500 text-indigo-600 font-bold">30 å¤©</button>
                    <button onclick="selectDuration(90)" class="dur-btn px-3 py-2 border border-gray-200 dark:border-gray-600 rounded-lg text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/20">90 å¤©</button>
                    <button onclick="selectDuration(-1)" class="dur-btn px-3 py-2 border border-gray-200 dark:border-gray-600 rounded-lg text-sm hover:bg-indigo-50 col-span-3">æ°¸ä¹…æœ‰æ•ˆ</button>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">æ³¨å†Œåçš„æƒé™æ¨¡æ¿</label>
                <select id="invite-template" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 outline-none"></select>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeInviteModal()" class="px-4 py-2 text-gray-500 font-medium">å–æ¶ˆ</button>
                <button onclick="generateInvite()" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-bold shadow-sm">ç«‹å³ç”Ÿæˆ</button>
            </div>
        </div>

        <div id="invite-result-step" class="hidden text-center space-y-4">
            <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-full inline-flex items-center justify-center mb-2">
                <i class="fa-solid fa-check text-3xl text-green-500"></i>
            </div>
            <h4 class="text-lg font-bold text-gray-900 dark:text-white">é‚€è¯·é“¾æ¥ç”ŸæˆæˆåŠŸ</h4>
            <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg break-all font-mono text-sm text-gray-600 dark:text-gray-300 select-all border border-gray-100" id="invite-link-box"></div>
            <div class="flex justify-center gap-3 mt-6">
                <button onclick="closeInviteModal()" class="px-6 py-2 text-gray-500 font-medium">å®Œæˆ</button>
                <button onclick="copyInvite()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg flex items-center gap-2 font-bold shadow-sm">
                    <i class="fa-regular fa-copy"></i> å¤åˆ¶é“¾æ¥
                </button>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * å…¨å±€å˜é‡å®šä¹‰
 */
let users = [];
let allLibraries = []; 
let selectedDuration = 30; 
let currentAvatarUrl = "";
let currentAvatarFile = null;
// ğŸ”¥ é‡è¦ï¼šå­˜å‚¨å½“å‰ç¼–è¾‘ç”¨æˆ·çš„å­æ–‡ä»¶å¤¹é»‘åå•æ•°æ® (å®ç°é•œåƒå¥—ç”¨åŠä¿å­˜)
let currentExcludedSubFolders = []; 

/**
 * é¡µé¢åˆå§‹åŒ–
 */
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    loadLibraries();
});

/**
 * åŠ è½½æ‰€æœ‰å¯ç”¨åª’ä½“åº“ (å‰ç«¯ ID å·²å¯¹é½ä¸º 32ä½ GUID)
 */
async function loadLibraries() {
    try {
        const res = await fetch('/api/manage/libraries');
        const json = await res.json();
        if (json.status === 'success') {
            allLibraries = json.data;
        }
    } catch (err) {
        console.error("Fetch libraries error:", err);
    }
}

/**
 * åŠ è½½å¹¶æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
 */
async function loadUsers() {
    try {
        const res = await fetch('/api/manage/users');
        const json = await res.json();
        if (json.status === 'success') {
            users = json.data;
            renderUsers();
        }
    } catch (err) {
        console.error("Fetch users error:", err);
    }
}

/**
 * ä¸‹æ‹‰æ¡†æ¨¡æ¿å¡«å……
 */
function populateTemplates(selectId, excludeUserId = null) {
    const sel = document.getElementById(selectId);
    sel.innerHTML = '<option value="">æ— æ¨¡æ¿ (é»˜è®¤å¼€é€šå…¨éƒ¨åº“)</option>';
    
    for (let i = 0; i < users.length; i++) {
        let u = users[i];
        if (excludeUserId && u.Id === excludeUserId) continue;
        
        let opt = document.createElement('option');
        opt.value = u.Id;
        opt.textContent = "ğŸ‘¤ " + u.Name;
        sel.appendChild(opt);
    }
}

/**
 * æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨ (æ¡Œé¢ç«¯ä¸ç§»åŠ¨ç«¯)
 */
function renderUsers() {
    const desktopBody = document.getElementById('user-list-body-desktop');
    const mobileBody = document.getElementById('user-list-body-mobile');
    
    // åˆå§‹åŒ– HTML å†…å®¹
    let desktopHtml = "";
    let mobileHtml = "";

    for (let i = 0; i < users.length; i++) {
        let u = users[i];
        
        // å¤´åƒ HTML å¤„ç†
        const proxyUrl = "/api/user/image/" + u.Id + "?v=" + (u.PrimaryImageTag || Date.now());
        let avatarTag = "";
        if (u.PrimaryImageTag) {
            avatarTag = `
                <div class="relative w-10 h-10">
                    <img src="${proxyUrl}" class="w-full h-full rounded-full object-cover absolute inset-0" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <div class="w-full h-full rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center text-indigo-600 font-bold hidden">
                        ${u.Name[0].toUpperCase()}
                    </div>
                </div>
            `;
        } else {
            avatarTag = `
                <div class="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center text-indigo-600 font-bold">
                    ${u.Name[0].toUpperCase()}
                </div>
            `;
        }

        // çŠ¶æ€ Label
        const statusLabel = u.IsDisabled 
            ? '<span class="px-2 py-1 rounded-full text-xs bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400">å·²ç¦ç”¨</span>'
            : '<span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">æ­£å¸¸æ´»è·ƒ</span>';

        // æ¡Œé¢è¡Œ
        desktopHtml += `
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/30 transition-colors">
                <td class="px-6 py-4">
                    <div class="flex items-center gap-3">
                        ${avatarTag}
                        <div>
                            <div class="font-medium text-gray-900 dark:text-white">${u.Name}</div>
                            ${u.IsAdmin ? '<span class="text-[10px] bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded">è¶…çº§ç®¡ç†</span>' : ''}
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4">${statusLabel}</td>
                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">${u.ExpireDate || 'æ°¸ä¹…æœ‰æ•ˆ'}</td>
                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">${u.LastLoginDate ? new Date(u.LastLoginDate).toLocaleDateString() : 'å°šæœªç™»å½•è¿‡'}</td>
                <td class="px-6 py-4 text-right">
                    <button onclick="openEditUserModal('${u.Id}')" class="text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 font-medium">ç®¡ç†</button>
                    <button onclick="deleteUser('${u.Id}')" class="text-red-500 hover:text-red-700 ml-3">æ³¨é”€</button>
                </td>
            </tr>
        `;

        // ç§»åŠ¨ç«¯å¡ç‰‡
        mobileHtml += `
            <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-100 dark:border-gray-700 shadow-sm">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center gap-3">
                        ${avatarTag}
                        <div>
                            <div class="font-bold text-gray-900 dark:text-white">${u.Name}</div>
                            <div class="text-[10px] text-gray-400">ä¸Šæ¬¡ç™»å½•: ${u.LastLoginDate ? new Date(u.LastLoginDate).toLocaleDateString() : 'ä»æœª'}</div>
                        </div>
                    </div>
                    ${statusLabel}
                </div>
                <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-700/30 p-2 rounded-lg mb-3">
                    <span class="text-xs text-gray-500">æœ‰æ•ˆæœŸè‡³</span>
                    <span class="text-xs font-mono font-bold">${u.ExpireDate || 'æ°¸ä¹…'}</span>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="openEditUserModal('${u.Id}')" class="flex items-center justify-center gap-1 py-2 text-sm font-medium text-indigo-600 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg">ç¼–è¾‘</button>
                    <button onclick="deleteUser('${u.Id}')" class="flex items-center justify-center gap-1 py-2 text-sm font-medium text-red-600 bg-red-50 dark:bg-red-900/20 rounded-lg">åˆ é™¤</button>
                </div>
            </div>
        `;
    }
    
    desktopBody.innerHTML = desktopHtml;
    mobileBody.innerHTML = mobileHtml;
}

/**
 * æ ‡ç­¾é¡µåˆ‡æ¢
 */
function switchEditTab(tabName) {
    const isBasic = (tabName === 'basic');
    document.getElementById('edit-tab-basic').style.display = isBasic ? 'block' : 'none';
    document.getElementById('edit-tab-library').style.display = isBasic ? 'none' : 'block';
    
    const btnBasic = document.getElementById('tab-btn-basic');
    const btnLib = document.getElementById('tab-btn-library');
    
    if (isBasic) {
        btnBasic.className = "pb-2 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 dark:text-indigo-400 dark:border-indigo-400 transition-colors";
        btnLib.className = "pb-2 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 transition-colors";
    } else {
        btnLib.className = "pb-2 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 dark:text-indigo-400 dark:border-indigo-400 transition-colors";
        btnBasic.className = "pb-2 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 transition-colors";
    }
}

/**
 * æ‰“å¼€ç¼–è¾‘å¼¹çª— (å®æ—¶åŠ è½½æœ€æ–° GUID å’Œ é»‘åå•æ•°æ®)
 */
async function openEditUserModal(uid) {
    const user = users.find(u => u.Id === uid);
    if (!user) return;
    
    switchEditTab('basic');

    // å¡«å……åŸºç¡€å­—æ®µ
    document.getElementById('edit-userid').value = uid;
    document.getElementById('edit-username').value = user.Name;
    document.getElementById('edit-disabled').value = String(user.IsDisabled);
    document.getElementById('edit-expire').value = user.ExpireDate || '';
    document.getElementById('edit-password').value = ''; 
    
    currentAvatarUrl = ""; 
    currentAvatarFile = null;
    
    const preview = document.getElementById('edit-avatar-preview');
    if (user.PrimaryImageTag) {
        preview.src = "/api/user/image/" + uid + "?t=" + Date.now();
    } else {
        preview.src = "https://api.dicebear.com/9.x/notionists/png?seed=" + user.Name;
    }
    
    // æ˜¾ç¤ºå¼¹çª—
    const modal = document.getElementById('edit-user-modal');
    modal.classList.remove('hidden');
    setTimeout(() => { modal.classList.add('flex'); }, 10);

    // ğŸ”¥ æ ¸å¿ƒé€»è¾‘ï¼šä»åç«¯é‡æ–°è¯·æ±‚è¯¥ç”¨æˆ·çš„å®Œæ•´ã€å®æ—¶æƒé™çŠ¶æ€ (åŒ…æ‹¬ ExcludedSubFolders)
    try {
        const res = await fetch("/api/manage/user/" + uid);
        const json = await res.json();
        if (json.status === 'success') {
            user.EnableAllFolders = json.data.EnableAllFolders;
            user.EnabledFolders = json.data.EnabledFolders;
            // è®°å½•å½“å‰çš„é»‘åå•æ•°æ®
            currentExcludedSubFolders = json.data.ExcludedSubFolders || [];
        }
    } catch (err) {
        console.error("Sync user data failed:", err);
    }
    
    renderLibraryCheckboxes(user);
    populateTemplates('edit-template-select', uid);
}

/**
 * æ¸²æŸ“åª’ä½“åº“å¤é€‰æ¡†
 */
function renderLibraryCheckboxes(user) {
    const container = document.getElementById('edit-library-list');
    container.innerHTML = "";
    
    if (allLibraries.length === 0) {
        container.innerHTML = `<div class="col-span-2 text-sm text-gray-500 p-2 italic">æœªè·å–åˆ°åª’ä½“åº“ï¼Œè¯·ç‚¹å‡»è®¾ç½®æ£€æµ‹æœåŠ¡å™¨...</div>`;
    } else {
        for (let i = 0; i < allLibraries.length; i++) {
            let lib = allLibraries[i];
            let isChecked = user.EnabledFolders.includes(lib.Id) ? 'checked' : '';
            
            let label = document.createElement('label');
            label.className = "flex items-center gap-3 p-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:border-indigo-300 transition";
            label.innerHTML = `
                <input type="checkbox" value="${lib.Id}" class="lib-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300 dark:border-gray-600 dark:bg-gray-700" ${isChecked}>
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300 truncate">${lib.Name}</span>
            `;
            container.appendChild(label);
        }
    }
    document.getElementById('edit-enable-all').checked = user.EnableAllFolders;
    toggleLibraryCheckboxes();
}

/**
 * å‹¾é€‰â€œå…¨éƒ¨åª’ä½“åº“â€æ—¶çš„ç¦ç”¨é€»è¾‘
 */
function toggleLibraryCheckboxes() {
    const isAll = document.getElementById('edit-enable-all').checked;
    const container = document.getElementById('edit-library-list');
    const boxes = document.querySelectorAll('.lib-checkbox');
    
    for (let i = 0; i < boxes.length; i++) {
        boxes[i].disabled = isAll;
    }
    container.style.opacity = isAll ? '0.4' : '1';
    container.style.pointerEvents = isAll ? 'none' : 'auto';
}

/**
 * ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šé‡ç½®å­æ–‡ä»¶å¤¹é»‘åå•é€»è¾‘
 */
function clearSubFolders() {
    if (!confirm('ç¡®å®šè¦é‡ç½®å—ï¼Ÿè¿™å°†æ¸…ç©ºè¯¥ç”¨æˆ·å·²å‹¾é€‰åº“ä¸­æ‰€æœ‰çš„â€œéšè—å­ç›®å½•â€ï¼Œä½¿å…¶æ¢å¤å…¨é‡å¯è§ï¼ˆå³è®©æ‰€æœ‰æ–‡ä»¶å¤¹æ‰“å‹¾ï¼‰ã€‚')) {
        return;
    }
    
    // æ¸…ç©ºæœ¬åœ°å­˜å‚¨çš„é»‘åå•å˜é‡
    currentExcludedSubFolders = [];
    
    const btn = document.getElementById('clear-sub-btn');
    btn.innerHTML = '<i class="fa-solid fa-check mr-1"></i> å·²é‡ç½®é»‘åå•ï¼ˆä¿å­˜åç”Ÿæ•ˆï¼‰';
    btn.classList.remove('text-indigo-500');
    btn.classList.add('text-green-500', 'font-bold');
}

/**
 * ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šé•œåƒåŒæ­¥å¥—ç”¨æ¨¡æ¿
 */
async function applyEditTemplate() {
    const tid = document.getElementById('edit-template-select').value;
    if (!tid) return;
    
    const btn = document.getElementById('apply-template-btn');
    const oldHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
    btn.disabled = true;

    try {
        // è¯·æ±‚æ¨¡æ¿ç”¨æˆ·çš„çœŸå®æƒé™æ•°æ®
        const res = await fetch("/api/manage/user/" + tid);
        const json = await res.json();
        
        if (json.status === 'success') {
            const tData = json.data;
            
            // 1. åŒæ­¥å¤§ç±»å¼€å…³
            document.getElementById('edit-enable-all').checked = tData.EnableAllFolders;
            
            // 2. åŒæ­¥å¤§ç±»å‹¾é€‰ (GUID å¯¹ GUID)
            const boxes = document.querySelectorAll('.lib-checkbox');
            for (let i = 0; i < boxes.length; i++) {
                boxes[i].checked = tData.EnabledFolders.includes(boxes[i].value);
            }
            
            // 3. ğŸ”¥ é‡è¦ï¼šé•œåƒåŒæ­¥å­æ–‡ä»¶å¤¹é»‘åå•
            currentExcludedSubFolders = tData.ExcludedSubFolders || [];
            
            toggleLibraryCheckboxes();
            
            btn.innerHTML = '<i class="fa-solid fa-check"></i> å·²å®Œå…¨é•œåƒ';
            btn.classList.add('bg-green-600');
        } else {
            alert('è·å–æ¨¡æ¿æƒé™å¤±è´¥');
        }
    } catch(err) {
        console.error(err);
    }

    setTimeout(() => { 
        btn.innerHTML = oldHtml; 
        btn.classList.remove('bg-green-600');
        btn.disabled = false;
    }, 1500);
}

/**
 * æäº¤ç¼–è¾‘å†…å®¹
 */
async function submitEditUser() {
    const btn = document.getElementById('save-user-btn');
    const uid = document.getElementById('edit-userid').value;
    const isDisable = (document.getElementById('edit-disabled').value === "true");
    const expireDate = document.getElementById('edit-expire').value;
    const newPass = document.getElementById('edit-password').value;
    const enableAll = document.getElementById('edit-enable-all').checked;
    
    // æ•´ç†å·²å‹¾é€‰çš„ GUID åˆ—è¡¨
    const boxes = document.querySelectorAll('.lib-checkbox');
    let checkedLibs = [];
    if (!enableAll) {
        for (let i = 0; i < boxes.length; i++) {
            if (boxes[i].checked) checkedLibs.push(boxes[i].value);
        }
    }
    
    btn.disabled = true;
    document.getElementById('save-user-text').textContent = "æ­£åœ¨ä¿å­˜å˜æ›´...";

    // å¦‚æœæœ‰å¤´åƒå˜åŠ¨ï¼Œå…ˆå¤„ç†å¤´åƒ
    if (currentAvatarUrl || currentAvatarFile) {
        const fd = new FormData();
        fd.append('user_id', uid);
        if (currentAvatarFile) fd.append('file', currentAvatarFile);
        else fd.append('url', currentAvatarUrl);
        
        try {
            await fetch('/api/manage/user/image', { method: 'POST', body: fd });
        } catch (err) {
            console.error("Avatar update fail:", err);
        }
    }
    
    // å‘é€æœ€ç»ˆçš„ Policy å’Œèµ„æ–™æ›´æ–°
    try {
        const res = await fetch('/api/manage/user/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                user_id: uid, 
                is_disabled: isDisable, 
                expire_date: expireDate || "", 
                password: newPass || null,
                enable_all_folders: enableAll,
                enabled_folders: checkedLibs,
                // ğŸ”¥ å…³é”®ï¼šæäº¤æ—¶åŒ…å«å­æ–‡ä»¶å¤¹æ’é™¤é¡¹ (å®ç°é•œåƒä¿å­˜)
                excluded_sub_folders: currentExcludedSubFolders 
            })
        });
        
        const result = await res.json();
        if (result.status === 'success') {
            closeEditUserModal();
            loadUsers();
        } else {
            alert(result.message || "æ›´æ–°å¤±è´¥");
        }
    } catch (err) {
        alert("ç½‘ç»œè¿æ¥é”™è¯¯");
    } finally {
        btn.disabled = false;
        document.getElementById('save-user-text').textContent = "ä¿å­˜ä¿®æ”¹";
    }
}

/**
 * è¾…åŠ©é€»è¾‘ï¼šå¤´åƒéšæœºã€æ–‡ä»¶é¢„è§ˆã€å…³é—­å¼¹çª—ã€æ³¨é”€ç”¨æˆ·
 */
function closeEditUserModal() {
    const modal = document.getElementById('edit-user-modal');
    modal.classList.remove('flex');
    modal.classList.add('hidden');
}

function openInviteModal() {
    const modal = document.getElementById('invite-modal');
    modal.classList.remove('hidden');
    document.getElementById('invite-form-step').classList.remove('hidden');
    document.getElementById('invite-result-step').classList.add('hidden');
    selectDuration(30);
    populateTemplates('invite-template');
    setTimeout(() => { modal.classList.add('flex'); }, 10);
}

function closeInviteModal() {
    const modal = document.getElementById('invite-modal');
    modal.classList.remove('flex');
    modal.classList.add('hidden');
}

function selectDuration(days) {
    selectedDuration = days;
    const btns = document.querySelectorAll('.dur-btn');
    btns.forEach(b => {
        b.className = "dur-btn px-3 py-2 border border-gray-200 dark:border-gray-600 rounded-lg text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/20 dark:text-gray-300";
    });
    // ç²—ç•¥å¯»æ‰¾åŒ¹é…æŒ‰é’®å¹¶è®¾ä¸ºé€‰ä¸­æ ·å¼
    const target = Array.from(btns).find(b => b.getAttribute('onclick').includes("(" + days + ")"));
    if (target) {
        target.className = "dur-btn px-3 py-2 border border-indigo-500 rounded-lg text-sm bg-indigo-50 text-indigo-600 font-bold";
    }
}

async function generateInvite() {
    const tid = document.getElementById('invite-template').value;
    try {
        const res = await fetch('/api/manage/invite/gen', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ days: selectedDuration, template_user_id: tid || null }) 
        });
        const json = await res.json();
        if (json.status === 'success') {
            document.getElementById('invite-link-box').textContent = window.location.origin + '/invite/' + json.code;
            document.getElementById('invite-form-step').classList.add('hidden');
            document.getElementById('invite-result-step').classList.remove('hidden');
        }
    } catch(err) { alert("ç”Ÿæˆå¤±è´¥"); }
}

function copyInvite() {
    const txt = document.getElementById('invite-link-box').textContent;
    navigator.clipboard.writeText(txt).then(() => alert('âœ… é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'));
}

function openNewUserModal() { 
    const modal = document.getElementById('new-user-modal');
    modal.classList.remove('hidden');
    document.getElementById('new-username').value = '';
    document.getElementById('new-password').value = '';
    document.getElementById('new-expire').value = '';
    populateTemplates('new-template');
    setTimeout(() => { modal.classList.add('flex'); }, 10);
}

function closeNewUserModal() { 
    const modal = document.getElementById('new-user-modal');
    modal.classList.remove('flex');
    modal.classList.add('hidden');
}

async function submitNewUser() {
    const name = document.getElementById('new-username').value;
    const pass = document.getElementById('new-password').value; 
    const expire = document.getElementById('new-expire').value;
    const tid = document.getElementById('new-template').value;
    if (!name) return alert("ç”¨æˆ·åæ˜¯å¿…å¡«é¡¹");
    
    try {
        const res = await fetch('/api/manage/user/new', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name: name, password: pass, expire_date: expire || null, template_user_id: tid || null })
        });
        const json = await res.json();
        if (json.status === 'success') {
            closeNewUserModal();
            loadUsers();
        } else { alert(json.message); }
    } catch(err) { alert("åˆ›å»ºè¯·æ±‚å¤±è´¥"); }
}

function generateRandomAvatar() {
    const style = ['micah', 'bottts', 'avataaars', 'notionists', 'lorelei'][Math.floor(Math.random() * 5)];
    const seed = Math.random().toString(36).substring(7);
    currentAvatarUrl = "https://api.dicebear.com/9.x/" + style + "/png?seed=" + seed;
    currentAvatarFile = null;
    document.getElementById('edit-avatar-preview').src = currentAvatarUrl;
}

function setAvatarPreset(style) {
    const seed = Math.random().toString(36).substring(7);
    currentAvatarUrl = "https://api.dicebear.com/9.x/" + style + "/png?seed=" + seed;
    currentAvatarFile = null;
    document.getElementById('edit-avatar-preview').src = currentAvatarUrl;
}

function previewFileAvatar() {
    const file = document.getElementById('edit-avatar-file').files[0];
    if (file) {
        currentAvatarFile = file;
        currentAvatarUrl = "";
        const reader = new FileReader();
        reader.onload = function(e) { document.getElementById('edit-avatar-preview').src = e.target.result; };
        reader.readAsDataURL(file);
    }
}

async function deleteUser(uid) {
    if (!confirm('å±é™©æ“ä½œï¼šç¡®å®šè¦å½»åº•æ³¨é”€å¹¶åˆ é™¤è¯¥ç”¨æˆ·å—ï¼Ÿ')) return;
    try {
        const res = await fetch("/api/manage/user/" + uid, { method: 'DELETE' });
        const json = await res.json();
        if (json.status === 'success') {
            loadUsers();
        }
    } catch(err) { alert("ç½‘ç»œé”™è¯¯"); }
}
</script>

<style>
.custom-scrollbar::-webkit-scrollbar { width: 5px; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
.dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #4a5568; }
</style>
{% endblock %}