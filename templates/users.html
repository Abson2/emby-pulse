{% extends "layout.html" %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
        <h1 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center gap-3">
            <i class="fa-solid fa-users text-indigo-500"></i>
            ç”¨æˆ·ç®¡ç†
        </h1>
        <div class="flex gap-2">
            <button onclick="openInviteModal()" class="flex items-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg transition shadow-sm font-medium">
                <i class="fa-solid fa-link"></i> é‚€è¯·é“¾æ¥
            </button>
            <button onclick="openNewUserModal()" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition shadow-sm font-medium">
                <i class="fa-solid fa-user-plus"></i> æ–°å»ºç”¨æˆ·
            </button>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-gray-600 dark:text-gray-300">
                <thead class="bg-gray-50 dark:bg-gray-700/50 text-gray-900 dark:text-gray-100 font-medium border-b border-gray-100 dark:border-gray-700">
                    <tr>
                        <th class="px-6 py-4">ç”¨æˆ·</th>
                        <th class="px-6 py-4">çŠ¶æ€</th>
                        <th class="px-6 py-4">æœ‰æ•ˆæœŸè‡³</th>
                        <th class="px-6 py-4">æœ€åç™»å½•</th>
                        <th class="px-6 py-4 text-right">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700" id="user-list-body">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div id="new-user-modal" class="fixed inset-0 z-50 hidden items-center justify-center h-screen w-screen bg-black/50 backdrop-blur-sm px-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">æ–°å»ºç”¨æˆ·</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ç”¨æˆ·å</label>
                <input type="text" id="new-username" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">å¯†ç  (å¯é€‰)</label>
                <input type="password" id="new-password" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ç•™ç©ºåˆ™æ— å¯†ç ">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æœ‰æ•ˆæœŸ (ç•™ç©ºä¸ºæ°¸ä¹…)</label>
                <input type="date" id="new-expire" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeNewUserModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">å–æ¶ˆ</button>
                <button onclick="submitNewUser()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg">åˆ›å»º</button>
            </div>
        </div>
    </div>
</div>

<div id="edit-user-modal" class="fixed inset-0 z-50 hidden items-center justify-center h-screen w-screen bg-black/50 backdrop-blur-sm px-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">ç¼–è¾‘ç”¨æˆ·</h3>
        <input type="hidden" id="edit-userid">
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">å½“å‰ç”¨æˆ·</label>
                <input type="text" id="edit-username" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-100 dark:bg-gray-900/50 text-gray-500 cursor-not-allowed" disabled>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">é‡ç½®å¯†ç  (å¯é€‰)</label>
                <input type="password" id="edit-password" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹å¯†ç ">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">è´¦å·çŠ¶æ€</label>
                <select id="edit-disabled" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="false">âœ… æ­£å¸¸å¯ç”¨</option>
                    <option value="true">ğŸš« ç¦ç”¨è´¦å·</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æœ‰æ•ˆæœŸ (ç•™ç©ºä¸ºæ°¸ä¹…)</label>
                <input type="date" id="edit-expire" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeEditUserModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">å–æ¶ˆ</button>
                <button onclick="submitEditUser()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>
</div>

<div id="invite-modal" class="fixed inset-0 z-50 hidden items-center justify-center h-screen w-screen bg-black/50 backdrop-blur-sm px-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">ç”Ÿæˆé‚€è¯·é“¾æ¥</h3>
        <div class="space-y-4" id="invite-form-step">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">è´¦å·æœ‰æ•ˆæœŸ (åˆ°æœŸè‡ªåŠ¨ç¦ç”¨)</label>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="selectDuration(1)" class="dur-btn px-3 py-2 border rounded-lg text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/30 border-gray-200 dark:border-gray-600">1 å¤©</button>
                    <button onclick="selectDuration(7)" class="dur-btn px-3 py-2 border rounded-lg text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/30 border-gray-200 dark:border-gray-600">7 å¤©</button>
                    <button onclick="selectDuration(30)" class="dur-btn px-3 py-2 border rounded-lg text-sm bg-indigo-50 border-indigo-500 text-indigo-600 dark:bg-indigo-900/50 dark:text-indigo-300">30 å¤©</button>
                    <button onclick="selectDuration(90)" class="dur-btn px-3 py-2 border rounded-lg text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/30 border-gray-200 dark:border-gray-600">3 ä¸ªæœˆ</button>
                    <button onclick="selectDuration(180)" class="dur-btn px-3 py-2 border rounded-lg text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/30 border-gray-200 dark:border-gray-600">6 ä¸ªæœˆ</button>
                    <button onclick="selectDuration(365)" class="dur-btn px-3 py-2 border rounded-lg text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/30 border-gray-200 dark:border-gray-600">12 ä¸ªæœˆ</button>
                    <button onclick="selectDuration(-1)" class="dur-btn px-3 py-2 border rounded-lg text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/30 border-gray-200 dark:border-gray-600 col-span-3">æ°¸ä¹…æœ‰æ•ˆ</button>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeInviteModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">å–æ¶ˆ</button>
                <button onclick="generateInvite()" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg">ç”Ÿæˆé“¾æ¥</button>
            </div>
        </div>

        <div id="invite-result-step" class="hidden text-center space-y-4">
            <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-full inline-flex items-center justify-center mb-2">
                <i class="fa-solid fa-check text-3xl text-green-500"></i>
            </div>
            <h4 class="text-lg font-bold text-gray-900 dark:text-white">é“¾æ¥å·²ç”Ÿæˆ</h4>
            <p class="text-sm text-gray-500 dark:text-gray-400">å°†ä¸‹æ–¹é“¾æ¥å‘é€ç»™å¥½å‹ï¼Œå³å¯é‚€è¯·æ³¨å†Œã€‚</p>
            
            <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg break-all font-mono text-sm text-gray-600 dark:text-gray-300 select-all border border-gray-100 dark:border-gray-700" id="invite-link-box">...</div>
            <div class="flex justify-center gap-3 mt-6">
                <button onclick="closeInviteModal()" class="px-6 py-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">å®Œæˆ</button>
                <button onclick="copyInvite()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg flex items-center gap-2">
                    <i class="fa-regular fa-copy"></i> å¤åˆ¶é“¾æ¥
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let users = [];
let selectedDuration = 30; 

document.addEventListener('DOMContentLoaded', loadUsers);

async function loadUsers() {
    const res = await fetch('/api/manage/users');
    const json = await res.json();
    if (json.status === 'success') {
        users = json.data;
        renderUsers();
    }
}

function renderUsers() {
    const tbody = document.getElementById('user-list-body');
    tbody.innerHTML = users.map(u => `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/30 transition-colors">
            <td class="px-6 py-4">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center text-indigo-600 dark:text-indigo-300 font-bold">
                        ${u.Name[0].toUpperCase()}
                    </div>
                    <div>
                        <div class="font-medium text-gray-900 dark:text-white">${u.Name}</div>
                        ${u.IsAdmin ? '<span class="text-[10px] bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded">ç®¡ç†å‘˜</span>' : ''}
                    </div>
                </div>
            </td>
            <td class="px-6 py-4">
                ${u.IsDisabled 
                    ? '<span class="px-2 py-1 rounded-full text-xs bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400">å·²ç¦ç”¨</span>' 
                    : '<span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">æ­£å¸¸</span>'}
            </td>
            <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
                ${u.ExpireDate || 'æ°¸ä¹…'}
            </td>
            <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
                ${u.LastLoginDate ? new Date(u.LastLoginDate).toLocaleDateString() : 'ä»æœª'}
            </td>
            <td class="px-6 py-4 text-right space-x-2">
                <button onclick="openEditUserModal('${u.Id}')" class="text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300 text-sm">ç¼–è¾‘</button>
                <button onclick="deleteUser('${u.Id}')" class="text-red-500 hover:text-red-700 text-sm">åˆ é™¤</button>
            </td>
        </tr>
    `).join('');
}

// --- é‚€è¯·ç›¸å…³ ---
function openInviteModal() {
    const modal = document.getElementById('invite-modal');
    modal.classList.remove('hidden');
    document.getElementById('invite-form-step').classList.remove('hidden');
    document.getElementById('invite-result-step').classList.add('hidden');
    selectDuration(30);
    setTimeout(() => { modal.classList.add('flex'); }, 10);
}

function closeInviteModal() {
    const modal = document.getElementById('invite-modal');
    modal.classList.remove('flex');
    modal.classList.add('hidden');
}

function selectDuration(days) {
    selectedDuration = days;
    document.querySelectorAll('.dur-btn').forEach(btn => {
        btn.classList.remove('bg-indigo-50', 'border-indigo-500', 'text-indigo-600', 'dark:bg-indigo-900/50', 'dark:text-indigo-300');
        btn.classList.add('border-gray-200', 'dark:border-gray-600');
    });
    const btns = document.querySelectorAll('.dur-btn');
    for (let btn of btns) {
        if (btn.getAttribute('onclick').includes(`selectDuration(${days})`)) {
            btn.classList.remove('border-gray-200', 'dark:border-gray-600');
            btn.classList.add('bg-indigo-50', 'border-indigo-500', 'text-indigo-600', 'dark:bg-indigo-900/50', 'dark:text-indigo-300');
            break;
        }
    }
}

async function generateInvite() {
    const res = await fetch('/api/manage/invite/gen', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ days: selectedDuration })
    });
    const json = await res.json();
    if (json.status === 'success') {
        const link = window.location.origin + '/invite/' + json.code;
        document.getElementById('invite-link-box').textContent = link;
        document.getElementById('invite-form-step').classList.add('hidden');
        document.getElementById('invite-result-step').classList.remove('hidden');
    } else {
        alert('ç”Ÿæˆå¤±è´¥: ' + json.message);
    }
}

function copyInvite() {
    const text = document.getElementById('invite-link-box').textContent;
    navigator.clipboard.writeText(text).then(() => alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'));
}

// --- æ–°å»ºç”¨æˆ·ç›¸å…³ ---
function openNewUserModal() { 
    const modal = document.getElementById('new-user-modal');
    modal.classList.remove('hidden');
    // æ¸…ç©ºè¾“å…¥æ¡†
    document.getElementById('new-username').value = '';
    document.getElementById('new-password').value = '';
    document.getElementById('new-expire').value = '';
    setTimeout(() => { modal.classList.add('flex'); }, 10);
}
function closeNewUserModal() { 
    const modal = document.getElementById('new-user-modal');
    modal.classList.remove('flex');
    modal.classList.add('hidden');
}

async function submitNewUser() {
    const name = document.getElementById('new-username').value;
    const pass = document.getElementById('new-password').value; 
    const expire = document.getElementById('new-expire').value;
    if (!name) return alert("è¯·è¾“å…¥ç”¨æˆ·å");
    
    const res = await fetch('/api/manage/user/new', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ name, password: pass, expire_date: expire || null })
    });
    const json = await res.json();
    if (json.status === 'success') {
        alert(json.message);
        closeNewUserModal();
        loadUsers();
    } else {
        alert(json.message);
    }
}

// --- ğŸ”¥ ç¼–è¾‘ç”¨æˆ·ç›¸å…³ ---
function openEditUserModal(uid) {
    const user = users.find(u => u.Id === uid);
    if(!user) return;
    
    document.getElementById('edit-userid').value = uid;
    document.getElementById('edit-username').value = user.Name;
    document.getElementById('edit-disabled').value = user.IsDisabled ? "true" : "false";
    document.getElementById('edit-expire').value = user.ExpireDate || '';
    document.getElementById('edit-password').value = ''; // é‡ç½®å¯†ç æ¡†
    
    const modal = document.getElementById('edit-user-modal');
    modal.classList.remove('hidden');
    setTimeout(() => { modal.classList.add('flex'); }, 10);
}

function closeEditUserModal() {
    const modal = document.getElementById('edit-user-modal');
    modal.classList.remove('flex');
    modal.classList.add('hidden');
}

async function submitEditUser() {
    const uid = document.getElementById('edit-userid').value;
    const isDisabled = document.getElementById('edit-disabled').value === "true";
    const expire = document.getElementById('edit-expire').value;
    const pass = document.getElementById('edit-password').value; // è·å–å¯†ç 
    
    const res = await fetch('/api/manage/user/update', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
            user_id: uid, 
            is_disabled: isDisabled,
            expire_date: expire || "",
            password: pass || null // å¦‚æœä¸ºç©ºï¼Œä¼ null
        })
    });
    
    const json = await res.json();
    if (json.status === 'success') {
        alert(json.message);
        closeEditUserModal();
        loadUsers();
    } else {
        alert(json.message);
    }
}

async function deleteUser(uid) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç”¨æˆ·å—ï¼Ÿæ“ä½œä¸å¯æ¢å¤ï¼')) return;
    const res = await fetch(`/api/manage/user/${uid}`, { method: 'DELETE' });
    const json = await res.json();
    if (json.status === 'success') loadUsers();
    else alert(json.message);
}
</script>
{% endblock %}