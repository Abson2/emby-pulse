{% extends "layout.html" %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-4xl">
    <div class="flex items-center gap-3 mb-6">
        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">ç³»ç»Ÿè®¾ç½®</h1>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6 mb-6">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            <i class="fa-solid fa-server text-indigo-500"></i> Emby è¿æ¥ (Docker å†…éƒ¨)
        </h3>
        <div class="grid md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Emby åœ°å€ (å†…ç½‘/Docker IP)</label>
                <input type="text" id="emby_host" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-900/50 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="http://172.17.0.1:8096">
                <p class="text-xs text-gray-400 mt-1">è¿™æ˜¯ EmbyPulse åç«¯è¿æ¥ Emby Server ç”¨çš„åœ°å€ã€‚</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">API Key</label>
                <input type="password" id="emby_api_key" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-900/50 focus:ring-2 focus:ring-indigo-500 outline-none">
                <div class="flex justify-between mt-1">
                    <p class="text-xs text-gray-400">åœ¨ Emby åå° -> é«˜çº§ -> API å¯†é’¥ ä¸­ç”Ÿæˆã€‚</p>
                    <button onclick="toggleShow('emby_api_key')" class="text-xs text-indigo-500 hover:text-indigo-600">æ˜¾ç¤º/éšè—</button>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6 mb-6">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            <i class="fa-solid fa-globe text-emerald-500"></i> å¯¹å¤–æœåŠ¡è®¾ç½® (æ³¨å†Œå›æ˜¾)
        </h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Emby å…¬å¼€è®¿é—®åœ°å€ (ç”¨æˆ·ä½¿ç”¨)</label>
                <input type="text" id="emby_public_url" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-900/50 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="https://emby.yourdomain.com">
                <p class="text-xs text-gray-400 mt-1">æ­¤åœ°å€å°†æ˜¾ç¤ºåœ¨ç”¨æˆ·æ³¨å†ŒæˆåŠŸåçš„â€œå…¥èŒå¡ç‰‡â€ä¸Šï¼Œæ–¹ä¾¿ç”¨æˆ·å¤åˆ¶ç™»å½•ã€‚</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">æ³¨å†Œåæç¤ºè¯­ (å¯é€‰)</label>
                <textarea id="welcome_message" rows="3" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-900/50 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="ä¾‹ï¼šæ¨èä½¿ç”¨ Infuse å®¢æˆ·ç«¯ç™»å½•ï¼Œè¯·å‹¿åˆ†äº«è´¦å·ã€‚"></textarea>
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6 mb-6">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            <i class="fa-solid fa-network-wired text-blue-500"></i> TMDB & ç½‘ç»œ
        </h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">TMDB API Key</label>
                <input type="password" id="tmdb_api_key" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-900/50 focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">HTTP ä»£ç† (Proxy)</label>
                <input type="text" id="proxy_url" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-900/50 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="http://127.0.0.1:7890">
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6 mb-6">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            <i class="fa-solid fa-shield-halved text-orange-500"></i> Webhook å®‰å…¨
        </h3>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">å®‰å…¨ä»¤ç‰Œ (Token)</label>
            <input type="text" id="webhook_token" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-900/50 focus:ring-2 focus:ring-orange-500 outline-none">
            <p class="text-xs text-gray-400 mt-2">
                Webhook URL: <span class="font-mono bg-gray-100 dark:bg-gray-900 px-1 rounded select-all" id="webhook-url-preview">...</span>
            </p>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6 mb-6">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            <i class="fa-solid fa-user-slash text-gray-500"></i> å¿½ç•¥ç”¨æˆ· (ä¸ç»Ÿè®¡)
        </h3>
        <div id="hidden-users-container" class="flex flex-wrap gap-2 mb-3">
            </div>
        <div class="flex gap-2">
            <select id="user-selector" class="flex-1 px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-900/50 outline-none">
                <option value="">é€‰æ‹©ç”¨æˆ·...</option>
            </select>
            <button onclick="addHiddenUser()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg text-sm font-medium transition">æ·»åŠ </button>
        </div>
    </div>

    <div class="flex justify-end pb-10">
        <button onclick="saveSettings()" class="px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 dark:shadow-none transition transform hover:scale-105">
            ä¿å­˜å…¨éƒ¨è®¾ç½®
        </button>
    </div>
</div>

<script>
let allUsers = [];
let hiddenUsers = [];

document.addEventListener('DOMContentLoaded', async () => {
    // 1. åŠ è½½æ‰€æœ‰ç”¨æˆ·ç”¨äºä¸‹æ‹‰æ¡†
    const uRes = await fetch('/api/users');
    const uJson = await uRes.json();
    if(uJson.status === 'success') {
        allUsers = uJson.data;
        const sel = document.getElementById('user-selector');
        allUsers.forEach(u => {
            const opt = document.createElement('option');
            opt.value = u.UserId;
            opt.textContent = u.UserName;
            sel.appendChild(opt);
        });
    }

    // 2. åŠ è½½è®¾ç½®
    loadSettings();
});

async function loadSettings() {
    const res = await fetch('/api/settings');
    const json = await res.json();
    if (json.status === 'success') {
        const d = json.data;
        document.getElementById('emby_host').value = d.emby_host || '';
        document.getElementById('emby_api_key').value = d.emby_api_key || '';
        document.getElementById('tmdb_api_key').value = d.tmdb_api_key || '';
        document.getElementById('proxy_url').value = d.proxy_url || '';
        document.getElementById('webhook_token').value = d.webhook_token || '';
        
        // ğŸ”¥ åŠ è½½æ–°å­—æ®µ
        document.getElementById('emby_public_url').value = d.emby_public_url || '';
        document.getElementById('welcome_message').value = d.welcome_message || '';

        hiddenUsers = d.hidden_users || [];
        renderHiddenUsers();
        updateWebhookPreview();
    }
}

function renderHiddenUsers() {
    const container = document.getElementById('hidden-users-container');
    container.innerHTML = '';
    hiddenUsers.forEach(uid => {
        const user = allUsers.find(u => u.UserId === uid);
        const name = user ? user.UserName : uid;
        
        const tag = document.createElement('div');
        tag.className = 'flex items-center gap-2 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm text-gray-700 dark:text-gray-300';
        tag.innerHTML = `
            <span>${name}</span>
            <button onclick="removeHiddenUser('${uid}')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
        `;
        container.appendChild(tag);
    });
}

function addHiddenUser() {
    const sel = document.getElementById('user-selector');
    const uid = sel.value;
    if (uid && !hiddenUsers.includes(uid)) {
        hiddenUsers.push(uid);
        renderHiddenUsers();
    }
    sel.value = '';
}

function removeHiddenUser(uid) {
    hiddenUsers = hiddenUsers.filter(id => id !== uid);
    renderHiddenUsers();
}

function updateWebhookPreview() {
    const token = document.getElementById('webhook_token').value;
    const host = window.location.origin;
    document.getElementById('webhook-url-preview').textContent = `${host}/api/v1/webhook?token=${token}`;
}

document.getElementById('webhook_token').addEventListener('input', updateWebhookPreview);

async function saveSettings() {
    const data = {
        emby_host: document.getElementById('emby_host').value,
        emby_api_key: document.getElementById('emby_api_key').value,
        tmdb_api_key: document.getElementById('tmdb_api_key').value,
        proxy_url: document.getElementById('proxy_url').value,
        webhook_token: document.getElementById('webhook_token').value,
        hidden_users: hiddenUsers,
        // ğŸ”¥ ä¿å­˜æ–°å­—æ®µ
        emby_public_url: document.getElementById('emby_public_url').value,
        welcome_message: document.getElementById('welcome_message').value
    };

    const res = await fetch('/api/settings', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    const json = await res.json();
    alert(json.message);
}

function toggleShow(id) {
    const input = document.getElementById(id);
    input.type = input.type === 'password' ? 'text' : 'password';
}
</script>
{% endblock %}