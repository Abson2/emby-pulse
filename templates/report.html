{% extends "layout.html" %}
{% block title %}æ˜ è¿¹å·¥åŠ - EmbyPulse{% endblock %}
{% block head %}
<style>
    /* ================= å®¹å™¨ä¸å¸ƒå±€ ================= */
    .poster-container { 
        width: 400px; 
        height: 750px; 
        background-color: #111827; /* æ·±è‰²åº•è‰²ï¼Œé˜²æ­¢é€æ˜ç©¿é€å˜ç™½ */
        position: relative;
        overflow: hidden;
        flex-shrink: 0;
        /* å–æ¶ˆ transform-originï¼Œç”±å¤–éƒ¨æ§åˆ¶ç¼©æ”¾ */
        box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.5); 
    }
    
    /* ================= ç»ç’ƒå¡ç‰‡ ================= */
    /* ä½¿ç”¨åŠé€æ˜é»‘åº•ï¼Œç¡®ä¿é¢„è§ˆå’Œä¸‹è½½ä¸€è‡´æ€§ */
    .glass-panel { 
        background: rgba(0, 0, 0, 0.5); 
        border: 1px solid rgba(255, 255, 255, 0.15); 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 12px;
    }

    /* ================= èƒŒæ™¯å±‚ (å…³é”®ä¿®å¤ï¼šä½¿ç”¨ DIV+BGImage) ================= */
    /* ä¿®å¤æ‹‰ä¼¸é—®é¢˜çš„æ ¸å¿ƒï¼šä¸ç”¨ img æ ‡ç­¾ */
    #poster-bg-layer {
        position: absolute; inset: 0; 
        background-size: cover; 
        background-position: center;
        /* é¢„è§ˆæ—¶çš„æ»¤é•œ (ä¸‹è½½æ—¶ä¼šè¢« JS ç‰©ç†æ¨¡ç³Šæ›¿ä»£) */
        filter: blur(15px) brightness(0.6); 
        transform: scale(1.1); /* æ”¾å¤§ä¸€ç‚¹é˜²æ­¢æ¨¡ç³Šç™½è¾¹ */
        z-index: 0;
        transition: background-image 0.3s ease, opacity 0.3s ease;
    }

    /* çº¯è‰²èƒŒæ™¯å±‚ (ç”¨äºæ¸å˜æ¨¡å¼) */
    #poster-bg-gradient {
        position: absolute; inset: 0; z-index: 0;
        transition: background 0.3s ease;
    }
    
    /* å†…å®¹å±‚å¸ƒå±€ä¼˜åŒ–ï¼Œé˜²æ­¢æ–‡å­—åç§» */
    .poster-content { 
        position: relative; z-index: 10; 
        height: 100%; 
        display: flex; flex-direction: column; 
        padding: 32px; /* ç»Ÿä¸€ Padding */
    }
    
    /* ================= äº¤äº’ç»„ä»¶ ================= */
    .user-option.selected { border-color: #16a34a; background-color: #f0fdf4; }
    .bg-option { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .bg-option:hover { transform: scale(1.2); }
    .bg-option.active { border-color: #16a34a; transform: scale(1.1); }

    /* ================= é¢„è§ˆç¼©æ”¾å®¹å™¨ ================= */
    /* ç¡®ä¿é¢„è§ˆå±…ä¸­ */
    #preview-wrapper { overflow: auto; display: flex; justify-content: center; align-items: flex-start; padding: 20px; background-color: #f3f4f6; }
    /* ç¼©æ”¾æ§åˆ¶ç‚¹ */
    #scale-wrapper { transform-origin: top center; transition: transform 0.2s; margin-top: 10px; }
    
    /* æ–‡å­—æˆªæ–­è¾…åŠ©ç±» */
    .truncate-flex { min-width: 0; flex: 1; }
</style>
{% endblock %}

{% block content %}
<div class="flex h-full flex-col md:flex-row overflow-hidden">
    
    <div class="w-full md:w-80 bg-white border-r border-gray-200 p-6 flex flex-col z-20 shrink-0 overflow-y-auto shadow-xl">
        <h2 class="text-xl font-black text-gray-800 mb-6 flex items-center">
            <i class="fa-solid fa-paintbrush text-green-600 mr-2"></i> æ˜ è¿¹å·¥åŠ
        </h2>
        
        <div class="space-y-6 flex-1">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">ä¸»è§’</label>
                <div id="user-list-container" class="space-y-2 max-h-48 overflow-y-auto pr-1">
                    <p class="text-gray-400 text-xs">åŠ è½½ä¸­...</p>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">æ—¶é—´èŒƒå›´</label>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="setPeriod('all')" class="period-btn bg-gray-900 text-white text-xs py-2 rounded-lg font-bold transition-colors" data-p="all">å…¨é‡</button>
                    <button onclick="setPeriod('year')" class="period-btn bg-gray-100 text-gray-500 text-xs py-2 rounded-lg font-bold hover:bg-gray-200 transition-colors" data-p="year">å¹´åº¦</button>
                    <button onclick="setPeriod('month')" class="period-btn bg-gray-100 text-gray-500 text-xs py-2 rounded-lg font-bold hover:bg-gray-200 transition-colors" data-p="month">æœ¬æœˆ</button>
                    <button onclick="setPeriod('week')" class="period-btn bg-gray-100 text-gray-500 text-xs py-2 rounded-lg font-bold hover:bg-gray-200 transition-colors" data-p="week">æœ¬å‘¨</button>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">æ°›å›´è®¾å®š</label>
                <div class="flex flex-wrap gap-3">
                    <div class="bg-option active flex items-center justify-center bg-gray-800 text-white text-[8px] font-bold" onclick="setBg('auto', this)" title="ä½¿ç”¨ Top1 å½±ç‰‡èƒŒæ™¯">AUTO</div>
                    <div class="bg-option" style="background: linear-gradient(135deg, #1f2937 0%, #111827 100%)" onclick="setBg('linear-gradient(135deg, #1f2937 0%, #111827 100%)', this)"></div>
                    <div class="bg-option" style="background: linear-gradient(to top, #30cfd0 0%, #330867 100%)" onclick="setBg('linear-gradient(to top, #30cfd0 0%, #330867 100%)', this)"></div>
                    <div class="bg-option" style="background: linear-gradient(to top, #5f72bd 0%, #9b23ea 100%)" onclick="setBg('linear-gradient(to top, #5f72bd 0%, #9b23ea 100%)', this)"></div>
                    <div class="bg-option" style="background: linear-gradient(to right, #fa709a 0%, #fee140 100%)" onclick="setBg('linear-gradient(to right, #fa709a 0%, #fee140 100%)', this)"></div>
                </div>
            </div>

            <div>
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-xs font-bold text-gray-500 uppercase">å¯„è¯­</label>
                    <button onclick="randomQuote()" class="text-xs text-blue-600 hover:text-blue-800 transition-colors"><i class="fa-solid fa-dice mr-1"></i> éšæœºçµæ„Ÿ</button>
                </div>
                <textarea id="custom-msg" rows="3" class="w-full border-gray-300 rounded-lg text-sm p-3 border focus:ring-green-500 focus:border-green-500 shadow-sm transition-shadow resize-none" oninput="document.getElementById('poster-msg').innerText = this.value">ç”Ÿæ´»ä¸ä»…æœ‰ä»£ç ï¼Œè¿˜æœ‰ç”µå½±ã€‚</textarea>
            </div>
        </div>

        <button onclick="processCapture('download')" id="dl-btn" class="mt-8 w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg transition transform active:scale-95 flex justify-center items-center">
            <i class="fa-solid fa-download mr-2"></i> ä¿å­˜é«˜æ¸…æµ·æŠ¥
        </button>
        <button onclick="processCapture('copy')" id="cp-btn" class="mt-2 w-full py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold rounded-xl shadow-sm transition-colors flex justify-center items-center">
            <i class="fa-regular fa-copy mr-2"></i> å¤åˆ¶åˆ°å‰ªè´´æ¿
        </button>
    </div>

    <div class="flex-1" id="preview-wrapper">
        <div id="scale-wrapper">
            
            <div id="capture-area" class="poster-container">
                
                <div id="poster-bg-layer" style="display: none;"></div>
                <div id="poster-bg-gradient" style="display: none;"></div>
                
                <div class="absolute inset-0 z-[1] opacity-10 bg-repeat" style="background-image: url('https://www.transparenttextures.com/patterns/stardust.png'); pointer-events: none;"></div>

                <div class="poster-content">
                    
                    <div class="flex justify-between items-start mb-8">
                        <div class="flex items-center gap-4 truncate-flex">
                            <div class="w-14 h-14 rounded-full border-2 border-white/30 flex items-center justify-center bg-white/10 text-xl font-bold shadow-lg shrink-0" id="poster-avatar">U</div>
                            <div class="min-w-0 truncate-flex">
                                <h2 class="text-2xl font-black tracking-tight text-white truncate" id="poster-user">Username</h2>
                                <p class="text-xs text-white/70 font-medium tracking-widest uppercase mt-1 truncate" id="poster-period-text">å…¨é‡è§‚å½±æŠ¥å‘Š</p>
                            </div>
                        </div>
                        <div class="glass-panel px-3 py-1 rounded-full text-xs font-bold text-yellow-300 shrink-0 ml-2" id="poster-tag">è§‚å½±è¾¾äºº</div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-8 shrink-0">
                        <div class="glass-panel rounded-2xl py-4 px-3 text-center flex flex-col justify-center">
                            <div class="text-4xl font-black text-white leading-none mb-1" id="poster-hours">0</div>
                            <div class="text-[10px] text-white/70 font-bold truncate">æ€»æ—¶é•¿ (å°æ—¶)</div>
                        </div>
                        <div class="glass-panel rounded-2xl py-4 px-3 text-center flex flex-col justify-center">
                            <div class="text-4xl font-black text-white leading-none mb-1" id="poster-plays">0</div>
                            <div class="text-[10px] text-white/70 font-bold truncate">æ’­æ”¾æ¬¡æ•°</div>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col justify-center mb-6 min-h-0">
                        <div class="text-xs font-bold text-yellow-400 mb-3 flex items-center gap-2 shrink-0">
                            <i class="fa-solid fa-crown"></i> æœ€çˆ± Top 1
                        </div>
                        <div id="poster-top1-bg" class="relative w-full aspect-[16/9] rounded-2xl overflow-hidden shadow-2xl border border-white/20 group bg-black/30 flex-shrink-0 bg-cover bg-center" style="background-image: url('https://via.placeholder.com/400x225/374151/9ca3af?text=No+Data');">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent"></div>
                            <div class="absolute bottom-4 left-4 right-4">
                                <h3 class="text-xl font-bold leading-tight line-clamp-2 text-white" id="poster-top1-title">æš‚æ— æ•°æ®</h3>
                                <p class="text-xs text-white/70 mt-1 truncate"><span id="poster-top1-plays">0</span> æ¬¡æ’­æ”¾ Â· æŒšçˆ±ä¹‹é€‰</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-8 shrink-0">
                        <div class="glass-panel p-2 rounded-xl flex gap-3 items-center overflow-hidden">
                            <div id="poster-top2-bg" class="w-10 h-14 bg-gray-700 rounded overflow-hidden shrink-0 bg-cover bg-center" style="background-image: url('https://via.placeholder.com/100x150/374151/9ca3af?text=No');"></div>
                            <div class="truncate-flex">
                                <div class="text-[9px] text-white/50 font-bold mb-0.5">Top 2</div>
                                <div class="text-xs font-bold text-white truncate" id="poster-top2-title">-</div>
                            </div>
                        </div>
                        <div class="glass-panel p-2 rounded-xl flex gap-3 items-center overflow-hidden">
                            <div id="poster-top3-bg" class="w-10 h-14 bg-gray-700 rounded overflow-hidden shrink-0 bg-cover bg-center" style="background-image: url('https://via.placeholder.com/100x150/374151/9ca3af?text=No');"></div>
                            <div class="truncate-flex">
                                <div class="text-[9px] text-white/50 font-bold mb-0.5">Top 3</div>
                                <div class="text-xs font-bold text-white truncate" id="poster-top3-title">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-auto shrink-0">
                        <div class="border-t border-white/10 pt-4">
                            <p id="poster-msg" class="text-xs text-white/80 italic leading-relaxed font-light line-clamp-2">ç”Ÿæ´»ä¸ä»…æœ‰ä»£ç ï¼Œè¿˜æœ‰ç”µå½±ã€‚</p>
                            <div class="mt-3 flex items-center justify-between">
                                 <div class="flex items-center gap-2 text-[9px] text-white/40 font-mono">
                                    <i class="fa-solid fa-heart-pulse text-green-500"></i>
                                    <span>EmbyPulse æ˜ è¿¹</span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    const quotes = ["ç”Ÿæ´»ä¸ä»…æœ‰ä»£ç ï¼Œè¿˜æœ‰ç”µå½±ã€‚", "æœ‰äº›é¸Ÿå„¿æ˜¯å…³ä¸ä½çš„ã€‚", "èƒ½åŠ›è¶Šå¤§ï¼Œè´£ä»»è¶Šå¤§ã€‚", "æ„¿åŸåŠ›ä¸ä½ åŒåœ¨ã€‚", "å¿µå¿µä¸å¿˜ï¼Œå¿…æœ‰å›å“ã€‚", "æˆ‘å‘½ç”±æˆ‘ä¸ç”±å¤©ï¼", "ä¸ºäº†çœ‹çœ‹é˜³å…‰ï¼Œæˆ‘æ¥åˆ°è¿™ä¸–ä¸Šã€‚", "é£èµ·ï¼Œå”¯æœ‰åŠªåŠ›ç”Ÿå­˜ã€‚", "å¦‚æœä¸æ›¾è§è¿‡å¤ªé˜³ï¼Œæˆ‘æœ¬å¯ä»¥å¿å—é»‘æš—ã€‚", "å¥½çš„ç”µå½±ï¼Œæ˜¯ä¸€æ¬¡çµé­‚çš„æ´—ç¤¼ã€‚"];
    let currentPeriod = 'all';
    let currentUserId = '';
    let currentTop1Backdrop = '';
    let isAutoBg = true;

    // ç¼©æ”¾é€‚é… (ä»…ç”¨äºé¢„è§ˆï¼Œæˆªå›¾æ—¶ä¸ä¾èµ–æ­¤ç¼©æ”¾)
    function resizePoster() {
        if (window.innerWidth < 1100) {
            const wrapper = document.getElementById('preview-wrapper');
            const scale = (wrapper.clientWidth - 60) / 400;
            const el = document.getElementById('scale-wrapper');
            const finalScale = Math.min(scale, 1);
            el.style.transform = `scale(${finalScale})`;
        }
    }
    window.addEventListener('resize', resizePoster);
    setTimeout(resizePoster, 100);

    // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šè®¾ç½®èƒŒæ™¯å›¾çš„é€šç”¨å‡½æ•° (å¤„ç† div çš„ background-image)
    function setDivBackground(elementId, url) {
        const el = document.getElementById(elementId);
        if (!el) return;
        // é¢„åŠ è½½å›¾ç‰‡ä»¥æ£€æŸ¥æœ‰æ•ˆæ€§
        const img = new Image();
        img.onload = () => { el.style.backgroundImage = `url('${url}')`; };
        img.onerror = () => {
            // å›é€€é€»è¾‘
            if (elementId.includes('top1') && url.includes('backdrop')) {
                 const newUrl = url.replace('backdrop', 'primary');
                 setDivBackground(elementId, newUrl);
                 if (isAutoBg) setDivBackground('poster-bg-layer', newUrl);
            } else {
                 el.style.backgroundImage = `url('https://via.placeholder.com/400x225/374151/9ca3af?text=No+Image')`;
            }
        };
        img.src = url;
    }

    async function init() { await loadUsers(); }

    async function loadUsers() {
        const container = document.getElementById('user-list-container');
        try {
            const res = await fetch('/api/users');
            const json = await res.json();
            container.innerHTML = '';
            if(json.status === 'success') {
                json.data.forEach((user, index) => {
                    const div = document.createElement('div');
                    div.className = `user-option p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition flex items-center ${index===0?'selected':''}`;
                    div.innerHTML = `<div class="w-6 h-6 rounded-full bg-green-100 text-green-700 text-xs flex items-center justify-center font-bold mr-3">${user.UserName[0].toUpperCase()}</div><span class="text-gray-700 font-medium text-sm truncate">${user.UserName}</span>`;
                    div.onclick = () => selectUser(div, user);
                    container.appendChild(div);
                    if (index === 0) selectUser(div, user);
                });
            }
        } catch (e) { container.innerHTML = 'Error'; }
    }

    function selectUser(element, user) {
        document.querySelectorAll('.user-option').forEach(el => { el.classList.remove('selected'); el.classList.remove('bg-green-50'); el.classList.remove('border-green-600'); });
        element.classList.add('selected');
        document.getElementById('poster-user').innerText = user.UserName;
        document.getElementById('poster-avatar').innerText = user.UserName[0].toUpperCase();
        currentUserId = user.UserId;
        loadPosterData();
    }

    function setPeriod(period) {
        currentPeriod = period;
        document.querySelectorAll('.period-btn').forEach(btn => {
            if(btn.dataset.p === period) {
                btn.classList.add('bg-gray-900', 'text-white');
                btn.classList.remove('bg-gray-100', 'text-gray-500');
            } else {
                btn.classList.remove('bg-gray-900', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-500');
            }
        });
        const periodTextMap = {'all': 'å…¨é‡è§‚å½±æŠ¥å‘Š', 'year': 'å¹´åº¦è§‚å½±æŠ¥å‘Š', 'month': 'æœ¬æœˆè§‚å½±æŠ¥å‘Š', 'week': 'æœ¬å‘¨è§‚å½±æŠ¥å‘Š'};
        document.getElementById('poster-period-text').innerText = periodTextMap[period];
        loadPosterData();
    }

    async function loadPosterData() {
        if(!currentUserId) return;
        try {
            const res = await fetch(`/api/stats/poster_data?user_id=${currentUserId}&period=${currentPeriod}`);
            const json = await res.json();
            if(json.status === 'success') {
                const data = json.data;
                document.getElementById('poster-plays').innerText = data.plays;
                document.getElementById('poster-hours').innerText = data.hours;
                document.getElementById('poster-tag').innerText = data.tags[0] || "è§‚å½±è¾¾äºº";

                if(data.top3 && data.top3.length > 0) {
                    const top1 = data.top3[0];
                    document.getElementById('poster-top1-title').innerText = top1.ItemName;
                    document.getElementById('poster-top1-plays').innerText = top1.P;
                    
                    const imgUrl = `/api/proxy/image/${top1.ItemId}/backdrop`; 
                    currentTop1Backdrop = imgUrl;
                    
                    // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨ setDivBackground è®¾ç½® Top1 èƒŒæ™¯
                    setDivBackground('poster-top1-bg', imgUrl);
                    
                    if(isAutoBg) updateBgImage(imgUrl);
                } else {
                    document.getElementById('poster-top1-title').innerText = "æš‚æ— æ•°æ®";
                    document.getElementById('poster-top1-plays').innerText = "0";
                    setDivBackground('poster-top1-bg', 'https://via.placeholder.com/400x225/374151/9ca3af?text=No+Data');
                }
                updateSmallCard(1, data.top3); 
                updateSmallCard(2, data.top3);
                setTimeout(resizePoster, 50);
            }
        } catch(e) {}
    }

    function updateSmallCard(index, list) {
        const titleEl = document.getElementById(`poster-top${index+1}-title`);
        const bgElId = `poster-top${index+1}-bg`;
        if(list && list[index]) {
            titleEl.innerText = list[index].ItemName;
            setDivBackground(bgElId, `/api/proxy/image/${list[index].ItemId}/primary`);
        } else {
            titleEl.innerText = "-";
            setDivBackground(bgElId, 'https://via.placeholder.com/100x150/374151/9ca3af?text=No');
        }
    }

    function updateBgImage(src) {
        const bgLayer = document.getElementById('poster-bg-layer');
        const bgGrad = document.getElementById('poster-bg-gradient');
        bgGrad.style.display = 'none';
        bgLayer.style.display = 'block';
        setDivBackground('poster-bg-layer', src);
    }

    function setBg(val, el) {
        document.querySelectorAll('.bg-option').forEach(opt => opt.classList.remove('active'));
        el.classList.add('active');
        const bgLayer = document.getElementById('poster-bg-layer');
        const bgGrad = document.getElementById('poster-bg-gradient');
        
        if(val === 'auto') {
            isAutoBg = true;
            if(currentTop1Backdrop) updateBgImage(currentTop1Backdrop);
        } else {
            isAutoBg = false;
            bgLayer.style.display = 'none';
            bgGrad.style.display = 'block';
            bgGrad.style.background = val;
        }
    }

    function randomQuote() {
        const quote = quotes[Math.floor(Math.random() * quotes.length)];
        document.getElementById('custom-msg').value = quote;
        document.getElementById('poster-msg').innerText = quote;
    }

    // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šç‰©ç†é«˜æ–¯æ¨¡ç³Š (JS Canvas å®ç°)
    async function applyPhysicalBlur() {
        const bgLayer = document.getElementById('poster-bg-layer');
        if (bgLayer.style.display === 'none') return null;

        const bgImageStyle = bgLayer.style.backgroundImage;
        const urlMatch = bgImageStyle.match(/url\(['"]?(.*?)['"]?\)/);
        if (!urlMatch || !urlMatch[1]) return null;

        return new Promise((resolve) => {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = urlMatch[1];
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                // ç¼©å°åˆ° 5% äº§ç”Ÿå¼ºçƒˆæ¨¡ç³Š
                canvas.width = img.naturalWidth * 0.05;
                canvas.height = img.naturalHeight * 0.05;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // æ›¿æ¢èƒŒæ™¯å›¾ä¸ºæ¨¡ç³Šåçš„ Canvas DataURL
                bgLayer.style.backgroundImage = `url(${canvas.toDataURL()})`;
                // ç§»é™¤ CSS æ»¤é•œï¼Œé˜²æ­¢åŒé‡æ¨¡ç³Š
                const originalFilter = bgLayer.style.filter;
                bgLayer.style.filter = 'brightness(0.7)'; // ä»…ä¿ç•™äº®åº¦å‹æš—
                
                resolve(() => {
                    // è¿”å›æ¢å¤å‡½æ•°
                    bgLayer.style.backgroundImage = bgImageStyle;
                    bgLayer.style.filter = originalFilter;
                });
            };
            img.onerror = () => resolve(null);
        });
    }

    async function processCapture(action) {
        const node = document.getElementById('capture-area');
        const scaleWrapper = document.getElementById('scale-wrapper');
        const btn = document.getElementById(action === 'download' ? 'dl-btn' : 'cp-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> å¤„ç†ä¸­...';

        // 1. è®°å½•å½“å‰ç¼©æ”¾å€¼å¹¶æš‚æ—¶ç§»é™¤ç¼©æ”¾ï¼Œç¡®ä¿æˆªå›¾æ— åç§»
        const currentTransform = scaleWrapper.style.transform;
        scaleWrapper.style.transform = 'none';

        // 2. åº”ç”¨ç‰©ç†æ¨¡ç³Š
        const restoreBgFn = await applyPhysicalBlur();

        try {
            // 3. æˆªå›¾
            const canvas = await html2canvas(node, {
                scale: 3, // é«˜æ¸…
                useCORS: true, 
                backgroundColor: '#111827',
                allowTaint: true,
                logging: false,
                // å¼ºåˆ¶æŒ‡å®šæˆªå›¾å°ºå¯¸ï¼Œé˜²æ­¢æ„å¤–ç©ºç™½
                width: 400,
                height: 750,
                windowWidth: 400,
                windowHeight: 750,
                x: 0,
                y: 0
            });

            // 4. æ‰§è¡ŒåŠ¨ä½œ
            if (action === 'download') {
                const link = document.createElement('a');
                link.download = `EmbyReport_${currentPeriod}_${document.getElementById('poster-user').innerText}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } else {
                canvas.toBlob(blob => {
                    if (navigator.clipboard && navigator.clipboard.write) {
                        navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                        alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
                    } else {
                        alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·ä¸‹è½½ã€‚");
                    }
                });
            }
        } catch(e) {
            console.error(e);
            alert("ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è·¨åŸŸè®¾ç½®");
        } finally {
            // 5. è¿˜åŸç°åœº
            if(restoreBgFn) restoreBgFn();
            scaleWrapper.style.transform = currentTransform; // æ¢å¤ç¼©æ”¾
            btn.innerHTML = originalText;
        }
    }
    
    init();
</script>
{% endblock %}