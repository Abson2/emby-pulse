{% extends "layout.html" %}
{% block title %}æ˜ è¿¹å·¥åŠ - EmbyPulse{% endblock %}
{% block head %}
<style>
    /* ================= å¸ƒå±€é‡ç½®ï¼šæ‰‹æœºé€‚é…æ ¸å¿ƒ ================= */
    html, body { height: 100%; overflow: hidden; }
    
    .layout-wrapper { 
        display: flex; 
        height: 100%; 
        width: 100%;
        background-color: #f3f4f6;
    }

    /* å·¦ä¾§æ§åˆ¶å° */
    .control-panel {
        width: 340px; 
        background: white; 
        border-right: 1px solid #e5e7eb;
        display: flex; 
        flex-direction: column; 
        z-index: 50;
        flex-shrink: 0;
        height: 100%;
        overflow-y: auto; /* æ§åˆ¶å°å†…éƒ¨æ»šåŠ¨ */
        padding: 20px;
    }

    /* å³ä¾§é¢„è§ˆåŒº */
    #preview-wrapper {
        flex: 1; 
        height: 100%;
        display: flex; 
        justify-content: center; 
        align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ï¼Œæ–¹ä¾¿æ»šåŠ¨ */
        padding: 40px; 
        overflow-y: auto; /* ğŸ”¥ å…³é”®ï¼šå…è®¸é¢„è§ˆåŒºæ»šåŠ¨ */
        -webkit-overflow-scrolling: touch; /* iOSä¸æ»‘æ»šåŠ¨ */
    }

    /* æ‰‹æœºç«¯å“åº”å¼ */
    @media (max-width: 768px) {
        .layout-wrapper { flex-direction: column-reverse; } /* æ§åˆ¶å°åœ¨ä¸‹ */
        .control-panel { 
            width: 100%; 
            height: 40vh; /* å æ®åº•éƒ¨40% */
            border-right: none; 
            border-top: 1px solid #e5e7eb; 
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }
        #preview-wrapper { 
            height: 60vh; /* å æ®é¡¶éƒ¨60% */
            padding: 20px; 
            align-items: center; /* æ‰‹æœºä¸Šå‚ç›´å±…ä¸­å¥½çœ‹ç‚¹ */
        }
    }

    /* ================= æµ·æŠ¥æ ·å¼ ================= */
    .poster-container { 
        width: 420px; 
        min-height: 800px;
        height: auto; /* è‡ªé€‚åº” */
        background-color: #111827; 
        position: relative;
        overflow: visible; /* å…è®¸å†…å®¹æ’‘å¼€ */
        box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.6); 
        display: flex;
        flex-direction: column;
        flex-shrink: 0; /* é˜²æ­¢è¢«æŒ¤å‹ */
        font-family: -apple-system, "Microsoft YaHei", sans-serif; /* å¼ºåˆ¶å­—ä½“ */
    }
    
    #poster-bg-gradient {
        position: absolute; inset: 0; z-index: 0;
        transition: background 0.3s ease;
    }
    
    .noise-layer {
        position: absolute; inset: 0; z-index: 1; opacity: 0.08;
        background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
        pointer-events: none;
    }

    .poster-content { 
        position: relative; z-index: 10;
        padding: 40px 32px 30px 32px; 
        color: white; 
        display: flex; flex-direction: column;
        flex: 1;
    }

    /* ğŸ”¥ ä¿®å¤ï¼šæ–‡å­—å®‰å…¨åŒºåŸŸ */
    .safe-text-header {
        display: block;
        line-height: 1.4;
        padding-bottom: 6px; /* é˜²æ­¢åˆ‡åˆ°åº•éƒ¨ */
        padding-top: 4px;    /* é˜²æ­¢åˆ‡åˆ°é¡¶éƒ¨ */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .glass-card {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 24px;
    }

    .img-cover {
        background-size: cover; background-position: center; background-repeat: no-repeat;
        background-color: #374151;
    }

    /* åˆ—è¡¨é¡¹ */
    .rank-item {
        display: flex; align-items: center; 
        padding: 12px 0;
        border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .rank-item:last-child { border-bottom: none; }

    /* äº¤äº’ç»„ä»¶ */
    .user-option.selected { border-color: #16a34a; background-color: #f0fdf4; }
    .bg-option { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid white; transition: transform 0.2s; }
    .bg-option.active { border-color: #16a34a; transform: scale(1.1); box-shadow: 0 0 0 2px #16a34a; }
    
    #scale-wrapper { transform-origin: top center; transition: transform 0.2s; padding-bottom: 50px; }
    
    /* ç©ºçŠ¶æ€æ ·å¼ */
    #empty-state-visual {
        flex: 1; display: flex; flex-direction: column; 
        align-items: center; justify-content: center;
        opacity: 0.3; text-align: center;
        min-height: 300px;
    }
</style>
{% endblock %}

{% block content %}
<div class="layout-wrapper">
    
    <div class="control-panel">
        <div class="flex items-center mb-6 shrink-0">
            <i class="fa-solid fa-paintbrush text-green-600 mr-2 text-xl"></i>
            <h2 class="text-lg font-black text-gray-800">æ˜ è¿¹å·¥åŠ</h2>
        </div>
        
        <div class="space-y-6 flex-1 overflow-y-auto pr-1">
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">ä¸»è§’</label>
                <div id="user-list-container" class="space-y-2 max-h-32 overflow-y-auto pr-1 custom-scrollbar">
                    <p class="text-xs text-gray-400">åŠ è½½ä¸­...</p>
                </div>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">æ—¶é—´èŒƒå›´</label>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="setPeriod('all')" class="period-btn bg-gray-900 text-white text-xs py-2 rounded-lg font-bold" data-p="all">å…¨é‡</button>
                    <button onclick="setPeriod('year')" class="period-btn bg-gray-100 text-gray-500 text-xs py-2 rounded-lg font-bold hover:bg-gray-200" data-p="year">å¹´åº¦</button>
                    <button onclick="setPeriod('month')" class="period-btn bg-gray-100 text-gray-500 text-xs py-2 rounded-lg font-bold hover:bg-gray-200" data-p="month">æœ¬æœˆ</button>
                    <button onclick="setPeriod('week')" class="period-btn bg-gray-100 text-gray-500 text-xs py-2 rounded-lg font-bold hover:bg-gray-200" data-p="week">æœ¬å‘¨</button>
                </div>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">è‰²è°ƒ</label>
                <div class="grid grid-cols-6 gap-2">
                    <div class="bg-option active" style="background: linear-gradient(135deg, #111827 0%, #000000 100%)" onclick="setBg(this, 'linear-gradient(135deg, #111827 0%, #000000 100%)')"></div>
                    <div class="bg-option" style="background: linear-gradient(135deg, #4c1d95 0%, #1e1b4b 100%)" onclick="setBg(this, 'linear-gradient(135deg, #4c1d95 0%, #1e1b4b 100%)')"></div>
                    <div class="bg-option" style="background: linear-gradient(135deg, #be123c 0%, #881337 100%)" onclick="setBg(this, 'linear-gradient(135deg, #be123c 0%, #881337 100%)')"></div>
                    <div class="bg-option" style="background: linear-gradient(135deg, #047857 0%, #064e3b 100%)" onclick="setBg(this, 'linear-gradient(135deg, #047857 0%, #064e3b 100%)')"></div>
                    <div class="bg-option" style="background: linear-gradient(135deg, #b45309 0%, #78350f 100%)" onclick="setBg(this, 'linear-gradient(135deg, #b45309 0%, #78350f 100%)')"></div>
                    <div class="bg-option" style="background: linear-gradient(135deg, #155e75 0%, #0e7490 100%)" onclick="setBg(this, 'linear-gradient(135deg, #155e75 0%, #0e7490 100%)')"></div>
                </div>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">å¯„è¯­</label>
                <textarea id="custom-msg" rows="2" class="w-full border-gray-300 rounded-lg text-sm p-2 resize-none" oninput="document.getElementById('poster-msg').innerText = this.value">ç”Ÿæ´»ä¸ä»…æœ‰ä»£ç ï¼Œè¿˜æœ‰ç”µå½±ã€‚</textarea>
            </div>
        </div>

        <div class="mt-4 flex gap-2 shrink-0">
            <button onclick="processCapture('download')" id="dl-btn" class="flex-1 py-3 bg-gray-900 hover:bg-black text-white font-bold rounded-xl shadow-lg text-sm flex justify-center items-center">
                <i class="fa-solid fa-download mr-2"></i> ä¿å­˜
            </button>
            <button onclick="processCapture('copy')" id="cp-btn" class="flex-1 py-3 bg-white border border-gray-300 text-gray-700 font-bold rounded-xl shadow-sm hover:bg-gray-50 text-sm flex justify-center items-center">
                <i class="fa-regular fa-copy mr-2"></i> å¤åˆ¶
            </button>
        </div>
    </div>

    <div id="preview-wrapper">
        <div id="scale-wrapper">
            
            <div id="capture-target" class="poster-container">
                <div id="poster-bg-gradient" style="background: linear-gradient(135deg, #111827 0%, #000000 100%);"></div>
                <div class="noise-layer"></div>

                <div class="poster-content">
                    
                    <div class="flex justify-between items-start mb-8">
                        <div class="flex items-center gap-4 min-w-0">
                            <div class="w-16 h-16 rounded-full bg-white/10 flex items-center justify-center text-3xl font-black shrink-0 border border-white/20 shadow-lg" id="poster-avatar">U</div>
                            <div class="min-w-0">
                                <h2 class="text-3xl font-black safe-text-header" id="poster-user">Username</h2>
                                <p class="text-xs text-white/50 uppercase tracking-widest" id="poster-period-text">å…¨é‡æŠ¥å‘Š</p>
                            </div>
                        </div>
                        <div class="px-4 py-1.5 rounded-full text-xs font-bold bg-white/10 text-white shrink-0 border border-white/10" id="poster-tag">è§‚å½±è¾¾äºº</div>
                    </div>

                    <div class="glass-card mb-8">
                        <div class="grid grid-cols-3 divide-x divide-white/10">
                            <div class="flex flex-col items-center justify-center px-2">
                                <span class="text-2xl font-black safe-text-header" id="poster-hours">0</span>
                                <span class="text-[9px] text-white/40 uppercase font-bold">ä¸“æ³¨æ—¶é•¿(h)</span>
                            </div>
                            <div class="flex flex-col items-center justify-center px-2">
                                <span class="text-2xl font-black safe-text-header" id="poster-plays">0</span>
                                <span class="text-[9px] text-white/40 uppercase font-bold">æ’­æ”¾æ¬¡æ•°</span>
                            </div>
                            <div class="flex flex-col items-center justify-center px-2">
                                <span class="text-2xl font-black text-green-400 safe-text-header" id="poster-server-plays">0</span>
                                <span class="text-[9px] text-white/40 uppercase font-bold">å…¨æœæ€»æ’­æ”¾</span>
                            </div>
                        </div>
                    </div>

                    <div id="empty-state-visual" style="display: none;">
                        <i class="fa-solid fa-wind text-6xl mb-4"></i>
                        <p class="text-lg font-bold">æš‚æ— è¶³è¿¹</p>
                        <p class="text-xs mt-2">è¯¥æ—¶é—´æ®µå†…æ²¡æœ‰å‘ç°è§‚å½±è®°å½•</p>
                    </div>

                    <div id="data-content-area">
                        <div class="mb-6 shrink-0" id="top1-section">
                            <div class="text-xs font-bold text-yellow-400 mb-3 flex items-center gap-2 uppercase tracking-wider">
                                <i class="fa-solid fa-crown"></i> å¹´åº¦æœ€çˆ± Top 1
                            </div>
                            <div class="relative w-full aspect-[2/1] rounded-xl overflow-hidden shadow-2xl border border-white/10 bg-gray-800">
                                <div id="top1-bg" class="img-cover w-full h-full"></div>
                                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent"></div>
                                <div class="absolute bottom-4 left-5 right-5">
                                    <h3 class="text-2xl font-bold safe-text-header" id="poster-top1-title">-</h3>
                                    <p class="text-sm text-white/60"><span id="poster-top1-plays" class="text-white font-bold">0</span> æ¬¡æ’­æ”¾</p>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-6 shrink-0" id="top23-section">
                            <div class="glass-card flex items-center gap-3 p-3 overflow-hidden !margin-0">
                                <div id="top2-bg" class="w-10 h-14 bg-gray-700 rounded shrink-0 img-cover shadow-sm"></div>
                                <div class="min-w-0">
                                    <div class="text-[9px] text-white/40 font-bold mb-0.5 uppercase">TOP 2</div>
                                    <div class="text-sm font-bold safe-text-header" id="poster-top2-title">-</div>
                                </div>
                            </div>
                            <div class="glass-card flex items-center gap-3 p-3 overflow-hidden !margin-0">
                                <div id="top3-bg" class="w-10 h-14 bg-gray-700 rounded shrink-0 img-cover shadow-sm"></div>
                                <div class="min-w-0">
                                    <div class="text-[9px] text-white/40 font-bold mb-0.5 uppercase">TOP 3</div>
                                    <div class="text-sm font-bold safe-text-header" id="poster-top3-title">-</div>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card flex-1 mb-6 px-5 py-4 min-h-0" id="top-rest-section">
                            <div class="text-[10px] text-white/30 uppercase font-bold mb-2 tracking-wider">å…¶ä½™ä¸Šæ¦œ</div>
                            <div id="top-rest-list" class="space-y-1"></div>
                        </div>
                    </div>

                    <div class="mt-auto pt-6 border-t border-white/10 shrink-0">
                        <p id="poster-msg" class="text-sm text-white/70 italic font-light line-clamp-2 leading-relaxed">ç”Ÿæ´»ä¸ä»…æœ‰ä»£ç ï¼Œè¿˜æœ‰ç”µå½±ã€‚</p>
                        <div class="mt-4 flex justify-between items-center opacity-40">
                            <span class="text-[10px] font-mono tracking-[0.2em]">EMBY PULSE</span>
                            <i class="fa-solid fa-heart-pulse text-green-500"></i>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    let currentPeriod = 'all';
    let currentUserId = '';

    function resizePreview() {
        if (window.innerWidth < 1200) {
            const wrapper = document.getElementById('preview-wrapper');
            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ (å®½åº¦é€‚é…ï¼Œé«˜åº¦è‡ªé€‚åº”)
            const scale = (wrapper.clientWidth - 40) / 440;
            const finalScale = Math.min(scale, 1);
            document.getElementById('scale-wrapper').style.transform = `scale(${finalScale})`;
        }
    }
    window.addEventListener('resize', resizePreview);
    setTimeout(resizePreview, 100);

    function setDivBg(elementId, url) {
        const el = document.getElementById(elementId);
        if(!el) return;
        const img = new Image();
        img.onload = () => { el.style.backgroundImage = `url('${url}')`; };
        img.onerror = () => {
            if (url.includes('backdrop')) {
                setDivBg(elementId, url.replace('backdrop', 'primary'));
            } else {
                el.style.backgroundImage = `url('https://via.placeholder.com/100x150/374151/9ca3af?text=No')`;
            }
        };
        img.src = url;
    }

    async function init() { await loadUsers(); }

    async function loadUsers() {
        const container = document.getElementById('user-list-container');
        try {
            const res = await fetch('/api/users');
            const json = await res.json();
            container.innerHTML = '';
            if(json.status === 'success') {
                json.data.forEach((user, index) => {
                    const div = document.createElement('div');
                    div.className = `user-option p-2 border border-gray-200 rounded cursor-pointer hover:bg-gray-50 flex items-center mb-1 transition ${index===0?'selected bg-green-50 border-green-500':''}`;
                    div.innerHTML = `<span class="text-xs font-bold mr-3 text-green-600 w-5">${user.UserName[0].toUpperCase()}</span><span class="text-sm safe-text-header flex-1">${user.UserName}</span>`;
                    div.onclick = () => {
                        document.querySelectorAll('.user-option').forEach(el => el.className = el.className.replace('selected bg-green-50 border-green-500', ''));
                        div.className += ' selected bg-green-50 border-green-500';
                        selectUser(user);
                    };
                    container.appendChild(div);
                    if (index === 0) selectUser(user);
                });
            }
        } catch (e) { container.innerHTML = 'Error'; }
    }

    function selectUser(user) {
        document.getElementById('poster-user').innerText = user.UserName;
        document.getElementById('poster-avatar').innerText = user.UserName[0].toUpperCase();
        currentUserId = user.UserId;
        loadPosterData();
    }

    function setPeriod(period) {
        currentPeriod = period;
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.className = btn.dataset.p === period 
                ? "period-btn bg-gray-900 text-white text-xs py-2.5 rounded-lg font-bold transition shadow-md"
                : "period-btn bg-gray-100 text-gray-500 text-xs py-2.5 rounded-lg font-bold hover:bg-gray-200 transition";
        });
        const map = {'all': 'å…¨é‡è§‚å½±æŠ¥å‘Š', 'year': 'å¹´åº¦è§‚å½±æŠ¥å‘Š', 'month': 'æœ¬æœˆè§‚å½±æŠ¥å‘Š', 'week': 'æœ¬å‘¨è§‚å½±æŠ¥å‘Š'};
        document.getElementById('poster-period-text').innerText = map[period];
        loadPosterData();
    }

    function setBg(el, gradient) {
        document.querySelectorAll('.bg-option').forEach(opt => opt.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('poster-bg-gradient').style.background = gradient;
    }

    async function loadPosterData() {
        if(!currentUserId) return;
        try {
            const res = await fetch(`/api/stats/poster_data?user_id=${currentUserId}&period=${currentPeriod}`);
            const json = await res.json();
            if(json.status === 'success') {
                const data = json.data;
                document.getElementById('poster-plays').innerText = data.plays;
                document.getElementById('poster-hours').innerText = data.hours;
                document.getElementById('poster-server-plays').innerText = data.server_plays || 0;
                document.getElementById('poster-tag').innerText = data.tags[0] || "è§‚å½±è¾¾äºº";

                const hasData = data.plays > 0;
                // ç©ºçŠ¶æ€å¤„ç†
                document.getElementById('data-content-area').style.display = hasData ? 'block' : 'none';
                document.getElementById('empty-state-visual').style.display = hasData ? 'none' : 'flex';

                if (hasData) {
                    const list = data.top_list || [];
                    
                    // Top 1
                    const s1 = document.getElementById('top1-section');
                    if(list[0]) {
                        s1.style.display = 'block';
                        document.getElementById('poster-top1-title').innerText = list[0].ItemName;
                        document.getElementById('poster-top1-plays').innerText = list[0].P;
                        setDivBg('top1-bg', `/api/proxy/image/${list[0].ItemId}/backdrop`);
                    } else {
                        s1.style.display = 'none';
                    }

                    // Top 2-3
                    const s23 = document.getElementById('top23-section');
                    if(list[1]) {
                        s23.style.display = 'grid';
                        updateCard(2, list[1]);
                        updateCard(3, list[2]);
                    } else {
                        s23.style.display = 'none';
                    }

                    // Top 4-10
                    const sRest = document.getElementById('top-rest-section');
                    const listContainer = document.getElementById('top-rest-list');
                    let listHtml = '';
                    let hasRest = false;
                    const maxCount = Math.min(list.length, 10);
                    
                    for(let i=3; i<maxCount; i++) {
                        hasRest = true;
                        listHtml += `
                        <div class="rank-item">
                            <span class="text-[10px] text-white/40 w-6 font-bold font-mono">0${i+1}</span>
                            <span class="text-xs font-bold flex-1 text-truncate mr-2 safe-text-header">${list[i].ItemName}</span>
                            <span class="text-[9px] text-white/60 font-mono">${list[i].P}æ¬¡</span>
                        </div>`;
                    }
                    
                    if(hasRest) {
                        sRest.style.display = 'flex';
                        listContainer.innerHTML = listHtml;
                    } else {
                        sRest.style.display = 'none';
                    }
                }
                
                setTimeout(resizePreview, 100);
            }
        } catch(e) { console.error(e); }
    }

    function updateCard(rank, item) {
        const titleEl = document.getElementById(`poster-top${rank}-title`);
        const bgId = `top${rank}-bg`;
        const card = document.getElementById(bgId).parentElement;
        if(item) {
            card.style.visibility = 'visible';
            titleEl.innerText = item.ItemName;
            setDivBg(bgId, `/api/proxy/image/${item.ItemId}/primary`);
        } else {
            card.style.visibility = 'hidden';
        }
    }

    function randomQuote() {
        const quotes = ["ç”Ÿæ´»ä¸ä»…æœ‰ä»£ç ï¼Œè¿˜æœ‰ç”µå½±ã€‚", "æœ‰äº›é¸Ÿå„¿æ˜¯å…³ä¸ä½çš„ã€‚", "èƒ½åŠ›è¶Šå¤§ï¼Œè´£ä»»è¶Šå¤§ã€‚", "å¿µå¿µä¸å¿˜ï¼Œå¿…æœ‰å›å“ã€‚", "é£èµ·ï¼Œå”¯æœ‰åŠªåŠ›ç”Ÿå­˜ã€‚", "å¥½çš„ç”µå½±ï¼Œæ˜¯ä¸€æ¬¡çµé­‚çš„æ´—ç¤¼ã€‚"];
        const q = quotes[Math.floor(Math.random() * quotes.length)];
        document.getElementById('custom-msg').value = q;
        document.getElementById('poster-msg').innerText = q;
    }

    async function processCapture(action) {
        const node = document.getElementById('capture-target');
        const scaler = document.getElementById('scale-wrapper');
        const btn = document.getElementById(action === 'download' ? 'dl-btn' : 'cp-btn');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        
        const originalTransform = scaler.style.transform;
        scaler.style.transform = 'none';
        await new Promise(r => setTimeout(r, 50)); 

        try {
            const canvas = await html2canvas(node, {
                scale: 2, 
                useCORS: true, 
                backgroundColor: '#111827',
                width: 440,
                windowWidth: 440,
                x: 0, y: 0
            });

            if (action === 'download') {
                const link = document.createElement('a');
                link.download = `EmbyReport_${document.getElementById('poster-user').innerText}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } else {
                canvas.toBlob(blob => {
                    navigator.clipboard.write([new ClipboardItem({'image/png': blob})])
                        .then(() => alert("å·²å¤åˆ¶!"))
                        .catch(() => alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·ä¸‹è½½"));
                });
            }
        } catch(e) { 
            alert("ç”Ÿæˆå¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•"); 
        } finally {
            scaler.style.transform = originalTransform;
            btn.innerHTML = originalText;
        }
    }
    
    init();
</script>
{% endblock %}