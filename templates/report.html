{% extends "layout.html" %}
{% block title %}映迹工坊 - EmbyPulse{% endblock %}
{% block head %}
<style>
    .poster-container { width: 375px; height: 667px; background: linear-gradient(135deg, #1f2937 0%, #111827 100%); box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.5); transform-origin: top center; }
    .glass-card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
    .user-option.selected { border-color: #16a34a; background-color: #f0fdf4; }
</style>
{% endblock %}
{% block content %}
<div class="flex h-full flex-col md:flex-row overflow-hidden">
    <div class="w-full md:w-80 bg-white border-b md:border-b-0 md:border-r border-gray-200 p-4 md:p-6 flex flex-col z-20 shrink-0 max-h-[40vh] md:max-h-full overflow-y-auto">
        <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-4">配置报告</h2>
        <div class="space-y-4 flex-1">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">选择用户</label>
                <div id="user-list-container" class="flex md:block space-x-2 md:space-x-0 md:space-y-2 overflow-x-auto pb-2 md:pb-0 hide-scrollbar">
                    <p class="text-gray-400 text-xs">加载中...</p>
                </div>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">寄语</label>
                <textarea id="custom-msg" rows="2" class="w-full border-gray-300 rounded-lg text-sm p-2 border" oninput="document.getElementById('poster-msg').innerText = this.value">生活不仅有代码，还有电影。</textarea>
            </div>
        </div>
        <button onclick="downloadPoster()" id="dl-btn" class="mt-4 w-full py-3 bg-green-600 text-white font-bold rounded-lg shadow flex justify-center items-center text-sm"><i class="fa-solid fa-download mr-2"></i> 保存海报</button>
    </div>

    <div class="flex-1 bg-gray-100 flex justify-center p-4 md:p-8 overflow-y-auto overflow-x-hidden relative" id="preview-wrapper">
        <div id="scale-wrapper" class="mt-4 md:mt-0">
            <div id="capture-area" class="poster-container flex flex-col relative shrink-0">
                <div id="poster-bg" class="absolute inset-0 z-0 opacity-40 blur-sm bg-cover bg-center transition-all duration-1000" style="background-image: url('');"></div>
                <div class="absolute inset-0 z-0 bg-gradient-to-t from-gray-900 via-gray-900/80 to-transparent"></div>
                <div class="relative z-10 p-6 flex-1 flex flex-col text-white">
                    <div class="flex justify-between items-center mb-8">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-blue-500 flex items-center justify-center font-bold text-white shadow-lg border border-white/20" id="poster-avatar">U</div>
                            <div><div class="text-sm font-black tracking-wide">EmbyPulse</div><div class="text-[10px] text-gray-300 font-bold uppercase tracking-widest">映 迹 · 洞 察</div></div>
                        </div>
                        <div class="px-2 py-1 border border-white/20 rounded text-xs text-gray-300 font-mono" id="poster-user">Guest</div>
                    </div>
                    <div class="mb-8">
                        <div class="text-green-400 text-sm font-bold mb-1 tracking-wider uppercase">专注时长</div>
                        <div class="text-6xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-300" id="poster-hours">0</div>
                        <div class="text-sm text-gray-400 mt-2">小时 · 探索光影世界</div>
                    </div>
                    <div class="glass-card p-4 grid grid-cols-2 gap-4 rounded-xl mb-6">
                        <div class="text-center border-r border-white/10"><div class="text-2xl font-bold" id="poster-count">0</div><div class="text-xs text-gray-400 uppercase mt-1">播放次数</div></div>
                        <div class="text-center"><div class="text-2xl font-bold">Night</div><div class="text-xs text-gray-400 uppercase mt-1">活跃时段</div></div>
                    </div>
                    <div class="flex-1">
                        <div class="text-xs font-bold text-gray-500 uppercase mb-4 tracking-wider">本期最爱 Top 1</div>
                        <div class="flex gap-4 items-center group">
                            <div class="w-16 h-24 bg-gray-700 rounded-lg shadow-2xl overflow-hidden shrink-0 border border-white/10 transform group-hover:scale-105 transition"><img id="poster-top-img" src="" class="w-full h-full object-cover opacity-50"></div>
                            <div>
                                <h4 class="font-bold text-lg leading-tight line-clamp-2" id="poster-top-title">暂无数据</h4>
                                <div class="text-sm text-gray-400 mt-1"><i class="fa-solid fa-rotate-right text-green-500 mr-1"></i> 播放 <span id="poster-top-count">0</span> 次</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-auto border-t border-white/10 pt-4"><p id="poster-msg" class="text-xs text-gray-400 italic">生活不仅有代码，还有电影。</p><div class="mt-2 flex items-center text-[10px] text-gray-500 uppercase tracking-widest"><span class="font-bold text-gray-400 mr-1">EmbyPulse</span> 映迹</div></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    function resizePoster() {
        if (window.innerWidth < 768) {
            const wrapper = document.getElementById('preview-wrapper');
            const scale = (wrapper.clientWidth - 32) / 375;
            const el = document.getElementById('scale-wrapper');
            if (scale < 1) el.style.transform = `scale(${scale})`;
        }
    }
    window.addEventListener('resize', resizePoster);
    setTimeout(resizePoster, 100);

    async function init() { await loadUsers(); }
    async function loadUsers() {
        const container = document.getElementById('user-list-container');
        try {
            const res = await fetch('/api/users');
            const json = await res.json();
            container.innerHTML = '';
            if(json.status === 'success') {
                json.data.forEach((user, index) => {
                    const div = document.createElement('div');
                    div.className = `user-option min-w-[140px] md:min-w-0 p-2 md:p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition flex items-center ${index===0?'selected':''}`;
                    div.innerHTML = `<div class="w-6 h-6 rounded-full bg-green-100 text-green-700 text-xs flex items-center justify-center font-bold mr-2 md:mr-3 shrink-0">${user.UserName[0].toUpperCase()}</div><span class="text-gray-700 font-medium truncate text-sm">${user.UserName}</span>`;
                    div.onclick = () => selectUser(div, user);
                    container.appendChild(div);
                    if (index === 0) selectUser(div, user);
                });
            }
        } catch (e) { container.innerHTML = 'Error'; }
    }
    function selectUser(element, user) {
        document.querySelectorAll('.user-option').forEach(el => { el.classList.remove('selected'); el.classList.remove('bg-green-50'); el.classList.remove('border-green-600'); });
        element.classList.add('selected');
        document.getElementById('poster-user').innerText = user.UserName;
        document.getElementById('poster-avatar').innerText = user.UserName[0].toUpperCase();
        loadUserData(user.UserId);
    }
    async function loadUserData(userId) {
        const resStats = await fetch(`/api/stats/dashboard?user_id=${userId}`);
        const stats = await resStats.json();
        if (stats.status === 'success') {
            document.getElementById('poster-count').innerText = stats.data.total_plays;
            document.getElementById('poster-hours').innerText = Math.round(stats.data.total_duration / 3600);
        }
        const resTop = await fetch(`/api/stats/top_movies?user_id=${userId}`);
        const top = await resTop.json();
        if (top.status === 'success' && top.data.length > 0) {
            const item = top.data[0];
            document.getElementById('poster-top-title').innerText = item.ItemName;
            document.getElementById('poster-top-count').innerText = item.PlayCount;
            const imgUrl = `/api/proxy/image/${item.ItemId}/primary`;
            const bgUrl = `/api/proxy/image/${item.ItemId}/backdrop`;
            document.getElementById('poster-top-img').src = imgUrl;
            document.getElementById('poster-top-img').classList.remove('opacity-50');
            document.getElementById('poster-bg').style.backgroundImage = `url('${bgUrl}')`;
        }
    }
    function downloadPoster() {
        const node = document.getElementById('capture-area');
        const btn = document.getElementById('dl-btn');
        const originalText = btn.innerHTML;
        const userName = document.getElementById('poster-user').innerText;
        btn.innerHTML = '
