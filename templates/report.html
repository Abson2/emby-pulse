{% extends "layout.html" %}
{% block title %}Êò†ËøπÂ∑•Âùä - Â∞èÁ•®Áâà{% endblock %}
{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
    /* ================= Â∏ÉÂ±ÄÁ≥ªÁªü (Mobile First) ================= */
    html, body { height: 100%; margin: 0; background: #e5e5e5; font-family: 'Space Mono', monospace, sans-serif; overflow: hidden; }
    
    .app-container { display: flex; flex-direction: column; height: 100%; }

    /* È¢ÑËßàÂå∫ (‰∏äÈÉ®) */
    .preview-area {
        flex: 1;
        overflow-y: auto; /* ÂÖÅËÆ∏ÊªöÂä® */
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 40px 20px;
        background-color: #d4d4d8;
        background-image: radial-gradient(#a1a1aa 1px, transparent 1px);
        background-size: 20px 20px;
    }

    /* ÊéßÂà∂Âè∞ (‰∏ãÈÉ®) */
    .control-panel {
        background: white;
        padding: 20px;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        z-index: 50;
        flex-shrink: 0;
        max-height: 40vh; /* ÊâãÊú∫‰∏ä‰∏çË¶ÅÂç†Â§™È´ò */
        overflow-y: auto;
    }

    /* PC Á´ØÈÄÇÈÖç */
    @media (min-width: 768px) {
        .app-container { flex-direction: row; }
        .control-panel { width: 360px; height: 100%; max-height: 100%; border-right: 1px solid #ccc; box-shadow: none; }
        .preview-area { align-items: center; }
    }

    /* ================= üßæ Â∞èÁ•®Êú¨‰ΩìÊ†∑Âºè ================= */
    .receipt {
        width: 360px;
        background: #fff;
        position: relative;
        filter: drop-shadow(0 5px 15px rgba(0,0,0,0.15));
        display: flex; flex-direction: column;
        margin-bottom: 50px; /* Â∫ïÈÉ®ÁïôÁôΩÊñπ‰æøÊü•Áúã */
    }

    /* ÈîØÈΩøËæπÁºò */
    .receipt::before, .receipt::after {
        content: ""; position: absolute; left: 0; width: 100%; height: 6px;
        background-size: 12px 12px; background-repeat: repeat-x;
    }
    .receipt::before {
        top: -6px;
        background-image: linear-gradient(135deg, transparent 50%, #fff 50%), linear-gradient(45deg, #fff 50%, transparent 50%);
    }
    .receipt::after {
        bottom: -6px;
        background-image: linear-gradient(135deg, #fff 50%, transparent 50%), linear-gradient(45deg, transparent 50%, #fff 50%);
    }

    .r-content { padding: 30px 24px; color: #111; }

    /* ÊñáÊú¨ÈÄöÁî® */
    .r-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
    .r-label { font-size: 12px; font-weight: bold; text-transform: uppercase; }
    .r-val { font-size: 14px; font-weight: bold; text-align: right; }
    .r-val.big { font-size: 24px; letter-spacing: -1px; }
    
    .divider { border-bottom: 2px dashed #000; margin: 15px 0; opacity: 0.2; }
    .divider-solid { border-bottom: 2px solid #000; margin: 20px 0; }

    /* Â§¥ÈÉ® */
    .r-header { text-align: center; margin-bottom: 20px; }
    .r-title { font-size: 28px; font-weight: 900; margin: 0; letter-spacing: -1px; line-height: 1; }
    .r-sub { font-size: 10px; opacity: 0.6; margin-top: 5px; text-transform: uppercase; }

    /* Top Ê¶úÂçï */
    .top1-box { 
        width: 100%; aspect-ratio: 16/9; background: #eee; margin: 10px 0; 
        border: 2px solid #000; position: relative; 
        background-size: cover; background-position: center;
    }
    .top1-tag { 
        position: absolute; top: 0; left: 0; background: #000; color: #fff; 
        font-size: 10px; padding: 4px 8px; font-weight: bold; 
    }
    
    .list-item { 
        display: flex; justify-content: space-between; align-items: center; 
        padding: 8px 0; border-bottom: 1px dotted #ccc; font-size: 11px; 
    }
    .item-name { 
        flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        font-weight: bold; padding-right: 10px; 
    }

    /* Â∫ïÈÉ® */
    .barcode { 
        height: 40px; width: 100%; margin-top: 20px; 
        background: repeating-linear-gradient(to right, #000 0, #000 2px, transparent 2px, transparent 4px, #000 4px, #000 5px); 
    }
    .footer-msg { font-size: 10px; text-align: center; margin-top: 10px; font-style: italic; }

    /* ================= ‰∫§‰∫íÊåâÈíÆ ================= */
    .btn-group { display: flex; gap: 8px; margin-bottom: 12px; }
    .btn { 
        flex: 1; padding: 10px; border: 2px solid #000; background: #fff; 
        font-family: inherit; font-size: 12px; font-weight: bold; cursor: pointer; 
    }
    .btn.active { background: #000; color: #fff; }
    .btn-save { background: #16a34a; border-color: #16a34a; color: white; width: 100%; }
</style>
{% endblock %}

{% block content %}
<div class="app-container">
    
    <div class="preview-area">
        <div id="scale-wrapper"> <div id="capture-target" class="receipt">
                <div class="r-content">
                    
                    <div class="r-header">
                        <h1 class="r-title">EMBY PULSE</h1>
                        <div class="r-sub">Viewing Report / <span id="p-date">2026-01-01</span></div>
                    </div>

                    <div class="divider-solid"></div>

                    <div class="r-row">
                        <span class="r-label">USER</span>
                        <span class="r-val" id="p-user">LOADING...</span>
                    </div>
                    <div class="r-row">
                        <span class="r-label">PERIOD</span>
                        <span class="r-val" id="p-period">ALL TIME</span>
                    </div>

                    <div class="divider"></div>

                    <div class="r-row">
                        <span class="r-label">TOTAL HOURS</span>
                        <span class="r-val big" id="p-hours">0</span>
                    </div>
                    <div class="r-row">
                        <span class="r-label">TOTAL PLAYS</span>
                        <span class="r-val big" id="p-plays">0</span>
                    </div>
                    <div class="r-row" style="opacity: 0.5;">
                        <span class="r-label">SERVER TOTAL</span>
                        <span class="r-val" id="p-server">0</span>
                    </div>

                    <div class="divider-solid"></div>

                    <div class="r-label" style="margin-bottom: 10px;">TOP CONSUMPTION</div>
                    
                    <div id="top1-area" style="display: none;">
                        <div class="top1-box" id="top1-img">
                            <div class="top1-tag">#1 MOST WATCHED</div>
                        </div>
                        <div class="r-row">
                            <span class="r-val" id="top1-name" style="text-align: left;">-</span>
                            <span class="r-label" id="top1-count">0</span>
                        </div>
                    </div>

                    <div id="list-container" style="margin-top: 15px;">
                        <div style="text-align: center; padding: 20px; font-size: 12px; opacity: 0.5;">
                            [ NO DATA ]
                        </div>
                    </div>

                    <div class="divider"></div>

                    <div class="r-row">
                        <span class="r-label">TOTAL</span>
                        <span class="r-val">PRICELESS</span>
                    </div>
                    
                    <div class="barcode"></div>
                    <div class="footer-msg" id="p-msg">Life is short, watch more.</div>
                    <div style="text-align: center; font-size: 8px; margin-top: 5px; opacity: 0.5;">Generated by EmbyPulse</div>

                </div>
            </div>
        </div>
    </div>

    <div class="control-panel">
        <div style="font-size: 10px; font-weight: bold; margin-bottom: 5px;">USER SELECT</div>
        <select id="user-select" onchange="changeUser(this.value)" style="width: 100%; padding: 8px; border: 2px solid #000; margin-bottom: 15px; font-family: inherit;">
            <option>Loading...</option>
        </select>

        <div style="font-size: 10px; font-weight: bold; margin-bottom: 5px;">TIME RANGE</div>
        <div class="btn-group">
            <button class="btn active" onclick="setPeriod('all', this)">ALL</button>
            <button class="btn" onclick="setPeriod('year', this)">YEAR</button>
            <button class="btn" onclick="setPeriod('month', this)">MONTH</button>
            <button class="btn" onclick="setPeriod('week', this)">WEEK</button>
        </div>

        <button class="btn btn-save" onclick="downloadImage()">
            DOWNLOAD RECEIPT
        </button>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    let currentUserId = '';
    let currentPeriod = 'all';

    // Áº©ÊîæÈÄÇÈÖç
    function fitScale() {
        const wrapper = document.querySelector('.preview-area');
        const card = document.getElementById('capture-target');
        // ÁïôÂá∫ 40px ËæπË∑ù
        const scale = Math.min((wrapper.clientWidth - 40) / 360, 1);
        document.getElementById('scale-wrapper').style.transform = `scale(${scale})`;
        document.getElementById('scale-wrapper').style.transformOrigin = 'top center';
    }
    window.addEventListener('resize', fitScale);
    setTimeout(fitScale, 100);

    async function init() {
        document.getElementById('p-date').innerText = new Date().toLocaleDateString();
        
        // Ëé∑ÂèñÁî®Êà∑
        const res = await fetch('/api/users');
        const json = await res.json();
        const sel = document.getElementById('user-select');
        sel.innerHTML = '';
        
        if (json.data && json.data.length > 0) {
            json.data.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.UserId;
                opt.innerText = u.UserName;
                sel.appendChild(opt);
            });
            changeUser(json.data[0].UserId);
        }
    }

    function changeUser(uid) {
        currentUserId = uid;
        const sel = document.getElementById('user-select');
        const name = sel.options[sel.selectedIndex].text;
        document.getElementById('p-user').innerText = name;
        loadData();
    }

    function setPeriod(p, btn) {
        currentPeriod = p;
        document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('p-period').innerText = p.toUpperCase();
        loadData();
    }

    async function loadData() {
        if(!currentUserId) return;
        
        const res = await fetch(`/api/stats/poster_data?user_id=${currentUserId}&period=${currentPeriod}`);
        const json = await res.json();
        const data = json.data;

        // Â°´ÂÖÖÊï∞ÊçÆ
        document.getElementById('p-plays').innerText = data.plays;
        document.getElementById('p-hours').innerText = data.hours;
        document.getElementById('p-server').innerText = data.server_plays;

        const list = data.top_list || [];
        const top1Area = document.getElementById('top1-area');
        const listContainer = document.getElementById('list-container');

        // Top 1
        if (list.length > 0) {
            top1Area.style.display = 'block';
            document.getElementById('top1-name').innerText = list[0].ItemName;
            document.getElementById('top1-count').innerText = `${list[0].Count} X`;
            // Â∞ÅÈù¢
            const imgUrl = `/api/proxy/image/${list[0].ItemId}/backdrop`;
            document.getElementById('top1-img').style.backgroundImage = `url('${imgUrl}')`;
        } else {
            top1Area.style.display = 'none';
        }

        // List
        if (list.length <= 1) {
            listContainer.innerHTML = '<div style="text-align: center; padding: 20px; font-size: 12px; opacity: 0.5;">[ NO MORE DATA ]</div>';
        } else {
            let html = '';
            for (let i = 1; i < list.length; i++) {
                html += `
                <div class="list-item">
                    <span style="font-weight:bold; margin-right:5px;">${i+1}.</span>
                    <span class="item-name">${list[i].ItemName}</span>
                    <span style="font-family:monospace;">${list[i].Count}</span>
                </div>`;
            }
            listContainer.innerHTML = html;
        }
        
        // Â¶ÇÊûúÂÆåÂÖ®Ê≤°Êï∞ÊçÆ
        if (data.plays === 0) {
            listContainer.innerHTML = '<div style="text-align: center; padding: 30px; font-weight: bold;">[ NO PLAYBACK HISTORY ]</div>';
        }
    }

    async function downloadImage() {
        const node = document.getElementById('capture-target');
        try {
            // Êà™ÂõæÂâçÁßªÈô§Áº©ÊîæÔºå‰øùËØÅÊ∏ÖÊô∞Â∫¶
            const wrapper = document.getElementById('scale-wrapper');
            const oldTransform = wrapper.style.transform;
            wrapper.style.transform = 'none';
            
            await new Promise(r => setTimeout(r, 50));

            const canvas = await html2canvas(node, {
                scale: 2, 
                backgroundColor: null 
            });
            
            const link = document.createElement('a');
            link.download = `Emby_Receipt_${currentUserId}.png`;
            link.href = canvas.toDataURL();
            link.click();
            
            // ÊÅ¢Â§çÁº©Êîæ
            wrapper.style.transform = oldTransform;
        } catch(e) {
            alert("Error: " + e);
        }
    }

    init();
</script>
{% endblock %}