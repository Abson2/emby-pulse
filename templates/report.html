{% extends "layout.html" %}
{% block title %}Êò†ËøπÂ∑•Âùä - Â∞èÁ•®Áâà{% endblock %}
{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
    /* ÂÖ®Â±ÄÈáçÁΩÆ */
    html, body { height: 100%; margin: 0; background: #f0f2f5; font-family: 'Space Mono', monospace, sans-serif; }
    
    .app-layout { display: flex; flex-direction: column; height: 100%; }
    
    /* È¢ÑËßàÂå∫ */
    .preview-area {
        flex: 1;
        overflow-y: auto;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 40px 20px;
        background-color: #e5e7eb;
        background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
        background-size: 20px 20px;
    }

    /* ÊéßÂà∂Âè∞ (Â∫ïÈÉ®Âõ∫ÂÆö) */
    .control-panel {
        background: white;
        padding: 20px;
        border-top: 1px solid #ddd;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        z-index: 100;
        flex-shrink: 0;
    }

    /* ================= üßæ Â∞èÁ•®Êµ∑Êä•Êú¨‰Ωì ================= */
    .receipt-container {
        width: 380px;
        background: #fff;
        position: relative;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        display: flex;
        flex-direction: column;
        filter: drop-shadow(0 0 10px rgba(0,0,0,0.1));
    }

    /* ÈîØÈΩøÊïàÊûú (Á∫ØCSSÂÆûÁé∞) */
    .receipt-container::before, .receipt-container::after {
        content: ""; position: absolute; left: 0; width: 100%; height: 10px;
        background-size: 20px 20px;
        background-repeat: repeat-x;
    }
    .receipt-container::before {
        top: -10px;
        background-image: linear-gradient(135deg, transparent 50%, #fff 50%), linear-gradient(45deg, #fff 50%, transparent 50%);
    }
    .receipt-container::after {
        bottom: -10px;
        background-image: linear-gradient(135deg, #fff 50%, transparent 50%), linear-gradient(45deg, transparent 50%, #fff 50%);
    }

    .receipt-content { padding: 30px 25px; color: #1a1a1a; }

    /* Â§¥ÈÉ® */
    .r-header { text-align: center; border-bottom: 2px dashed #1a1a1a; padding-bottom: 20px; margin-bottom: 20px; }
    .r-title { font-size: 24px; font-weight: 900; letter-spacing: -1px; text-transform: uppercase; margin: 0; }
    .r-subtitle { font-size: 12px; margin-top: 5px; opacity: 0.6; }
    .r-meta { display: flex; justify-content: space-between; font-size: 10px; margin-top: 15px; font-weight: bold; opacity: 0.5; }

    /* Êï∞ÊçÆË°å */
    .r-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; }
    .r-label { font-size: 12px; font-weight: bold; }
    .r-val { font-size: 14px; font-weight: bold; }
    .r-val.big { font-size: 24px; }
    
    .divider { border-bottom: 2px dashed #1a1a1a; margin: 20px 0; opacity: 0.2; }

    /* Top Ê¶úÂçï */
    .top-section { margin-top: 10px; }
    .top-header { font-size: 12px; font-weight: 900; text-transform: uppercase; margin-bottom: 15px; display: flex; justify-content: space-between; }
    
    /* Top 1 ÂõæÁâá */
    .top1-card { 
        width: 100%; aspect-ratio: 16/9; background: #eee; margin-bottom: 15px; 
        background-size: cover; background-position: center; border: 2px solid #1a1a1a; 
        position: relative; display: flex; align-items: flex-end;
    }
    .top1-badge { 
        background: #1a1a1a; color: white; padding: 4px 8px; 
        font-size: 10px; font-weight: bold; position: absolute; top: 0; left: 0; 
    }
    .top1-info {
        background: rgba(255,255,255,0.9); width: 100%; padding: 8px; 
        border-top: 2px solid #1a1a1a;
    }

    /* ÂàóË°® */
    .list-item { display: flex; justify-content: space-between; font-size: 11px; padding: 6px 0; border-bottom: 1px dotted #ccc; }
    .list-item:last-child { border-bottom: none; }
    .item-name { max-width: 70%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; }

    /* Â∫ïÈÉ®Êù°ÂΩ¢Á†Å */
    .barcode-area { text-align: center; margin-top: 20px; opacity: 0.8; }
    .barcode { height: 40px; background: repeating-linear-gradient(to right, #000 0px, #000 2px, #fff 2px, #fff 4px); width: 80%; margin: 0 auto; }
    .r-footer-text { font-size: 9px; margin-top: 8px; text-transform: uppercase; letter-spacing: 2px; }

    /* ================= ÊéßÂà∂Âè∞Ê†∑Âºè ================= */
    .ctrl-row { display: flex; gap: 10px; margin-bottom: 10px; overflow-x: auto; }
    .btn { 
        padding: 10px 15px; border: 2px solid #1a1a1a; background: #fff; 
        font-family: inherit; font-weight: bold; font-size: 12px; cursor: pointer; flex: 1; white-space: nowrap;
    }
    .btn.active { background: #1a1a1a; color: #fff; }
    .btn-action { background: #16a34a; border-color: #16a34a; color: white; }

    /* ÈÄÇÈÖç PC */
    @media (min-width: 768px) {
        .app-layout { flex-direction: row; }
        .control-panel { width: 350px; height: 100%; border-top: none; border-right: 1px solid #ddd; }
        .preview-area { align-items: center; }
    }
</style>
{% endblock %}

{% block content %}
<div class="app-layout">
    
    <div class="preview-area">
        <div id="capture-target" class="receipt-container">
            <div class="receipt-content">
                
                <div class="r-header">
                    <h1 class="r-title">EMBY PULSE</h1>
                    <div class="r-subtitle">Personal Viewing Receipt</div>
                    <div class="r-meta">
                        <span id="p-date">2026-02-04</span>
                        <span id="p-time">12:00 PM</span>
                        <span>NO.0001</span>
                    </div>
                </div>

                <div class="r-row">
                    <span class="r-label">USER (ËßÇ‰ºó)</span>
                    <span class="r-val" id="p-user">LOADING...</span>
                </div>
                <div class="r-row">
                    <span class="r-label">PERIOD (Âë®Êúü)</span>
                    <span class="r-val" id="p-period">ALL TIME</span>
                </div>

                <div class="divider"></div>

                <div class="r-row">
                    <span class="r-label">TOTAL HOURS</span>
                    <span class="r-val big" id="p-hours">0</span>
                </div>
                <div class="r-row">
                    <span class="r-label">TOTAL PLAYS</span>
                    <span class="r-val big" id="p-plays">0</span>
                </div>
                <div class="r-row" style="opacity: 0.5;">
                    <span class="r-label">SERVER TOTAL</span>
                    <span class="r-val" id="p-server">0</span>
                </div>

                <div class="divider"></div>

                <div class="top-section">
                    <div class="top-header">
                        <span>TOP CONSUMPTION</span>
                        <span>QTY</span>
                    </div>

                    <div id="top1-area" style="display: none;">
                        <div class="top1-card" id="top1-bg">
                            <div class="top1-badge">#1 FAVORITE</div>
                            <div class="top1-info">
                                <div style="font-weight:bold; font-size:14px;" id="top1-title">-</div>
                            </div>
                        </div>
                    </div>

                    <div id="list-container">
                        <div style="text-align: center; padding: 20px; color: #999; font-size: 12px;">
                            [NO DATA RECORDED]
                        </div>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="r-row">
                    <span class="r-label">TOTAL AMOUNT</span>
                    <span class="r-val">PRICELESS</span>
                </div>
                
                <div class="barcode-area">
                    <div class="barcode"></div>
                    <div class="r-footer-text">THANK YOU FOR WATCHING</div>
                    <div class="r-footer-text" style="margin-top: 4px; font-size: 8px; opacity: 0.5;">Generated by EmbyPulse</div>
                </div>

            </div>
        </div>
    </div>

    <div class="control-panel">
        <div style="margin-bottom: 5px; font-size: 10px; font-weight: bold; opacity: 0.5;">SELECT USER</div>
        <div id="user-btn-group" class="ctrl-row"></div>

        <div style="margin-bottom: 5px; font-size: 10px; font-weight: bold; opacity: 0.5;">SELECT PERIOD</div>
        <div class="ctrl-row">
            <button class="btn active" onclick="setPeriod('all', this)">ALL</button>
            <button class="btn" onclick="setPeriod('year', this)">YEAR</button>
            <button class="btn" onclick="setPeriod('month', this)">MONTH</button>
            <button class="btn" onclick="setPeriod('week', this)">WEEK</button>
        </div>

        <button class="btn btn-action" onclick="downloadReceipt()" style="width: 100%; margin-top: 10px;">
            SAVE RECEIPT üì•
        </button>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    let currentPeriod = 'all';
    let currentUserId = '';

    // ÂàùÂßãÂåñ
    async function init() {
        const d = new Date();
        document.getElementById('p-date').innerText = d.toISOString().split('T')[0];
        
        // Âä†ËΩΩÁî®Êà∑
        const res = await fetch('/api/users');
        const json = await res.json();
        const container = document.getElementById('user-btn-group');
        
        if(json.data && json.data.length > 0) {
            json.data.forEach((u, index) => {
                const btn = document.createElement('button');
                btn.className = `btn ${index === 0 ? 'active' : ''}`;
                btn.innerText = u.UserName;
                btn.onclick = () => {
                    document.querySelectorAll('#user-btn-group .btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    changeUser(u.UserId, u.UserName);
                };
                container.appendChild(btn);
                if(index === 0) changeUser(u.UserId, u.UserName);
            });
        }
    }

    function changeUser(uid, name) {
        currentUserId = uid;
        document.getElementById('p-user').innerText = name.toUpperCase();
        loadData();
    }

    function setPeriod(p, btn) {
        currentPeriod = p;
        document.querySelectorAll('.ctrl-row .btn').forEach(b => {
            // ÁÆÄÂçïÂ§ÑÁêÜÔºåÂè™ÁßªÈô§Êó∂Èó¥ÁªÑÁöÑactive
            if(['ALL','YEAR','MONTH','WEEK'].includes(b.innerText)) b.classList.remove('active');
        });
        btn.classList.add('active');
        document.getElementById('p-period').innerText = p.toUpperCase();
        loadData();
    }

    async function loadData() {
        if(!currentUserId) return;
        
        const res = await fetch(`/api/stats/poster_data?user_id=${currentUserId}&period=${currentPeriod}`);
        const json = await res.json();
        
        if(json.status === 'success') {
            const data = json.data;
            document.getElementById('p-plays').innerText = data.plays;
            document.getElementById('p-hours').innerText = data.hours;
            document.getElementById('p-server').innerText = data.server_plays;

            const list = data.top_list || [];
            const listContainer = document.getElementById('list-container');
            const top1Area = document.getElementById('top1-area');

            // Top 1 Â§ÑÁêÜ
            if(list.length > 0) {
                top1Area.style.display = 'block';
                document.getElementById('top1-title').innerText = list[0].ItemName;
                // ËÆæÁΩÆÂ∞ÅÈù¢ËÉåÊôØ
                const imgUrl = `/api/proxy/image/${list[0].ItemId}/backdrop`;
                document.getElementById('top1-bg').style.backgroundImage = `url('${imgUrl}')`;
            } else {
                top1Area.style.display = 'none';
            }

            // ÂàóË°®Â§ÑÁêÜ
            if(list.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #999; font-size: 12px;">[NO CONTENT FOUND]</div>';
            } else {
                let html = '';
                // ÊòæÁ§∫ Top 2 Âà∞ Top 10
                for(let i=1; i<list.length; i++) {
                    html += `
                    <div class="list-item">
                        <span class="item-name">${i+1}. ${list[i].ItemName}</span>
                        <span>${list[i].Count} x</span>
                    </div>`;
                }
                // Â¶ÇÊûúÂè™Êúâ‰∏Ä‰∏™Êï∞ÊçÆÔºåÊòæÁ§∫ÁÇπÂà´ÁöÑ
                if(list.length === 1) {
                    html = '<div style="text-align: center; padding: 10px; font-size: 10px; opacity: 0.5;">ONLY ONE FAVORITE</div>';
                }
                listContainer.innerHTML = html;
            }
        }
    }

    async function downloadReceipt() {
        const node = document.getElementById('capture-target');
        try {
            const canvas = await html2canvas(node, {
                scale: 2, 
                backgroundColor: null 
            });
            const link = document.createElement('a');
            link.download = `Emby_Receipt_${currentUserId}.png`;
            link.href = canvas.toDataURL();
            link.click();
        } catch(e) {
            alert("Error saving image");
        }
    }

    init();
</script>
{% endblock %}