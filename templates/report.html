{% extends "layout.html" %}
{% block title %}映迹工坊 - EmbyPulse{% endblock %}
{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
    /* ================= 1. 基础布局 (手机优先) ================= */
    html, body { 
        height: 100%; 
        margin: 0; 
        overflow: hidden; 
        background-color: #f3f4f6;
    }
    
    .app-container {
        display: flex;
        flex-direction: column; /* 默认手机竖屏布局 */
        height: 100%;
    }

    /* 预览区域 (上部/右部) */
    .preview-section {
        flex: 1;
        overflow-y: auto; /* 允许海报区域滚动 */
        overflow-x: hidden;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 20px;
        background-color: #e5e7eb;
        -webkit-overflow-scrolling: touch;
    }

    /* 控制面板 (下部/左部) */
    .control-section {
        background: white;
        padding: 20px;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        z-index: 50;
        height: auto;
        max-height: 40vh; /* 手机上最多占 40% 高度 */
        overflow-y: auto;
    }

    /* 桌面端适配 (大屏变左右布局) */
    @media (min-width: 768px) {
        .app-container { flex-direction: row; } /* 左控制，右预览 */
        .control-section { 
            width: 360px; 
            max-height: 100%; 
            height: 100%; 
            border-right: 1px solid #ddd;
            box-shadow: none;
        }
        .preview-section { align-items: center; } /* 桌面端垂直居中 */
    }

    /* ================= 2. 海报本体 (固定比例 9:16) ================= */
    /* 这里的尺寸是固定的，截图绝对稳 */
    .poster-canvas {
        width: 375px;
        height: 667px;
        background-color: #111827;
        position: relative;
        overflow: hidden;
        flex-shrink: 0; /* 禁止被挤压 */
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        color: white;
    }

    /* 动态背景 */
    #poster-bg { position: absolute; inset: 0; z-index: 0; transition: background 0.3s; }
    .texture { position: absolute; inset: 0; z-index: 1; opacity: 0.05; background-image: url('https://www.transparenttextures.com/patterns/stardust.png'); }

    /* 内容层 */
    .content-layer {
        position: relative; z-index: 10;
        height: 100%;
        padding: 30px 24px;
        display: flex;
        flex-direction: column;
    }

    /* ================= 3. 海报组件 ================= */
    /* 头部 */
    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    .avatar { width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; border: 2px solid rgba(255,255,255,0.2); }
    .user-info h2 { font-size: 24px; font-weight: 900; margin: 0; line-height: 1.2; padding-top: 4px; }
    .user-info p { font-size: 10px; opacity: 0.6; margin: 0; text-transform: uppercase; letter-spacing: 1px; }
    
    /* 顶部胶囊 (全服数据) */
    .server-pill { 
        background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 20px; 
        font-size: 10px; display: flex; align-items: center; border: 1px solid rgba(255,255,255,0.1); 
    }
    .server-val { color: #4ade80; font-weight: bold; margin-left: 4px; font-size: 12px; }

    /* 数据卡片 */
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
    .stat-card { background: rgba(255,255,255,0.08); border-radius: 16px; padding: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
    .stat-num { font-size: 32px; font-weight: 900; line-height: 1.1; }
    .stat-label { font-size: 10px; opacity: 0.5; font-weight: bold; margin-top: 4px; }

    /* Top 1 区域 */
    .top1-box { position: relative; width: 100%; aspect-ratio: 16/9; border-radius: 16px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); background: #333; }
    .cover-img { width: 100%; height: 100%; background-size: cover; background-position: center; }
    .top1-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); display: flex; flex-direction: column; justify-content: flex-end; padding: 15px; }
    .top1-label { position: absolute; top: 10px; left: 10px; background: #fbbf24; color: black; font-size: 10px; font-weight: bold; padding: 2px 8px; border-radius: 4px; }
    
    /* 列表区域 */
    .list-box { flex: 1; overflow: hidden; display: flex; flex-direction: column; gap: 8px; }
    .list-item { display: flex; align-items: center; padding: 8px 12px; background: rgba(255,255,255,0.05); border-radius: 8px; }
    .rank-idx { font-size: 12px; font-weight: bold; opacity: 0.4; width: 20px; }
    .item-name { flex: 1; font-size: 12px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 10px; }
    .item-count { font-size: 10px; opacity: 0.6; }

    /* 底部 */
    .footer { margin-top: auto; padding-top: 20px; display: flex; justify-content: space-between; align-items: center; opacity: 0.5; font-size: 10px; }

    /* 空状态 */
    .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.4; }
    
    /* ================= 4. UI组件 ================= */
    .btn-group { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 16px; }
    .btn { background: #f3f4f6; border: none; padding: 8px; border-radius: 8px; font-size: 12px; font-weight: bold; color: #666; cursor: pointer; }
    .btn.active { background: #111827; color: white; }
    
    .color-opts { display: flex; gap: 8px; margin-bottom: 16px; }
    .c-opt { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid #ddd; }
    .c-opt.active { border-color: #16a34a; transform: scale(1.1); }

    .action-btn { width: 100%; padding: 12px; background: #16a34a; color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 14px; margin-top: 10px; }
</style>
{% endblock %}

{% block content %}
<div class="app-container">
    
    <div class="preview-section">
        <div id="scale-wrapper">
            <div id="poster" class="poster-canvas">
                <div id="poster-bg" style="background: linear-gradient(135deg, #1f2937, #000);"></div>
                <div class="texture"></div>
                
                <div class="poster-content content-layer">
                    <div class="header">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="avatar" id="p-avatar">U</div>
                            <div class="user-info">
                                <h2 id="p-user">User</h2>
                                <p id="p-period">2026 年度报告</p>
                            </div>
                        </div>
                        <div class="server-pill">
                            <span>全服</span>
                            <span class="server-val" id="p-server">0</span>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-num" id="p-hours">0</div>
                            <div class="stat-label">专注时长 (H)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-num" id="p-plays">0</div>
                            <div class="stat-label">播放次数</div>
                        </div>
                    </div>

                    <div id="content-area" style="display: block;">
                        <div class="top1-box" id="top1-box">
                            <div class="cover-img" id="top1-img"></div>
                            <div class="top1-overlay">
                                <div class="top1-label">TOP 1</div>
                                <div style="font-size: 18px; font-weight: bold; line-height: 1.2; margin-bottom: 4px;" id="top1-title">-</div>
                                <div style="font-size: 12px; opacity: 0.8;" id="top1-sub">0 次播放</div>
                            </div>
                        </div>

                        <div class="list-box" id="list-container">
                            </div>
                    </div>

                    <div id="empty-area" class="empty-state" style="display: none;">
                        <i class="fa-solid fa-mug-hot" style="font-size: 48px; margin-bottom: 10px;"></i>
                        <p>该时段暂无摸鱼记录</p>
                    </div>

                    <div class="footer">
                        <span id="p-msg">生活不仅有代码，还有电影。</span>
                        <span>EMBY PULSE</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="control-section">
        <div style="margin-bottom: 15px;">
            <label style="font-size: 12px; color: #888; font-weight: bold;">主角</label>
            <select id="user-select" onchange="changeUser(this.value)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 8px; margin-top: 5px;">
                <option value="">加载中...</option>
            </select>
        </div>

        <div class="btn-group">
            <button class="btn" onclick="setPeriod('all')" data-p="all">全量</button>
            <button class="btn" onclick="setPeriod('year')" data-p="year">年度</button>
            <button class="btn active" onclick="setPeriod('month')" data-p="month">本月</button>
            <button class="btn" onclick="setPeriod('week')" data-p="week">本周</button>
        </div>

        <div class="color-opts">
            <div class="c-opt active" style="background: linear-gradient(135deg, #1f2937, #000);" onclick="setBg(this)"></div>
            <div class="c-opt" style="background: linear-gradient(135deg, #4c1d95, #1e1b4b);" onclick="setBg(this)"></div>
            <div class="c-opt" style="background: linear-gradient(135deg, #881337, #4a044e);" onclick="setBg(this)"></div>
            <div class="c-opt" style="background: linear-gradient(135deg, #064e3b, #022c22);" onclick="setBg(this)"></div>
            <div class="c-opt" style="background: linear-gradient(135deg, #c2410c, #7c2d12);" onclick="setBg(this)"></div>
        </div>

        <button class="action-btn" onclick="savePoster()" id="save-btn">
            <i class="fa-solid fa-download"></i> 保存海报
        </button>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    let currentPeriod = 'month';
    let currentUserId = '';

    // 缩放逻辑：始终让海报完整显示在预览区
    function fitPoster() {
        const wrapper = document.querySelector('.preview-section');
        const poster = document.getElementById('poster');
        const scaleWrapper = document.getElementById('scale-wrapper');
        
        const availableW = wrapper.clientWidth - 40;
        const availableH = wrapper.clientHeight - 40;
        
        const scaleW = availableW / 375;
        const scaleH = availableH / 667;
        const scale = Math.min(scaleW, scaleH, 1); // 最多1倍
        
        scaleWrapper.style.transform = `scale(${scale})`;
        scaleWrapper.style.transformOrigin = 'top center';
    }
    window.addEventListener('resize', fitPoster);
    setTimeout(fitPoster, 100);

    async function init() {
        // Load Users
        const res = await fetch('/api/users');
        const json = await res.json();
        const sel = document.getElementById('user-select');
        sel.innerHTML = '';
        if(json.data && json.data.length > 0) {
            json.data.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.UserId;
                opt.innerText = u.UserName;
                sel.appendChild(opt);
            });
            changeUser(json.data[0].UserId);
        }
    }

    function changeUser(uid) {
        currentUserId = uid;
        const sel = document.getElementById('user-select');
        const text = sel.options[sel.selectedIndex].text;
        document.getElementById('p-user').innerText = text;
        document.getElementById('p-avatar').innerText = text[0].toUpperCase();
        loadData();
    }

    function setPeriod(p) {
        currentPeriod = p;
        document.querySelectorAll('.btn').forEach(b => {
            b.classList.toggle('active', b.dataset.p === p);
        });
        const map = {'all':'全量报告', 'year':'年度报告', 'month':'本月报告', 'week':'本周报告'};
        document.getElementById('p-period').innerText = map[p];
        loadData();
    }

    function setBg(el) {
        document.querySelectorAll('.c-opt').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('poster-bg').style.background = el.style.background;
    }

    async function loadData() {
        if(!currentUserId) return;
        
        // 模拟 loading
        document.getElementById('p-plays').style.opacity = 0.5;
        
        const res = await fetch(`/api/stats/poster_data?user_id=${currentUserId}&period=${currentPeriod}`);
        const json = await res.json();
        const data = json.data;

        document.getElementById('p-plays').style.opacity = 1;
        document.getElementById('p-plays').innerText = data.plays;
        document.getElementById('p-hours').innerText = data.hours;
        document.getElementById('p-server').innerText = data.server_plays;

        const hasData = data.plays > 0;
        document.getElementById('content-area').style.display = hasData ? 'block' : 'none';
        document.getElementById('empty-area').style.display = hasData ? 'none' : 'flex';

        if (hasData) {
            const list = data.top_list;
            // Top 1
            if (list[0]) {
                document.getElementById('top1-title').innerText = list[0].ItemName;
                document.getElementById('top1-sub').innerText = `${list[0].P} 次播放`;
                // Set BG
                const img = new Image();
                img.src = `/api/proxy/image/${list[0].ItemId}/backdrop`;
                img.onload = () => { document.getElementById('top1-img').style.backgroundImage = `url('${img.src}')`; };
                img.onerror = () => { document.getElementById('top1-img').style.backgroundImage = `url('https://via.placeholder.com/400x200/333/666')`; };
            }

            // List
            const listContainer = document.getElementById('list-container');
            let html = '';
            // 显示 Top 2 - 6 (最多5个)
            const max = Math.min(list.length, 6);
            for(let i=1; i<max; i++) {
                html += `
                <div class="list-item">
                    <div class="rank-idx">${i+1}</div>
                    <div class="item-name">${list[i].ItemName}</div>
                    <div class="item-count">${list[i].P}次</div>
                </div>`;
            }
            listContainer.innerHTML = html;
        }
    }

    async function savePoster() {
        const btn = document.getElementById('save-btn');
        btn.innerHTML = '生成中...';
        
        const scaleWrapper = document.getElementById('scale-wrapper');
        const oldTransform = scaleWrapper.style.transform;
        scaleWrapper.style.transform = 'none'; // 还原缩放以高清截图
        
        await new Promise(r => setTimeout(r, 100)); // 等待渲染

        try {
            const canvas = await html2canvas(document.getElementById('poster'), {
                scale: 2,
                useCORS: true,
                backgroundColor: '#111827'
            });
            
            const link = document.createElement('a');
            link.download = `EmbyReport.png`;
            link.href = canvas.toDataURL();
            link.click();
        } catch(e) {
            alert('保存失败');
        } finally {
            scaleWrapper.style.transform = oldTransform;
            btn.innerHTML = '<i class="fa-solid fa-download"></i> 保存海报';
        }
    }

    init();
</script>
{% endblock %}