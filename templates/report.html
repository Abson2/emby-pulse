{% extends "layout.html" %}
{% block title %}æ˜ è¿¹å·¥åŠ - EmbyPulse{% endblock %}
{% block head %}
<style>
    /* ================= æ ¸å¿ƒç”»å¸ƒï¼šå›ºå®šæ­»å°ºå¯¸ ================= */
    /* æ”¾å¼ƒè‡ªé€‚åº”ï¼Œä½¿ç”¨ç»å¯¹åƒç´ ï¼Œç¡®ä¿æˆªå›¾ 1:1 */
    .poster-wrapper {
        width: 375px; /* æ ‡å‡†æ‰‹æœºå®½åº¦ */
        height: 667px;
        background-color: #1a1a1a;
        position: relative;
        overflow: hidden;
        flex-shrink: 0;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        display: flex;
        flex-direction: column;
    }

    /* ================= èƒŒæ™¯å±‚ ================= */
    /* 1. çº¯è‰²æ¸å˜åº• (ç”± JS åŠ¨æ€è®¡ç®—é¢œè‰²) */
    .poster-bg-color {
        position: absolute; inset: 0; z-index: 0;
        background: linear-gradient(to bottom, #333, #000);
        transition: background 0.5s ease;
    }
    
    /* 2. çº¹ç†å åŠ  (å¢åŠ è´¨æ„Ÿ) */
    .poster-texture {
        position: absolute; inset: 0; z-index: 1;
        background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
        opacity: 0.1;
    }

    /* 3. å·¨å‹èƒŒæ™¯å›¾ (ä½é€æ˜åº¦å åŠ ï¼Œä»£æ›¿æ¨¡ç³Š) */
    .poster-bg-image {
        position: absolute; inset: 0; z-index: 0;
        background-size: cover; background-position: center;
        opacity: 0.3; /* ä»…ä½œä¸ºæ°›å›´ç‚¹ç¼€ */
        mix-blend-mode: overlay;
    }

    /* ================= å†…å®¹å±‚ ================= */
    .poster-content {
        position: relative; z-index: 10;
        height: 100%;
        display: flex; flex-direction: column;
        padding: 24px;
        color: white;
    }

    /* ================= ç»„ä»¶ï¼šå¡ç‰‡ ================= */
    /* æ”¾å¼ƒç»ç’ƒæ‹Ÿæ€ï¼Œä½¿ç”¨é«˜å¯¹æ¯”åº¦åŠé€æ˜é»‘åº• */
    .info-card {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 12px;
    }

    /* ================= ç»„ä»¶ï¼šå›¾ç‰‡å®¹å™¨ (é˜²æ‹‰ä¼¸) ================= */
    .img-cover {
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-color: #333;
    }

    /* ================= å¸ƒå±€æ§åˆ¶ ================= */
    .flex-row-center { display: flex; align-items: center; }
    .flex-col-center { display: flex; flex-direction: column; align-items: center; justify-content: center; }
    
    /* æ–‡å­—å¤„ç†ï¼šå…è®¸ä¸¤è¡Œï¼Œè¶…å‡ºçœç•¥ */
    .line-clamp-1 { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .line-clamp-2 {
        display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        white-space: normal;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex h-full flex-col md:flex-row overflow-hidden bg-gray-100">
    
    <div class="w-full md:w-80 bg-white border-r border-gray-200 p-6 flex flex-col z-20 shrink-0 overflow-y-auto shadow-xl">
        <h2 class="text-xl font-black text-gray-800 mb-6 flex items-center">
            <i class="fa-solid fa-paintbrush text-green-600 mr-2"></i> æ˜ è¿¹å·¥åŠ
        </h2>
        
        <div class="space-y-6 flex-1">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">ä¸»è§’</label>
                <div id="user-list-container" class="space-y-2 max-h-40 overflow-y-auto pr-1 custom-scrollbar">
                    <p class="text-gray-400 text-xs">åŠ è½½ä¸­...</p>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">æ—¶é—´èŒƒå›´</label>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="setPeriod('all')" class="period-btn bg-gray-900 text-white text-xs py-2 rounded-lg font-bold transition" data-p="all">å…¨é‡</button>
                    <button onclick="setPeriod('year')" class="period-btn bg-gray-100 text-gray-500 text-xs py-2 rounded-lg font-bold hover:bg-gray-200 transition" data-p="year">å¹´åº¦</button>
                    <button onclick="setPeriod('month')" class="period-btn bg-gray-100 text-gray-500 text-xs py-2 rounded-lg font-bold hover:bg-gray-200 transition" data-p="month">æœ¬æœˆ</button>
                    <button onclick="setPeriod('week')" class="period-btn bg-gray-100 text-gray-500 text-xs py-2 rounded-lg font-bold hover:bg-gray-200 transition" data-p="week">æœ¬å‘¨</button>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">å¯„è¯­</label>
                <textarea id="custom-msg" rows="3" class="w-full border-gray-300 rounded-lg text-sm p-3 border focus:ring-green-500 focus:border-green-500 shadow-sm resize-none" oninput="document.getElementById('poster-msg').innerText = this.value">ç”Ÿæ´»ä¸ä»…æœ‰ä»£ç ï¼Œè¿˜æœ‰ç”µå½±ã€‚</textarea>
                <button onclick="randomQuote()" class="text-xs text-blue-600 mt-2 hover:underline">ğŸ² éšæœºä¸€å¥</button>
            </div>
        </div>

        <div class="mt-6 space-y-3">
            <button onclick="processCapture('download')" id="dl-btn" class="w-full py-3 bg-gray-900 hover:bg-black text-white font-bold rounded-xl shadow-lg transition flex justify-center items-center">
                <i class="fa-solid fa-download mr-2"></i> ä¿å­˜æµ·æŠ¥
            </button>
            <button onclick="processCapture('copy')" id="cp-btn" class="w-full py-3 bg-white border border-gray-300 text-gray-700 font-bold rounded-xl shadow-sm hover:bg-gray-50 transition flex justify-center items-center">
                <i class="fa-regular fa-copy mr-2"></i> å¤åˆ¶
            </button>
        </div>
    </div>

    <div class="flex-1 overflow-auto flex justify-center items-start p-8 bg-gray-200" id="preview-wrapper">
        <div id="scale-wrapper" style="transform-origin: top center;">
            
            <div id="capture-target" class="poster-wrapper">
                
                <div id="poster-bg-color" class="poster-bg-color"></div>
                <div id="poster-bg-image" class="poster-bg-image"></div>
                <div class="poster-texture"></div>

                <div class="poster-content">
                    
                    <div class="flex-row-center justify-between mb-8">
                        <div class="flex-row-center gap-4 overflow-hidden">
                            <div class="w-14 h-14 rounded-full border-2 border-white/50 flex items-center justify-center bg-white/10 text-xl font-bold shrink-0" id="poster-avatar">U</div>
                            <div class="min-w-0">
                                <h2 class="text-2xl font-black leading-tight truncate" id="poster-user">Username</h2>
                                <p class="text-xs text-white/70 uppercase tracking-widest mt-1" id="poster-period-text">å…¨é‡è§‚å½±æŠ¥å‘Š</p>
                            </div>
                        </div>
                        <div class="px-3 py-1 rounded-full text-xs font-bold bg-white/20 text-white shrink-0" id="poster-tag">è§‚å½±è¾¾äºº</div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div class="info-card flex-col-center">
                            <div class="text-4xl font-black mb-1" id="poster-hours">0</div>
                            <div class="text-[10px] text-white/60 font-bold uppercase">æ€»æ—¶é•¿ (å°æ—¶)</div>
                        </div>
                        <div class="info-card flex-col-center">
                            <div class="text-4xl font-black mb-1" id="poster-plays">0</div>
                            <div class="text-[10px] text-white/60 font-bold uppercase">æ’­æ”¾æ¬¡æ•°</div>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col justify-center mb-6 min-h-0">
                        <div class="text-xs font-bold text-yellow-400 mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-crown"></i> æœ€çˆ± Top 1
                        </div>
                        <div class="w-full aspect-[16/9] rounded-xl overflow-hidden shadow-2xl border border-white/10 relative bg-black/50">
                            <div id="top1-bg" class="img-cover w-full h-full"></div>
                            
                            <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/90 to-transparent">
                                <h3 class="text-xl font-bold leading-tight line-clamp-2" id="poster-top1-title">æš‚æ— æ•°æ®</h3>
                                <p class="text-xs text-white/70 mt-1"><span id="poster-top1-plays">0</span> æ¬¡æ’­æ”¾</p>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3 mb-8">
                        <div class="info-card flex-row-center gap-3 p-2">
                            <div id="top2-bg" class="w-10 h-14 rounded bg-gray-700 img-cover shrink-0"></div>
                            <div class="min-w-0 flex-1">
                                <div class="flex justify-between items-baseline mb-0.5">
                                    <span class="text-[10px] text-white/50 font-bold uppercase">Top 2</span>
                                </div>
                                <div class="text-sm font-bold truncate" id="poster-top2-title">-</div>
                            </div>
                        </div>
                        <div class="info-card flex-row-center gap-3 p-2">
                            <div id="top3-bg" class="w-10 h-14 rounded bg-gray-700 img-cover shrink-0"></div>
                            <div class="min-w-0 flex-1">
                                <div class="flex justify-between items-baseline mb-0.5">
                                    <span class="text-[10px] text-white/50 font-bold uppercase">Top 3</span>
                                </div>
                                <div class="text-sm font-bold truncate" id="poster-top3-title">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-auto pt-4 border-t border-white/10">
                        <p id="poster-msg" class="text-xs text-white/80 italic font-light line-clamp-2 leading-relaxed opacity-90">ç”Ÿæ´»ä¸ä»…æœ‰ä»£ç ï¼Œè¿˜æœ‰ç”µå½±ã€‚</p>
                        <div class="mt-4 flex justify-between items-center opacity-50">
                            <span class="text-[9px] font-mono tracking-widest">EMBY PULSE</span>
                            <i class="fa-solid fa-heart-pulse"></i>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
    const quotes = ["ç”Ÿæ´»ä¸ä»…æœ‰ä»£ç ï¼Œè¿˜æœ‰ç”µå½±ã€‚", "æœ‰äº›é¸Ÿå„¿æ˜¯å…³ä¸ä½çš„ã€‚", "èƒ½åŠ›è¶Šå¤§ï¼Œè´£ä»»è¶Šå¤§ã€‚", "æ„¿åŸåŠ›ä¸ä½ åŒåœ¨ã€‚", "å¿µå¿µä¸å¿˜ï¼Œå¿…æœ‰å›å“ã€‚", "æˆ‘å‘½ç”±æˆ‘ä¸ç”±å¤©ï¼", "ä¸ºäº†çœ‹çœ‹é˜³å…‰ï¼Œæˆ‘æ¥åˆ°è¿™ä¸–ä¸Šã€‚", "é£èµ·ï¼Œå”¯æœ‰åŠªåŠ›ç”Ÿå­˜ã€‚", "å¦‚æœä¸æ›¾è§è¿‡å¤ªé˜³ï¼Œæˆ‘æœ¬å¯ä»¥å¿å—é»‘æš—ã€‚", "å¥½çš„ç”µå½±ï¼Œæ˜¯ä¸€æ¬¡çµé­‚çš„æ´—ç¤¼ã€‚"];
    let currentPeriod = 'all';
    let currentUserId = '';

    // ç¼©æ”¾é¢„è§ˆ (ä¸å½±å“æˆªå›¾)
    function fitPreview() {
        if (window.innerWidth < 1000) {
            const wrapper = document.getElementById('preview-wrapper');
            const scale = (wrapper.clientWidth - 40) / 375;
            document.getElementById('scale-wrapper').style.transform = `scale(${Math.min(scale, 1)})`;
        } else {
            document.getElementById('scale-wrapper').style.transform = 'scale(1)';
        }
    }
    window.addEventListener('resize', fitPreview);
    setTimeout(fitPreview, 100);

    // ğŸ”¥ æ ¸å¿ƒåŠŸèƒ½ï¼šè®¾ç½® DIV èƒŒæ™¯å›¾ (å¸¦è‡ªåŠ¨å–è‰²æ¨¡æ‹Ÿ)
    function setDivBg(elementId, url, isTop1 = false) {
        const el = document.getElementById(elementId);
        if (!el) return;
        
        const img = new Image();
        img.crossOrigin = "Anonymous"; // å…è®¸è·¨åŸŸ
        
        img.onload = () => {
            el.style.backgroundImage = `url('${url}')`;
            
            // å¦‚æœæ˜¯ Top1 å›¾ç‰‡ï¼Œå°è¯•ç®€å•å–è‰²æ¥è®¾ç½®èƒŒæ™¯
            if (isTop1) {
                // è®¾ç½®å åŠ èƒŒæ™¯å›¾
                document.getElementById('poster-bg-image').style.backgroundImage = `url('${url}')`;
                
                // æ¨¡æ‹Ÿå–è‰²ï¼šç»˜åˆ¶åˆ° 1x1 ç”»å¸ƒ
                try {
                    const canvas = document.createElement('canvas');
                    canvas.width = 1; canvas.height = 1;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, 1, 1);
                    const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data;
                    // è®¾ç½®æ¸å˜èƒŒæ™¯ï¼šä¸Šéƒ¨ä¸ºæå–è‰²ï¼Œä¸‹éƒ¨ä¸ºé»‘è‰²
                    document.getElementById('poster-bg-color').style.background = 
                        `linear-gradient(to bottom, rgba(${r},${g},${b},0.8), #000)`;
                } catch(e) {
                    console.warn("Auto color extraction failed (CORS?), utilizing fallback.");
                    document.getElementById('poster-bg-color').style.background = `linear-gradient(to bottom, #333, #000)`;
                }
            }
        };
        
        img.onerror = () => {
            // å›é€€é€»è¾‘
            if (isTop1 && url.includes('backdrop')) {
                 setDivBg(elementId, url.replace('backdrop', 'primary'), true);
            } else {
                 el.style.backgroundImage = `url('https://via.placeholder.com/400x225/333/666?text=N/A')`;
            }
        };
        img.src = url;
    }

    async function init() { await loadUsers(); }

    async function loadUsers() {
        const container = document.getElementById('user-list-container');
        try {
            const res = await fetch('/api/users');
            const json = await res.json();
            container.innerHTML = '';
            if(json.status === 'success') {
                json.data.forEach((user, index) => {
                    const div = document.createElement('div');
                    div.className = `user-option p-2 border border-gray-200 rounded cursor-pointer hover:bg-gray-50 flex items-center mb-1 ${index===0?'selected bg-green-50 border-green-500':''}`;
                    div.innerHTML = `<span class="text-xs font-bold mr-2 text-green-600">${user.UserName[0].toUpperCase()}</span><span class="text-sm truncate">${user.UserName}</span>`;
                    div.onclick = () => {
                        document.querySelectorAll('.user-option').forEach(el => el.className = el.className.replace('selected bg-green-50 border-green-500', ''));
                        div.className += ' selected bg-green-50 border-green-500';
                        selectUser(user);
                    };
                    container.appendChild(div);
                    if (index === 0) selectUser(user);
                });
            }
        } catch (e) { container.innerHTML = 'Error'; }
    }

    function selectUser(user) {
        document.getElementById('poster-user').innerText = user.UserName;
        document.getElementById('poster-avatar').innerText = user.UserName[0].toUpperCase();
        currentUserId = user.UserId;
        loadPosterData();
    }

    function setPeriod(period) {
        currentPeriod = period;
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.className = btn.dataset.p === period 
                ? "period-btn bg-gray-900 text-white text-xs py-2 rounded-lg font-bold transition"
                : "period-btn bg-gray-100 text-gray-500 text-xs py-2 rounded-lg font-bold hover:bg-gray-200 transition";
        });
        const map = {'all': 'å…¨é‡æŠ¥å‘Š', 'year': 'å¹´åº¦æŠ¥å‘Š', 'month': 'æœ¬æœˆæŠ¥å‘Š', 'week': 'æœ¬å‘¨æŠ¥å‘Š'};
        document.getElementById('poster-period-text').innerText = map[period];
        loadPosterData();
    }

    async function loadPosterData() {
        if(!currentUserId) return;
        try {
            const res = await fetch(`/api/stats/poster_data?user_id=${currentUserId}&period=${currentPeriod}`);
            const json = await res.json();
            if(json.status === 'success') {
                const data = json.data;
                document.getElementById('poster-plays').innerText = data.plays;
                document.getElementById('poster-hours').innerText = data.hours;
                document.getElementById('poster-tag').innerText = data.tags[0] || "è·¯äºº";

                if(data.top3 && data.top3.length > 0) {
                    const top1 = data.top3[0];
                    document.getElementById('poster-top1-title').innerText = top1.ItemName;
                    document.getElementById('poster-top1-plays').innerText = top1.P;
                    // ä¼˜å…ˆ Backdrop
                    setDivBg('top1-bg', `/api/proxy/image/${top1.ItemId}/backdrop`, true);
                } else {
                    document.getElementById('poster-top1-title').innerText = "æš‚æ— æ•°æ®";
                    document.getElementById('poster-top1-plays').innerText = "0";
                    setDivBg('top1-bg', '', true); // Reset bg
                }
                
                updateSmallCard(2, data.top3[1]);
                updateSmallCard(3, data.top3[2]);
            }
        } catch(e) {}
    }

    function updateSmallCard(rank, item) {
        const titleEl = document.getElementById(`poster-top${rank}-title`);
        const bgId = `top${rank}-bg`;
        if(item) {
            titleEl.innerText = item.ItemName;
            setDivBg(bgId, `/api/proxy/image/${item.ItemId}/primary`);
        } else {
            titleEl.innerText = "-";
            setDivBg(bgId, '');
        }
    }

    function randomQuote() {
        const q = quotes[Math.floor(Math.random() * quotes.length)];
        document.getElementById('custom-msg').value = q;
        document.getElementById('poster-msg').innerText = q;
    }

    // æˆªå›¾é€»è¾‘
    async function processCapture(action) {
        const node = document.getElementById('capture-target');
        const scaler = document.getElementById('scale-wrapper');
        const btn = document.getElementById(action === 'download' ? 'dl-btn' : 'cp-btn');
        const oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        
        // 1. æš‚æ—¶ç§»é™¤ç¼©æ”¾ï¼Œé˜²æ­¢åç§»
        const originalTransform = scaler.style.transform;
        scaler.style.transform = 'none';
        
        // 2. å¼ºåˆ¶ç­‰å¾…é‡ç»˜
        await new Promise(r => setTimeout(r, 100));

        try {
            const canvas = await html2canvas(node, {
                scale: 3,
                useCORS: true,
                backgroundColor: '#1a1a1a', // å¼ºåˆ¶åº•è‰²
                allowTaint: false,
                width: 375, height: 667, // æ˜¾å¼æŒ‡å®šå°ºå¯¸
                windowWidth: 375, windowHeight: 667,
                x: 0, y: 0,
                scrollX: 0, scrollY: 0
            });

            if (action === 'download') {
                const link = document.createElement('a');
                link.download = `EmbyReport_${document.getElementById('poster-user').innerText}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } else {
                canvas.toBlob(blob => {
                    navigator.clipboard.write([new ClipboardItem({'image/png': blob})])
                        .then(() => alert("å·²å¤åˆ¶!"))
                        .catch(() => alert("å¤åˆ¶å¤±è´¥"));
                });
            }
        } catch(e) {
            console.error(e);
            alert("ç”Ÿæˆå¤±è´¥");
        } finally {
            scaler.style.transform = originalTransform;
            btn.innerHTML = oldText;
        }
    }
    
    init();
</script>
{% endblock %}