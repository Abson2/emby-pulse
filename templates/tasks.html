{% extends "layout.html" %}
{% block title %}任务中心 - EmbyPulse{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto w-full px-4 py-6 pb-24">
    
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-2xl font-black text-gray-900 dark:text-white flex items-center gap-2">
                <i class="fa-solid fa-bolt text-blue-500"></i> 任务中心
            </h1>
            <p class="text-xs text-gray-500 mt-1">管理 Emby 计划任务与插件作业</p>
        </div>
        <button onclick="loadTasks()" class="bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-200 px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 text-sm font-bold transition shadow-sm">
            <i class="fa-solid fa-rotate-right mr-2"></i> 刷新
        </button>
    </div>

    <div id="task-container" class="space-y-8">
        <div class="text-center py-20">
            <i class="fa-solid fa-circle-notch fa-spin text-gray-400 text-2xl"></i>
        </div>
    </div>

</div>

<script>
    let pollInterval = null;

    async function init() {
        loadTasks();
    }

    async function loadTasks() {
        try {
            const res = await fetch('/api/tasks');
            const json = await res.json();
            
            if(json.status === 'success') {
                renderGroupedTasks(json.data);
                
                // 检查是否有正在运行的任务
                let anyRunning = false;
                json.data.forEach(group => {
                    if(group.tasks.some(t => t.State === 'Running')) anyRunning = true;
                });

                if (anyRunning && !pollInterval) {
                    pollInterval = setInterval(loadTasks, 3000);
                } else if (!anyRunning && pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                }
            }
        } catch(e) { console.error(e); }
    }

    function renderGroupedTasks(groups) {
        const container = document.getElementById('task-container');
        
        if(!groups || groups.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-400 py-10">暂无任务数据</div>';
            return;
        }

        let html = '';
        
        groups.forEach(group => {
            html += `
            <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm overflow-hidden">
                <div class="px-6 py-3 bg-gray-50 dark:bg-gray-700/50 border-b border-gray-100 dark:border-gray-700 flex items-center">
                    <h3 class="font-bold text-gray-700 dark:text-gray-200 text-sm">${group.title}</h3>
                    <span class="ml-2 bg-gray-200 dark:bg-gray-600 text-gray-500 dark:text-gray-300 text-[10px] px-2 py-0.5 rounded-full font-bold">${group.tasks.length}</span>
                </div>
                <div class="divide-y divide-gray-50 dark:divide-gray-700/50">
            `;

            group.tasks.forEach(t => {
                const isRunning = t.State === 'Running';
                const progress = t.CurrentProgressPercentage || 0;
                
                // 状态显示
                let statusHtml = '<span class="bg-gray-100 dark:bg-gray-700 text-gray-400 dark:text-gray-500 px-2.5 py-0.5 rounded-full text-[10px] font-bold">空闲</span>';
                if (isRunning) {
                    statusHtml = `
                    <div class="w-24 md:w-32">
                        <div class="flex justify-between text-[10px] mb-1 text-blue-600 dark:text-blue-400 font-bold">
                            <span>运行中</span>
                            <span>${Math.round(progress)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-1.5">
                            <div class="bg-blue-500 h-1.5 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                        </div>
                    </div>`;
                }

                // 时间格式化
                const lastRun = t.LastExecutionResult ? new Date(t.LastExecutionResult.EndTimeUtc).toLocaleString() : '从未执行';
                let lastStatus = '';
                if (t.LastExecutionResult) {
                    if (t.LastExecutionResult.Status === 'Completed') lastStatus = '<span class="text-green-500 ml-2 text-[10px]">● 成功</span>';
                    else if (t.LastExecutionResult.Status === 'Failed') lastStatus = '<span class="text-red-500 ml-2 text-[10px]">● 失败</span>';
                    else lastStatus = '<span class="text-gray-400 ml-2 text-[10px]">● 取消</span>';
                }

                html += `
                <div class="flex items-center justify-between p-4 hover:bg-gray-50 dark:hover:bg-gray-700/30 transition group">
                    <div class="flex-1 min-w-0 pr-4">
                        <div class="flex items-center">
                            <div class="font-bold text-gray-800 dark:text-gray-200 text-sm truncate mr-2" title="${t.OriginalName}">${t.Name}</div>
                            ${isRunning ? '<i class="fa-solid fa-gear fa-spin text-blue-500 text-xs"></i>' : ''}
                        </div>
                        <div class="text-[10px] text-gray-400 font-mono mt-1 flex items-center">
                            <i class="fa-regular fa-clock mr-1"></i> ${lastRun} ${lastStatus}
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <div class="hidden md:block">${statusHtml}</div>
                        <div>
                            ${isRunning ? 
                                `<button onclick="stopTask('${t.Id}')" class="text-red-500 hover:text-red-600 bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/40 px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center">
                                    <i class="fa-solid fa-stop mr-1"></i> 停止
                                </button>` : 
                                `<button onclick="startTask('${t.Id}')" class="text-blue-600 hover:text-blue-700 bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/40 px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center opacity-0 group-hover:opacity-100 focus:opacity-100">
                                    <i class="fa-solid fa-play mr-1"></i> 运行
                                </button>`
                            }
                        </div>
                    </div>
                </div>`;
            });

            html += `</div></div>`;
        });

        container.innerHTML = html;
    }

    async function startTask(id) {
        try {
            const res = await fetch(`/api/tasks/${id}/start`, {method: 'POST'});
            const json = await res.json();
            if(json.status === 'success') loadTasks();
            else alert(json.message);
        } catch(e) { alert('网络错误'); }
    }

    async function stopTask(id) {
        if(!confirm('确定要强制停止此任务吗？')) return;
        try {
            const res = await fetch(`/api/tasks/${id}/stop`, {method: 'POST'});
            const json = await res.json();
            if(json.status === 'success') loadTasks();
            else alert(json.message);
        } catch(e) { alert('网络错误'); }
    }

    init();
</script>
{% endblock %}