{% extends "layout.html" %}
{% block title %}任务中心 - EmbyPulse{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto w-full px-4 py-6 pb-24">
    
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-2xl font-black text-gray-900 dark:text-white flex items-center gap-2">
                <i class="fa-solid fa-bolt text-blue-500"></i> 任务中心
            </h1>
            <p class="text-xs text-gray-500 mt-1">管理 Emby 计划任务与维护作业</p>
        </div>
        <button onclick="loadTasks()" class="bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-200 px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 text-sm font-bold transition shadow-sm">
            <i class="fa-solid fa-rotate-right mr-2"></i> 刷新
        </button>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                <thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-50 dark:bg-gray-700/50">
                    <tr>
                        <th class="px-6 py-4">任务名称</th>
                        <th class="px-6 py-4">状态</th>
                        <th class="px-6 py-4">上次执行</th>
                        <th class="px-6 py-4">下次执行</th>
                        <th class="px-6 py-4 text-right">操作</th>
                    </tr>
                </thead>
                <tbody id="task-list-body">
                    <tr><td colspan="5" class="text-center py-8"><i class="fa-solid fa-circle-notch fa-spin text-gray-400"></i></td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let pollInterval = null;

    async function init() {
        loadTasks();
    }

    async function loadTasks() {
        try {
            const res = await fetch('/api/tasks');
            const json = await res.json();
            
            if(json.status === 'success') {
                renderTasks(json.data);
                
                // 如果有任务正在运行，开启轮询 (每3秒刷新一次)
                const running = json.data.some(t => t.State === 'Running');
                if (running && !pollInterval) {
                    pollInterval = setInterval(loadTasks, 3000);
                } else if (!running && pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                }
            }
        } catch(e) { console.error(e); }
    }

    function renderTasks(tasks) {
        const tbody = document.getElementById('task-list-body');
        if(tasks.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-400">暂无任务</td></tr>';
            return;
        }

        let html = '';
        tasks.forEach(t => {
            const isRunning = t.State === 'Running';
            const progress = t.CurrentProgressPercentage || 0;
            
            // 状态显示
            let statusHtml = '<span class="bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 px-2.5 py-0.5 rounded-full text-xs font-bold">空闲</span>';
            if (isRunning) {
                statusHtml = `
                <div class="w-32">
                    <div class="flex justify-between text-xs mb-1 text-blue-600 dark:text-blue-400 font-bold">
                        <span>运行中</span>
                        <span>${Math.round(progress)}%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-1.5">
                        <div class="bg-blue-500 h-1.5 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                    </div>
                </div>`;
            }

            // 时间格式化
            const lastRun = t.LastExecutionResult ? new Date(t.LastExecutionResult.EndTimeUtc).toLocaleString() : '从未';
            const lastStatus = t.LastExecutionResult ? (t.LastExecutionResult.Status === 'Completed' ? '<span class="text-green-500 ml-2">● 成功</span>' : '<span class="text-red-500 ml-2">● 失败</span>') : '';
            
            // 触发器说明
            let nextRun = '手动触发';
            if (t.Triggers && t.Triggers.length > 0) {
                nextRun = '计划中'; // 简化显示，完整解析CRON太复杂
            }

            html += `
            <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition">
                <td class="px-6 py-4">
                    <div class="font-bold text-gray-800 dark:text-gray-200 text-sm">${t.Name}</div>
                    <div class="text-xs text-gray-400 mt-0.5">${t.Category || 'System'}</div>
                </td>
                <td class="px-6 py-4 align-middle">${statusHtml}</td>
                <td class="px-6 py-4 text-xs text-gray-500 font-mono">${lastRun}${lastStatus}</td>
                <td class="px-6 py-4 text-xs text-gray-400">${nextRun}</td>
                <td class="px-6 py-4 text-right">
                    ${isRunning ? 
                        `<button onclick="stopTask('${t.Id}')" class="text-red-500 hover:text-red-600 font-bold text-xs border border-red-200 dark:border-red-900/50 hover:bg-red-50 dark:hover:bg-red-900/20 px-3 py-1.5 rounded transition">
                            <i class="fa-solid fa-stop mr-1"></i> 停止
                        </button>` : 
                        `<button onclick="startTask('${t.Id}')" class="text-blue-600 hover:text-blue-700 font-bold text-xs border border-blue-200 dark:border-blue-900/50 hover:bg-blue-50 dark:hover:bg-blue-900/20 px-3 py-1.5 rounded transition">
                            <i class="fa-solid fa-play mr-1"></i> 运行
                        </button>`
                    }
                </td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    async function startTask(id) {
        try {
            const res = await fetch(`/api/tasks/${id}/start`, {method: 'POST'});
            const json = await res.json();
            if(json.status === 'success') {
                loadTasks(); // 立即刷新状态
            } else {
                alert(json.message);
            }
        } catch(e) { alert('网络错误'); }
    }

    async function stopTask(id) {
        if(!confirm('确定要强制停止此任务吗？')) return;
        try {
            const res = await fetch(`/api/tasks/${id}/stop`, {method: 'POST'});
            const json = await res.json();
            if(json.status === 'success') {
                loadTasks();
            } else {
                alert(json.message);
            }
        } catch(e) { alert('网络错误'); }
    }

    init();
</script>
{% endblock %}