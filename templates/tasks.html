{% extends "layout.html" %}
{% block title %}任务中心 - EmbyPulse{% endblock %}

{% block content %}
<div class="max-w-[1600px] mx-auto w-full px-4 py-6 pb-24">
    
    <div class="flex items-center justify-between mb-6 sticky top-0 z-20 bg-gray-50/95 dark:bg-gray-900/95 backdrop-blur py-2">
        <div>
            <h1 class="text-2xl font-black text-gray-900 dark:text-white flex items-center gap-2">
                <i class="fa-solid fa-bolt text-blue-500"></i> 任务中心
            </h1>
            <p class="text-xs text-gray-500 mt-1 hidden md:block">管理 Emby 计划任务与插件作业</p>
        </div>
        <button onclick="loadTasks()" class="bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-200 px-4 py-2 rounded-xl border border-gray-200 dark:border-gray-600 text-sm font-bold transition shadow-sm flex items-center">
            <i class="fa-solid fa-rotate-right mr-2"></i> 刷新
        </button>
    </div>

    <div id="task-container" class="space-y-8">
        <div class="text-center py-32">
            <i class="fa-solid fa-circle-notch fa-spin text-gray-300 text-4xl mb-4"></i>
            <p class="text-gray-400 text-sm">正在同步任务状态...</p>
        </div>
    </div>

</div>

<script>
    let pollInterval = null;

    async function init() {
        loadTasks();
    }

    async function loadTasks() {
        try {
            const res = await fetch('/api/tasks');
            const json = await res.json();
            
            if(json.status === 'success') {
                renderGroupedTasks(json.data);
                
                // 轮询逻辑：如果有任务在跑，每2秒刷一次
                let anyRunning = false;
                json.data.forEach(group => {
                    if(group.tasks.some(t => t.State === 'Running')) anyRunning = true;
                });

                if (anyRunning && !pollInterval) {
                    pollInterval = setInterval(loadTasks, 2000);
                } else if (!anyRunning && pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                }
            }
        } catch(e) { console.error(e); }
    }

    function renderGroupedTasks(groups) {
        const container = document.getElementById('task-container');
        
        if(!groups || groups.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-400 py-10">暂无任务数据</div>';
            return;
        }

        let html = '';
        
        groups.forEach(group => {
            html += `
            <div class="animate-fade-in">
                <div class="flex items-center mb-3 px-1">
                    <h3 class="font-bold text-gray-700 dark:text-gray-200 text-sm md:text-base">${group.title}</h3>
                    <span class="ml-2 bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400 text-[10px] px-2 py-0.5 rounded-full font-bold">${group.tasks.length}</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3 md:gap-4">
            `;

            group.tasks.forEach(t => {
                const isRunning = t.State === 'Running';
                const progress = t.CurrentProgressPercentage || 0;
                
                // 上次执行结果
                let lastRunTime = '从未执行';
                let statusIcon = '<span class="w-2 h-2 rounded-full bg-gray-300 inline-block mr-1"></span>';
                let statusText = '无记录';
                
                if (t.LastExecutionResult) {
                    const end = new Date(t.LastExecutionResult.EndTimeUtc);
                    lastRunTime = end.toLocaleString('zh-CN', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});
                    
                    if (t.LastExecutionResult.Status === 'Completed') {
                        statusIcon = '<span class="w-2 h-2 rounded-full bg-green-500 inline-block mr-1"></span>';
                        statusText = '成功';
                    } else if (t.LastExecutionResult.Status === 'Failed') {
                        statusIcon = '<span class="w-2 h-2 rounded-full bg-red-500 inline-block mr-1"></span>';
                        statusText = '失败';
                    } else {
                        statusIcon = '<span class="w-2 h-2 rounded-full bg-yellow-500 inline-block mr-1"></span>';
                        statusText = '取消';
                    }
                }

                // 运行时的边框效果
                const borderClass = isRunning 
                    ? 'border-blue-400 dark:border-blue-500 ring-1 ring-blue-100 dark:ring-blue-900 shadow-md' 
                    : 'border-gray-100 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-500 hover:shadow-sm';

                html += `
                <div class="relative bg-white dark:bg-gray-800 rounded-xl border ${borderClass} p-4 transition duration-200 group overflow-hidden flex flex-col justify-between min-h-[110px]">
                    
                    ${isRunning ? `<div class="absolute bottom-0 left-0 h-1 bg-blue-500 transition-all duration-500 z-10" style="width: ${progress}%"></div>` : ''}
                    
                    <div class="flex justify-between items-start mb-2">
                        <div class="pr-2 overflow-hidden">
                            <div class="font-bold text-gray-800 dark:text-gray-100 text-sm truncate" title="${t.OriginalName}">${t.Name}</div>
                            <div class="text-[11px] text-gray-400 dark:text-gray-500 mt-0.5 line-clamp-2 leading-relaxed" title="${t.Description || ''}">
                                ${t.Description || '暂无说明'}
                            </div>
                        </div>
                        <div class="shrink-0">
                            ${isRunning ? 
                                `<button onclick="stopTask('${t.Id}')" class="w-8 h-8 flex items-center justify-center rounded-lg bg-red-50 dark:bg-red-900/30 text-red-500 hover:bg-red-100 transition">
                                    <i class="fa-solid fa-stop text-xs"></i>
                                </button>` : 
                                `<button onclick="startTask('${t.Id}')" class="w-8 h-8 flex items-center justify-center rounded-lg bg-blue-50 dark:bg-blue-900/30 text-blue-500 hover:bg-blue-100 dark:hover:bg-blue-900/50 transition">
                                    <i class="fa-solid fa-play text-xs pl-0.5"></i>
                                </button>`
                            }
                        </div>
                    </div>

                    <div class="flex items-center justify-between text-[10px] text-gray-400 dark:text-gray-500 mt-2 pt-2 border-t border-gray-50 dark:border-gray-700/50">
                        <div class="flex items-center">
                            ${isRunning ? 
                                `<span class="text-blue-500 font-bold flex items-center"><i class="fa-solid fa-gear fa-spin mr-1"></i> 运行中 ${Math.round(progress)}%</span>` : 
                                `<div class="flex items-center">${statusIcon} ${statusText}</div>`
                            }
                        </div>
                        <div class="font-mono opacity-80">${lastRunTime}</div>
                    </div>
                </div>`;
            });

            html += `</div></div><div class="h-4"></div>`; // 组间距
        });

        container.innerHTML = html;
    }

    async function startTask(id) {
        try {
            const res = await fetch(`/api/tasks/${id}/start`, {method: 'POST'});
            const json = await res.json();
            if(json.status === 'success') loadTasks();
            else alert(json.message);
        } catch(e) { alert('网络错误'); }
    }

    async function stopTask(id) {
        if(!confirm('确定要强制停止此任务吗？')) return;
        try {
            const res = await fetch(`/api/tasks/${id}/stop`, {method: 'POST'});
            const json = await res.json();
            if(json.status === 'success') loadTasks();
            else alert(json.message);
        } catch(e) { alert('网络错误'); }
    }

    init();
</script>
{% endblock %}